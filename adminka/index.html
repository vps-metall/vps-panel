<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css" type="text/css">
    <title>Админ панель</title>
    <link rel="shortcut icon" href="#">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/imask"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="../functions.js"></script>
    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Мой сайт">
    <link rel="apple-touch-icon" href="../icon.png">
    <link rel="manifest" href="../manifest.json">

</head>
<body> 
    <div class="leftColumn">
        <header><h5>Админ меню</h5></header>
        <div class="main-part">
            <div onclick="selectPanel('workers-panel')" class="item">
                <i class="fa-solid fa-user-secret"></i>
                <p>Работники</p>
            </div>
            <div onclick="selectPanel('machines-panel')" class="item">
                <i class="fa-solid fa-robot"></i>
                <p>Станки</p>
            </div>
            <div onclick="selectPanel('details-panel')" class="item">
                <i class="fa-solid fa-gears"></i>
                <p>Детали</p>
            </div>
            <div onclick="selectPanel('grafik-panel')" class="item">
                <i class="fa-solid fa-calendar"></i>
                <p>График смен</p>
            </div>
            
        </div>
    </div>
    <div></div>
    <div class="centerColumn">
        <header></header>
        <div class="title-div">
            <h2 id="h2TitlePanel"></h2>
            <div>
                <i id="iconStatWorkersTwoWeek" style="color: #777; font-size: 24px; cursor: pointer;" class="fas fa-chart-line" onclick="printStatWorkersTwoWeek()"></i>
                <input id="inputSelectedDateForGrafikPanel" type="date" onchange="printTableGrafik()">
            </div>
        </div>
        <div class="main-part">
            <div id="workers-panel" class="display-none">
                <div class="div-white-bg">
                    <input oninput="searchWorkerInTable()" id="inputSearchFioWorker" placeholder="Введите ФИО человек для поиска..." type="text">
                </div>
                <div class="div-white-bg">
                    <table>
                        <thead>
                            <tr>
                                <th>ФИО</th>
                                <th>Статус</th>
                                <th>Рабочие места</th>
                                <th>Начало рабочей смены</th>
                                <th style="text-align: center;">Изменить</th>
                                <th style="text-align: center;">Удалить</th>
                            </tr>
                        </thead>
                        <tbody id="tb-workers-table" style="max-height: 400px; overflow-y: auto;">
                            <tr><td colspan="5">Нет данных</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="div-white-bg">
                    <h2>Добавление нового работника</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением нового человека</h5>
                        </div>
                        <div class="container-form">
                            <h5>ФИО Человека</h5>
                            <input id="inputNameAddNewWorker" type="text">
                            <h5>Должность человека</h5>
                            <select id="selectRoleAddNewWorker">
                                <option value="">Выберите должность человека</option>
                                <option value="operator">Оператор</option>
                                <option value="naladchik">Наладчик</option>
                            </select>
                            <h5>Фото человека для входа в систему</h5>
                            <input id="inputPhotoAddNewWorker" type="file" accept="image/*">
                            <p id="pErrorAddNewWorker" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля.</p>
                            <button onclick="addNewWorker()">Добавить</button>
                        </div>
                    </div>
                </div>
                <div class="div-white-bg">
                    <h2>Добавление новой должности</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением новой должности</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название должности</h5>
                            <input id="inputNameNewRole" type="text">
                            <h5>Выберите уровни доступа</h5>
                            <div class="container-checkbox-add-role">
                                <input id="cbWorkInMachine" type="checkbox">
                                <p>Работать на станках</p>
                            </div>
                            <div class="container-checkbox-add-role">
                                <input id="cbSetupMachine" type="checkbox">
                                <p>Настраивать станки</p>
                            </div>
                            <div class="container-checkbox-add-role">
                                <input id="cbDetailsMenu" type="checkbox">
                                <p>Добавление деталей и установок</p>
                            </div>
                            <div class="container-checkbox-add-role">
                                <input id="cbCheckCountDetails" type="checkbox">
                                <p>Проверка количества деталей</p>
                            </div>
                            <div class="container-checkbox-add-role">
                                <input id="cbStorageDetails" type="checkbox">
                                <p>Склад деталей</p>
                            </div>
                            <div class="container-checkbox-add-role">
                                <input id="cbCreateGrafikWorkers" type="checkbox">
                                <p>Изменять график работы</p>
                            </div>
                            <p id="pErrorAddNewRole" style="margin-bottom: 12px !important;" class="p-error display-none"></p>
                            <button onclick="addNewRole()">Добавить</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="machines-panel">
                <div id="containerTablesMachines"></div>
                <div class="div-white-bg">
                    <h2>Добавление нового станка</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением нового станка</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название станка</h5>
                            <input id="inputNameNewMachine" type="text">
                            <h5>Тип станка</h5>
                            <select id="selectTypesMachinesForAddMachine">
                                <option value="">Выберите тип станка</option>
                            </select>
                            <p id="pErrorAddNewMachine" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля</p>
                            <button onclick="addNewMachine()">Добавить</button>
                        </div>
                    </div>
                </div>
                <div class="div-white-bg">
                    <h2>Добавить новую группу станков</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением новой группы станков</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название новой группы станков</h5>
                            <input id="inputNameNewTypeMachine" type="text">
                            <p id="pErrorTypeMachineAdd" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля</p>
                            <button onclick="addNewMachineGroup()">Добавить</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="details-panel">
                <div class="div-white-bg">
                    <div class="div-input-container">
                        <input id="inputSearchDetailInTableDetailsPanel" placeholder="Введите название детали или чертежа для поиска..." type="text">
                        <button onclick="clickSearchDetailsInDetailsPanel()">Поиск</button>
                    </div>
                </div>
                <div class="div-white-bg">
                    <h2>Все детали</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Номер чертежа</th>
                                <th>Количество<br/>установок</th>
                                <th style="text-align: center;">Удалить</th>
                            </tr>
                        </thead>
                        <tbody id="tb-details-table" style="max-height: 400px; overflow-y: auto;"> </tbody>
                    </table>
                    <div class="navigation-menu-table">
                        <div style="width: 100%; display: flex; justify-content: center;">
                            <button>Загрузить еще</button>
                        </div>
                        <h5>Загружено 0 из 0</h5>
                    </div>
                </div>
                <div class="div-white-bg">
                    <h2>Добавить новую деталь</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Перед добавлением новой детали убедитесь, что она ещё не была добавлена ранее, чтобы избежать дублирования</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название новой детали</h5>
                            <input id="inputNameNewDetail" type="text">
                            <h5>Название чертежа детали</h5>
                            <input id="inputNameDrawNewDetail" type="text">
                            <p id="pErrorAddNewDetail" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля</p>
                            <button onclick="addNewDetail()">Добавить</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="grafik-panel">
                <div class="div-white-bg">
                    <h2 id="h2DateSelectedForGrafik"></h2>
                    <input oninput="searchWorkerInPanelGrafik()" id="inputSeachWorkerInGrafikPanel" style="margin-bottom: 12px;" type="text" placeholder="Введите ФИО человека для поиска...">
                    <table>
                        <thead>
                            <th>ФИО</th>
                            <th>Статус</th>
                            <th>Рабочие места</th>
                            <th>Начало рабочей смены</th>
                            <th>Изменить</th>
                            <th>Удалить</th>
                        </thead>
                        <tbody id="tbodyTableGrafikWorkers"></tbody>
                    </table>
                </div>
                <div class="div-white-bg">
                    <h2>Редактировать график</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением графика</h5>
                        </div>
                        <div class="container-form">
                            <h5>Выберите дату</h5>
                            <input onchange="selectDateForReductGrafik()" id="inputSelectedDateForReductGrafikWorker" type="date">
                            <h5>Редактировать список людей</h5>
                            <input onclick="reductGrafikDayWorkers()" id="inputReductGrafikDayWorkers" type="text" placeholder="Выберите дату" style="cursor: pointer;" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div onclick="closeAllAllerts()" id="bg-allert" class="display-none"></div>

    <div id="allertMountPanelForDetailInformation" style="width: 1000px; max-width: 95%;" class="display-none allert">
        <h2 id="h2TitleNameMountPanelForDetailInformation"></h2>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <i style="cursor: pointer; font-size: 44px;" id="buttonPreviousMountPanel" class="fa fa-chevron-left"></i>
            <div>
                <div class="container-mount">
                    <div style="display: flex; align-items: center;">
                        <h3 id="h3YearMountPanelForDetailInformation"></h3>
                        <i id="buttonDetailInformationWorkerYearMountPanel" style="color: #777; margin-left: 12px; cursor: pointer;" class="fas fa-chart-line"></i>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <h3 id="h3MountNameUkrMountPanelForDetailInformation"></h3>
                        <i style="color: #777; margin-left: 12px; cursor: pointer;" id="buttonDetailInformationChartMounth" class="fas fa-chart-line"></i>
                    </div>
                    <h3 id="h3MountNameRusMountPanelForDetailInformation"></h3>
                </div>
                <div class="container-days-name">
                    <p>Понедельник</p>
                    <p>Вторник</p>
                    <p>Среда</p>
                    <p>Четверг</p>
                    <p>Пятница</p>
                    <p>Суббота</p>
                    <p>Воскресенье</p>
                </div>
                <div id="containerDatesCalendar" class="container-days-mount"></div>
            </div>
            <i style="cursor: pointer; font-size: 44px;" id="buttonNextMountPanel" class="fa fa-chevron-right"></i>
        </div>
    </div>

    <div id="allertCalculateSalary" class="alert-window display-none" style="width: 400px;">
        <h3 style="text-align: center;">Расчитать ЗП</h3>
        <div class="container">
            <p>ФИО</p>
            <span id="spanWorkerFioForAllertSalary"></span>
        </div>
        <div class="container">
            <p>Количество часов</p>
            <span id="spanCountHoursForAllertSalary"></span>
        </div>
        <div class="container">
            <p>Количество смен</p>
            <span id="spanCountDaysForAllertSalary"></span>
        </div>
        <div class="container">
            <p>Почасовая ставка</p>
            <span id="spanHourlyRateForAllertSalary"></span>
        </div>
        <div class="container">
            <p>Отнять время на обед</p>
            <input onclick="calculateSumSalary()" id="checkboxMinusTimeObed" type="checkbox">
        </div>
        <div class="container">
            <p>Отнять время на переодевачку</p>
            <input onclick="calculateSumSalary()" id="checkboxMinusTimePereodevachka" type="checkbox">
        </div>
        <div class="container">
            <p>Итого часов работы</p>
            <span id="spanCountHoursForCalculateSalary"></span>
        </div>
        <div class="container">
            <p>Итого ЗП</p>
            <span id="spanResSumSalary"> грн</span>
        </div>
        <div class="container">
            <p>Остаток долга</p>
            <span id="spanCreditSum"> грн</span>
        </div>
        <div class="container">
            <p>Списать долг</p>
            <input id="checkboxMinusCredit" type="checkbox" onclick="clickMinusCreditAllertSalary()">
        </div>
        <input id="inputMinusCreditAllertSalary" type="number" placeholder="Списать с долга" style="text-align: center; margin-bottom: 12px;" oninput="changeSumMinusCreditAllertSalary()">
        <input id="inputAddCreditAllertSalary" type="number" placeholder="Выдать в долг" style="text-align: center;" oninput="changeSumAddCreditAllertSalary()">
        <div class="container">
            <p>Сумма итого</p>
            <span id="spanTotalSumAllertSalary"> грн</span>
        </div>
        <input id="inputTotalSumAllertSalary" type="number" placeholder="Сумма выплаты" style="text-align: center; margin-bottom: 12px;">
        <p style="text-align: center; margin-bottom: 12px !important;" class="p-error display-none"></p>
        <button id="buttonPayedSalaryWorker" style="background-color: green; margin-bottom: 8px; box-shadow: 0 .125rem .75rem rgb(7, 116, 7);">Оплачено</button>
        <button onclick="closeAllertCalculatesalary()">Закрыть</button>
    </div>

    <div id="rotateAlert" class="rotate-alert">
        <div class="rotate-content">
            <i class="fas fa-sync-alt"></i>
            <h2>Поверните устройство</h2>
            <p>Для корректной работы приложения используйте горизонтальное положение экрана.</p>
        </div>
    </div>

    <div id="allertConfirmDelete" class="display-none">
        <h5>Подтвердить удаление?</h5>
        <button onclick="clickConfirmAllertDelete()">Подтвердить</button>
    </div>

    <div id="allertStatWorkersTwoWeen" class="alert-window display-none">
        <div style="display: flex; width: 100%; justify-content: space-between;">
            <h2>Табель рабочих смен за две недели</h2>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <i class="fa fa-angle-double-left" onclick="currentStatDate -= 1209600000; printStatWorkersTwoWeek()"></i>
                <i class="fa fa-chevron-left" onclick="currentStatDate -= 604800000; printStatWorkersTwoWeek()"></i>
                <h2 style="margin: 0px 12px;" id="h2DateRangeStatTwoWeekWorkers"></h2>
                <i class="fa fa-chevron-right" onclick="currentStatDate += 604800000; printStatWorkersTwoWeek()"></i>
                <i class="fa fa-angle-double-right" onclick="currentStatDate += 1209600000; printStatWorkersTwoWeek()"></i>
            </div>
        </div>
        <input oninput="searchWorkerInTableTwoWeekStat()" id="inputSearchWorkerInStatTwoWeek" placeholder="Введите ФИО человек для поиска..." type="text" style="margin: 16px 0px;">
        <table>
            <thead id="tHeadTableStatWorkersTwoWeek"></thead>
            <tbody id="tbodyTableStatWorkersTwoWeek" style="max-height: 400px; overflow-y: auto;"></tbody>
        </table>

    </div>
    
    <div id="allertReductDetail" class="allert display-none">
        <h2 id="h2DetailNameForReductDetail"></h2>
        <h5 id="h5NameDrawDetailForReructDetail"></h5>
        <h5 id="h5CountInstallsDetailForReductDetail" style="padding-bottom: 6px; margin-bottom: 12px; border-bottom: 1px solid #e4e9f3;"></h5>
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>Название установки</th>
                    <th>Тип станков</th>
                    <th style="text-align: center;">Удалить</th>
                </tr>
            </thead>
            <tbody id="bodyDetailInstallsForReduct"> </tbody>
        </table>
        <div style="display: flex; margin-top: 12px; justify-content: center;">
            <div class="div-description">
                <p>Тут можно поставить какое-то уведомление связанно с добавлением новой детали</p>
            </div>
            <div class="container-form">
                <h5>Название установки</h5>
                <input id="inputNewInstallNameForDetail" type="text" placeholder="Название новой установки">
                <h5>Выберите группу станков</h5>
                <select id="selectTypesMachinesForReductDetail">
                    <option value="">Выберите тип станков</option>
                </select>
                <p class="p-error display-none" id="pErrorAddNewInstallForDetail" style="margin-bottom: 6px !important;"></p>
                <button>Добавить</button>
            </div>
        </div>
    </div>

    <div id="allertReductInformationWorker" style="max-width: 400px;" class="allert display-none">
        <h2 id="h2TitleFioWorkerForReductInformation"></h2>
            <div style="max-height: 300px; overflow-y: auto;">
                <div>
                    <h5>Текущий долг:</h5>
                    <input id="inputActualyCreditForReductInformationWorker" type="text" readonly>
                    <h5 style="margin-top: 12px; margin-bottom: 8px;">Выдать в долг</h5>
                    <input id="inputAddCreditForReductInformationWorker" style="margin-bottom: 20px;" type="number" placeholder="Введите сумму грн">
                    <h5 style="margin-top: 12px; margin-bottom: 8px;">Списать с долга</h5>
                    <input id="inputMinusCreditForReductInformationWorker" style="margin-bottom: 20px;" type="number" placeholder="Введите сумму грн">
                    <p id="pErrorCreditForReductInformationWorker" style="margin-bottom: 7px !important;" class="p-error display-none">Введите корректное значение</p>
                    <button style="margin-bottom: 12px;" id="buttonChangeCreditForReductInformationWorker">Изменить</button>
                </div>
                <div>
                    <h5>Текущая почасовая ставка:</h5>
                    <input id="inputActualyHorlyRateForReductInformationWorker" type="text" readonly>
                    <h5 style="margin-top: 12px; margin-bottom: 8px;">Введите новую почасовую ставку</h5>
                    <input id="inputNewHorlyRateForReductInformationWorker" style="margin-bottom: 20px;" type="number" placeholder="Введите новую ставку грн/ч">
                    <p style="margin-bottom: 7px !important;" id="pErrorNewHorlyRateForReductInformationWorker" class="p-error display-none">Введите корректное значение</p>
                    <button style="margin-bottom: 12px;" id="buttonChangeHorlyRateForReductInformationWorker">Изменить</button>
                </div>
                <div>
                    <h5>Текущая должность:</h5>
                    <input id="inputActualRoleForReductInformationWorker" type="text" readonly>
                    <h5 style="margin-top: 12px; margin-bottom: 8px;">Выберите новую должность</h5>
                    <select id="selectListRolesForReductInformationWorker" style="width: 100%;">
                        <option value="">Выберите новую должность</option>
                    </select>
                    <p style="margin-bottom: 7px !important;" id="pErrorNewRoleForReductInformationWorker" class="p-error display-none"></p>
                    <button id="buttonChangeRoleForReductInformationWorker">Изменить</button>
                </div>
                <div style="margin-top: 24px;">
                    <h5>Изменить ФИО</h5>
                    <input id="inputNewFioForReductInformationWorker" style="margin-bottom: 20px;" type="text" placeholder="Введите новое ФИО">
                    <p style="margin-bottom: 7px !important;" id="pErrorNewFioForReductIntormationWorker" class="p-error display-none"></p>
                    <button id="buttonChangeFioForReductInformationWorker">Изменить</button>
                </div>
        </div>
        
    </div>

    <div id="allertDetailInformationChart" style="z-index: 150;" class="allert display-none">
        <div style="width: 100%; display: flex; justify-content: space-between;">
            <h2 id="h2TitleNameAllertDetailInformation"></h2>
            <div style="display: flex; flex-direction: column; align-items: end;">
                <h2 id="h2TitleDateAllertDetailInformation"></h2>
                <div class="container-types-diagrams">
                    <div id="containerTypesChart" style="margin-right: 8px;" class="bg-types">
                        <div onclick="changeTypeChartInDetailInformationChart('pie')" id="buttonChangeTypeChartToPie"><i class="fas fa-chart-pie"></i></div>
                        <div onclick="changeTypeChartInDetailInformationChart('line')" id="buttonChangeTypeChartToLine"><i class="fas fa-chart-line"></i></div>
                        <div onclick="changeTypeChartInDetailInformationChart('diagram')" id="buttonChangeTypeChartToDiagram"><i class="fas fa-chart-bar"></i></div>
                    </div>
                        <div id="containerTypesDataInChart" class="bg-types">
                        <div onclick="changeTypeDataInDetailInformationChart('time')" id="buttonChangeTypeChartToTime"><i class="fas fa-clock"></i></div>
                        <div onclick="changeTypeDataInDetailInformationChart('procent')"  id="buttonChangeTypeChartToProcent"><i class="fas fa-percent"></i></div>
                        <div onclick="changeTypeDataInDetailInformationChart('details')"  id="buttonChangeTypeChartToDetails"><i class="fas fa-cogs"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mainPart">
            <div id="containerChartForAllertDetailInformation" class="container-diagram"></div>
            <div class="div-cont-general-info-for-allert-chart">
                <div id="containerGeneralInformationAllertChart" class="container-general-information"></div>
                <div class="div-buttons">
                    <button onclick="clickCloseAllertChart()" style="background-color: brown; cursor: pointer;">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="allertReductWorkDay" class="allert display-none" style="max-width: 400px;">
        <h2 style="text-align: center; margin-bottom: 24px;">Редактировать робочий день</h2>
        <div class="container">
            <p>ФИО:</p>
            <span id="spanWorkerNameForAllertReductWorkDay"></span>
        </div>
        <span>Время начала смены:</span>
        <input id="inputDateStartWorkDayForAllertReductWorkDay" type="datetime-local">
        <span>Время завершения смены:</span>
        <input id="inputDateEndWorkDayForAllertReductWorkDay" type="datetime-local">
        <button onclick="clickConfirmReductWorkDayForWorker()">Изменить</button>
        <button onclick="closeAllertReductWorkDayForWorker()" style="background-color: brown;">Закрыть</button>
    </div>

    <div id="allertAddVacantionOrHospital" class="allert display-none" style="width: 320px;">
        <h5 style="text-align: center;">Назначить отпуск или больничный</h5>
        <div class="container">
            <p>Больничных в 2025:</p>
            <span id="spanCountHospitalForAllertAddVacantionOrHospital"></span>
        </div>
        <div class="container">
            <p>Отпускных в 2025:</p>
            <span id="spanCountVacantionForAllertAddVacantionOrHospital"></span>
        </div>
        <button style="background-color: brown;">Добавить больничный</button>
        <button style="background-color: green;">Добавить отпуск</button>
        <button>Закрыть</button>
    </div>

    <div id="formAuth">
        <div>
            <form id="loginForm">
                <label for="login">Логин</label>
                <input type="text" name="login" id="login" placeholder="Введите логин" required>

                <label for="password">Пароль</label>
                <input type="password" name="password" id="password" placeholder="Введите пароль" required>

                <button type="submit">Войти</button>
            </form>
        </div>
    </div>

    <div id="allertDetailInformationYearForWorker" class="allert display-none" style="width: 300px;">
        <h5 style="text-align: center; margin-bottom: 12px;">Статистика за 2025</h5>
        <div class="container">
            <p>Отпускные:</p>
            <span>14 дней</span>
        </div>
        <div class="container">
            <p>Больничные:</p>
            <span>12 дней</span>
        </div>
        <div class="container">
            <p>Рабочих смен:</p>
            <span>178 смен</span>
        </div>
        <button style="background-color: green;">Смотреть отпуск</button>
        <button style="background-color: brown;">Смотреть больничные</button>
        <button>Закрыть</button>
    </div>
    <div id="allertReductGrafikWorkersDay" class="allert display-none" style="width: 800px;">
        <h2 style="text-align: center; margin-bottom: 12px;">Список работников на 20-02-2025</h2>
        <input oninput="searchWorkerInAllertReductGrafik()" id="inputSearchWorkerAllertReductGrafik" type="text" placeholder="Введите ФИО человека для поиска...">
        <div style="max-height: 400px; overflow-y: auto; width: 100%;  margin-top: 12px;">
            <table style="width: 100%;">
                <thead>
                    <tr>
                        <th style="text-align: center;">Фамилия Имя Отчество</th>
                    </tr>
                </thead>
                <tbody id="tbodyTableWorkersForAllertReductGrafikWorkers"></tbody>
            </table>
        </div>
        <button onclick="clickConfirmReductGragikDay()">Подтвердить</button>
    </div>

    <div id="bgDownloadSpinner" class="display-none"></div>
    <div id="downloadSpinner" class="display-none"></div>
<script>
    
    const apiLink = `https://vps-api.ngrok.dev`;

    let typeOperationForDelete = '';
    let nameForDelete = '';
    let typeFordelete = '';

    let currentStatDate = Date.now();

    let downloadStartTime = null;
    let downloadTimer = null;

    // Переменные для отрисовки графика
    let actualDataForChartTime = [];
    let actualDataForChartProcent = [];
    let actualDataForChartCountDetails = [];
    let actualTypeChart = '';
    let actualTypeDataChart = '';

    const limitForDownloadDetailsInDb = 25;

    protectAuthToday();

    document.getElementById('loginForm').addEventListener('submit', function (event) {
        event.preventDefault(); // Останавливает стандартную отправку
        protectLoginPass();     // Вызывает твой метод
    });

    function protectAuthToday(){
        if(new Date().toISOString().split('T')[0] == localStorage.getItem('loginDate')){
            document.querySelector(`#formAuth`).classList.add('display-none');
            selectPanel('workers-panel');
        }
    }

    function selectPanel(selectedPanel) {
        const listPanels = ['workers-panel', 'machines-panel', 'details-panel', `grafik-panel`];
        listPanels.forEach(panel => {
            document.querySelector(`#${panel}`).classList.add('display-none');
        });

        document.querySelector(`#iconStatWorkersTwoWeek`).classList.add('display-none');
        document.querySelector(`#inputSelectedDateForGrafikPanel`).classList.add('display-none');

        if(selectedPanel == 'workers-panel'){
            document.querySelector(`#iconStatWorkersTwoWeek`).classList.remove('display-none');
            printWorkersPanel();
        } else if(selectedPanel == 'machines-panel'){
            printMachinesPanel();
        } else if(selectedPanel == 'details-panel'){
            printDetailsPanel();
        } else if(selectedPanel == 'grafik-panel'){
            document.querySelector(`#inputSelectedDateForGrafikPanel`).classList.remove('display-none');
            printGrafikPanel();
        }
    }

    function printWorkersPanel(){
        openAllertDownload();
        document.querySelector('#h2TitlePanel').textContent = `Работники`;
        document.querySelector('#workers-panel').classList.remove('display-none');
        printTableWorkersPanel();
        printSelectRoleWorker();


        function printTableWorkersPanel(){
            const bodyTableWorkers = document.querySelector(`#tb-workers-table`);
            listenToFirebase(`workers`, data => {
                if(!data){
                    bodyTableWorkers.innerHTML = `<tr><td colspan='6'>Нет данных</td></tr>`;
                    closeAllertDownload();
                    return;
                }

                const sortedWorkers = Object.entries(data).sort(([, a], [, b]) => {
                    const isAGuard = a.role === 'okhrana';
                    const isBGuard = b.role === 'okhrana';

                    if (isAGuard && !isBGuard) return 1;
                    if (!isAGuard && isBGuard) return -1;

                    return a.fio.localeCompare(b.fio);
                });


                bodyTableWorkers.innerHTML = '';
                const timeNow = Date.now();

                for (const [key, worker] of sortedWorkers) {
                    const statusClass = worker.status === "На работе" ? "green-allocation" : "";
                    const time = formatDate(worker.dateActualyWorkDay);
                    let actualyPlaces = '-';
                    let workerDateActualyWorkDay = '-';

                    if (worker.dateActualyWorkDay && !isNaN(new Date(worker.dateActualyWorkDay).getTime())) {
                        workerDateActualyWorkDay = formatDate(Number(worker.dateActualyWorkDay));
                    }

                    if(worker.status == `На работе`){
                        try{
                            actualyPlaces = '';
                            Object.values(worker.actualyLogs).forEach(log => {
                                actualyPlaces += `${log.machine} -> ${log.detail} -> ${log.install} <br/><br/>`;
                            });
                        } catch (e){
                            actualyPlaces = '-';
                        }
                    }

                    bodyTableWorkers.innerHTML += `
                        <tr style="cursor: pointer;" onclick="openAllertMounthPanelForDetailInformation('worker','${transliterate(worker.fio)}', '${Date.now()}')" class="${statusClass}">
                            <td>${worker.fio}</td>
                            <td>${worker.status}</td>
                            <td>${actualyPlaces}</td>
                            <td>${workerDateActualyWorkDay}</td>
                            <td onclick="reductInfoWorker(event, '${transliterate(worker.fio)}')" style="text-align: center;"><i class="fas fa-edit"></i></td>
                            <td style="text-align: center;"><i onclick="openAllertConfirmDelete('worker','${key}', '-')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>
                        </tr>
                    `;
                    closeAllertDownload();
                };
            });
        }
    
        function printSelectRoleWorker(){
            const selectRole = document.querySelector(`#selectRoleAddNewWorker`);
            
            listenToFirebase(`roles`, roles => {
                selectRole.innerHTML = `<option value="">Выберите должность человека</option>`;
                if(roles){
                    Object.entries(roles).forEach(([key, role]) => {
                        selectRole.innerHTML += `<option value="${key}">${role.name}</option>`;
                    });
                }
            });
        }
    }

    function printMachinesPanel(){
        openAllertDownload();
        document.querySelector('#h2TitlePanel').textContent = `Станки`;
        document.querySelector('#machines-panel').classList.remove('display-none');
        printTableMachinePanel();
        printSelectTypesMachines();

        function printTableMachinePanel(){
            const containerTablesMachines = document.querySelector('#containerTablesMachines');
            listenToFirebase('machines', (data) => {
                if (!data) {
                    closeAllertDownload();
                    return;
                }
                
                containerTablesMachines.innerHTML = ''; // Очищаем контейнер перед добавлением
                
                Object.keys(data).forEach(categoryKey => {
                    const category = data[categoryKey];
                    if (!category.name || !category.machines) return;
                    
                    const tableDiv = document.createElement('div');
                    tableDiv.classList.add('div-white-bg');
                    
                    const title = document.createElement('h2');
                    title.textContent = category.name;
                    tableDiv.appendChild(title);
                    
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Название станка</th>
                                <th>Статус</th>
                                <th>Деталь</th>
                                <th>Установка</th>
                                <th>Время установки</th>
                                <th>Оператор</th>
                                <th>Наладчик</th>
                                <th>УП</th>
                                <th>Время работы</th>
                                <th style="text-align: center;">Инфо</th>
                                <th style="text-align: center;">Удалить</th>
                            </tr>
                        </thead>
                    `;
                    
                    const tbody = document.createElement('tbody');
                    Object.keys(category.machines).sort((a, b) => {
                        const numA = parseInt(a.match(/\d+$/));
                        const numB = parseInt(b.match(/\d+$/));
                        return numA - numB;
                    }).forEach(machineKey => {
                        const machine = category.machines[machineKey];
                        const row = document.createElement('tr');
                        
                        if (machine.status === 'Занят') {
                            row.classList.add('green-allocation');
                        } else if (machine.status === 'Настройка') {
                            row.classList.add('yellow-table');
                        }
                        
                        let timeWorkThisMachine = `-`;
                        if(getTimeDifference(Date.now(), machine.startTime) != `NaN:NaN`){
                            timeWorkThisMachine = getTimeDifference(Date.now(), machine.startTime);
                        }
                        row.innerHTML = `
                            <td>${machine.name}</td>
                            <td>${machine.status}</td>
                            <td>${machine.detail}</td>
                            <td>${machine.install}</td>
                            <td>${machine.timeDetail}(${machine.timeChangeDetail})</td>
                            <td>${formatName(machine.operator)}</td>
                            <td>${formatName(machine.naladchik)}</td>
                            <td>${machine.nameUp}</td>
                            <td>${timeWorkThisMachine}</td>
                            <td style="text-align: center;"><i onclick="clickDetailInformationMachine('${categoryKey}/machines/${machineKey}')" class="fas fa-info-circle"></i></td>
                            <td style="text-align: center;"><i onclick="openAllertConfirmDelete('machine', '${machine.systemName}', '${machine.typeMachine}')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    table.appendChild(tbody);
                    tableDiv.appendChild(table);
                    containerTablesMachines.appendChild(tableDiv);
                });
                closeAllertDownload();
            });
        }

        function printSelectTypesMachines() {
            const selectTypesMachinesForAddMachine = document.querySelector('#selectTypesMachinesForAddMachine');
            
            listenToFirebase('machines', (data) => {
                let res = '<option value="">Выберите тип станка</option>';
                if (!data) {
                    return;
                }
                Object.entries(data).forEach(([key, value]) => {
                    res += `<option value="${key}">${value.name}</option>`;
                });
                selectTypesMachinesForAddMachine.innerHTML = res;
            });
        }
    }

    async function printDetailsPanel(){
        await printDetailsInTableDetailsPanel(limitForDownloadDetailsInDb);
        document.querySelector('#h2TitlePanel').textContent = `Детали`;
        document.querySelector('#details-panel').classList.remove('display-none'); 
    }

    async function printGrafikPanel(){
        document.querySelector('#h2TitlePanel').textContent = `График смен`;
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');

        const formattedToday = `${yyyy}-${mm}-${dd}`;
        document.querySelector(`#inputSelectedDateForGrafikPanel`).value = formattedToday;
        await printTableGrafik();
        document.querySelector(`#grafik-panel`).classList.remove('display-none');
        //document.querySelector('#grafik-panel').classList.remove('display-none'); 
    }

    async function printTableGrafik(){
        openAllertDownload();
        const inputDateGrafik = document.querySelector(`#inputSelectedDateForGrafikPanel`);
        const grafikThisDay = await asyncReadToFirebase(`grafik/workers/${inputDateGrafik.value}`);
        document.querySelector(`#h2DateSelectedForGrafik`).textContent = `График на ${formatedInputDate(`inputSelectedDateForGrafikPanel`)}`;
        const tbodyTable = document.querySelector(`#tbodyTableGrafikWorkers`);
        tbodyTable.innerHTML = '';

        if(grafikThisDay){
            for(const workerSystemName of grafikThisDay.split(',')){
                const worker = await asyncReadToFirebase(`workers/${workerSystemName}`);
                
                const statusClass = worker.status === "На работе" ? "green-allocation" : "";
                const time = formatDate(worker.dateActualyWorkDay);
                let actualyPlaces = '-';
                let workerDateActualyWorkDay = '-';

                if (worker.dateActualyWorkDay && !isNaN(new Date(worker.dateActualyWorkDay).getTime())) {
                    workerDateActualyWorkDay = formatDate(Number(worker.dateActualyWorkDay));
                }

                if(worker.status == `На работе`){
                    try{
                        actualyPlaces = '';
                        Object.values(worker.actualyLogs).forEach(log => {
                            actualyPlaces += `${log.machine} -> ${log.detail} -> ${log.install} <br/><br/>`;
                        });
                    } catch (e){
                        actualyPlaces = '-';
                    }
                }

                tbodyTable.innerHTML += `
                    <tr style="cursor: pointer;" onclick="openAllertMounthPanelForDetailInformation('worker','${transliterate(worker.fio)}', '${Date.now()}')" class="${statusClass}">
                        <td>${worker.fio}</td>
                        <td>${worker.status}</td>
                        <td>${actualyPlaces}</td>
                        <td>${workerDateActualyWorkDay}</td>
                        <td onclick="reductInfoWorker(event, '${transliterate(worker.fio)}')" style="text-align: center;"><i class="fas fa-edit"></i></td>
                        <td style="text-align: center;"><i onclick="openAllertConfirmDelete('worker','${workerSystemName}', '-')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>
                    </tr>
                `;
            }
        } else {
            tbodyTableGrafikWorkers.innerHTML = `<tr><td colspan="6" style="text-align: center;">Графика на ${formatedInputDate(`inputSelectedDateForGrafikPanel`)} нет</td></tr>`
        }


        closeAllertDownload();
    }

    async function selectDateForReductGrafik(){
        openAllertDownload();
        const inputDate = document.querySelector(`#inputSelectedDateForReductGrafikWorker`);
        const strGrafikThisDay = await asyncReadToFirebase(`grafik/workers/${inputDate.value}`);
        const inputReductGrafikDayWorkers = document.querySelector(`#inputReductGrafikDayWorkers`);

        if(strGrafikThisDay){

            inputReductGrafikDayWorkers.value = `${strGrafikThisDay.split(",").length} Человек`;
        } else {
            inputReductGrafikDayWorkers.value = `0 Человек`;
        }

        closeAllertDownload();
    }

    async function reductGrafikDayWorkers() {
        try{
            openAllertDownload();
            const tbody = document.querySelector(`#tbodyTableWorkersForAllertReductGrafikWorkers`);
            tbody.innerHTML = '';
            const inputSelectedDate = document.querySelector(`#inputSelectedDateForReductGrafikWorker`);
            document.querySelector(`#allertReductGrafikWorkersDay h2`).textContent = `График работников на ${formatedInputDate(`inputSelectedDateForReductGrafikWorker`)}`;
            
            const strWorkersGrafikThisDay = await asyncReadToFirebase(`grafik/workers/${inputSelectedDate.value}`);
            let arrayWorkersGrafikThisDay = [];
            if(strWorkersGrafikThisDay){
                arrayWorkersGrafikThisDay = strWorkersGrafikThisDay.split(",");
            }
            const workers = await asyncReadToFirebase(`workers`);

            const sortedWorkers = Object.entries(workers).sort(([, a], [, b]) => {
                const isAGuard = a.role === 'okhrana';
                const isBGuard = b.role === 'okhrana';

                if (isAGuard && !isBGuard) return 1;
                if (!isAGuard && isBGuard) return -1;

                    return a.fio.localeCompare(b.fio);
                });

            for(const [key, worker] of sortedWorkers){
                if(arrayWorkersGrafikThisDay.includes(key)){
                    tbody.innerHTML += `<td onclick="clickWorkerInTableReductGrafikDay(this, 'remove')" class="green-allocation" style="text-align: center;">${worker.fio}</td>`;
                } else {
                    tbody.innerHTML += `<td onclick="clickWorkerInTableReductGrafikDay(this, 'add')" style="text-align: center; cursor: pointer;">${worker.fio}</td>`;
                }
            }


            openAllert(`allertReductGrafikWorkersDay`);
            closeAllertDownload();
        } catch(e){
            closeAllertDownload();
        }
    }

    function clickWorkerInTableReductGrafikDay(tag, type){
        if(type == 'add'){
            tag.className = 'green-allocation';
            tag.onclick = function(){
                clickWorkerInTableReductGrafikDay(tag, 'remove');
            }; 
        } else if(type == 'remove'){
            tag.className = 'red-allocation';
            tag.onclick = function(){
                clickWorkerInTableReductGrafikDay(tag, 'add');
            }; 
        }
    }

    async function clickConfirmReductGragikDay() {
        openAllertDownload();

        const trsArray = document.querySelectorAll(`#tbodyTableWorkersForAllertReductGrafikWorkers tr`);
        let selectedWorkersOnThisDayArray = [];
        for (const tr of trsArray) {
            const td = tr.querySelector('td');
            if (td && td.classList.contains('green-allocation')) {
                selectedWorkersOnThisDayArray.push(transliterate(td.textContent));
            }
        }

        const selectedDate = document.querySelector(`#inputSelectedDateForReductGrafikWorker`).value;

        await asyncOverwriteToFirebase(`grafik/workers/${document.querySelector(`#inputSelectedDateForReductGrafikWorker`).value}`, selectedWorkersOnThisDayArray.join(','));
        document.querySelector(`#inputReductGrafikDayWorkers`).value = `${selectedWorkersOnThisDayArray.length} Человек`;
        closeAllAllerts();
        closeAllertDownload();
    }

    function searchWorkerInAllertReductGrafik(){
        const inputSearchWorkerAllertReductGrafik = document.querySelector(`#inputSearchWorkerAllertReductGrafik`);
        const searchText = inputSearchWorkerAllertReductGrafik.value.toLowerCase();
        const trs = document.querySelectorAll(`#tbodyTableWorkersForAllertReductGrafikWorkers tr`);

        trs.forEach(tr => {
            const fioWorker = tr.querySelector('td').textContent.toLowerCase();

            if(fioWorker.includes(searchText)) {
                tr.style.display = '';
            } else {
                tr.style.display = 'none';
            }
        });
    }

    function searchWorkerInPanelGrafik(){
        const inputSeachWorkerInGrafikPanel = document.querySelector(`#inputSeachWorkerInGrafikPanel`);
        const searchText = inputSeachWorkerInGrafikPanel.value.toLowerCase();
        const trs = document.querySelectorAll(`#tbodyTableGrafikWorkers tr`);

        trs.forEach(tr => {
            const fioWorker = tr.querySelector('td').textContent.toLowerCase();

            if(fioWorker.includes(searchText)) {
                tr.style.display = '';
            } else {
                tr.style.display = 'none';
            }
        });
    }

    function printOrdersPanel(){
        document.querySelector('#h2TitlePanel').textContent = `Заказы`;
        document.querySelector('#orders-panel').classList.remove('display-none');
    }

    async function printDetailsInTableDetailsPanel(limit){
        openAllertDownload();
        const bodyTable = document.querySelector(`#tb-details-table`);
        bodyTable.innerHTML =  '';
        const details = await asyncReadFirstNItems(`details`, limit);
        if(details.length > 0){
            details.forEach(({ key, value: detail }) => {
                bodyTable.innerHTML += `
                    <tr style="cursor: pointer;" onclick="openAllertReductDetail('${detail.systemName}')"> 
                        <td>${detail.name}</td>    
                        <td>${detail.nameDraw}</td>    
                        <td>${detail.countInstalls}</td>
                        <td style="text-align: center;"><i onclick="openAllertConfirmDelete('detail','${detail.systemName}', '', event)" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>  
                    </tr>
                `;
            });
        } else {
            bodyTable.innerHTML = `
                <tr>
                    <td colspan="4">Детали не найдены</td>
                </tr>
            `;
        }

        const countAllDetail = await asyncReadToFirebase(`detailsCount`);
        if(limit > countAllDetail){
            document.querySelector(`#details-panel .navigation-menu-table h5`).textContent = `Загружено ${countAllDetail} из ${countAllDetail}`;
            document.querySelector(`#details-panel .navigation-menu-table button`).onclick = function () { };
        } else {
            document.querySelector(`#details-panel .navigation-menu-table h5`).textContent = `Загружено ${limit} из ${countAllDetail}`;
            document.querySelector(`#details-panel .navigation-menu-table button`).onclick = function () { printDetailsInTableDetailsPanel(limit+limitForDownloadDetailsInDb) };
        }

        closeAllertDownload();
    }

    function openAllertReductDetail(detailSystemName){
        openAllertDownload();
        listenToFirebase(`details/${detailSystemName}`, detail => {
            const bodyDetailInstallsForReduct = document.querySelector(`#bodyDetailInstallsForReduct`);
            bodyDetailInstallsForReduct.innerHTML = '';
            
            if(!detail.installs){
                bodyDetailInstallsForReduct.innerHTML += `
                    <tr>
                        <td colspan=3>Нет установок для данной детали</td>  
                    </tr>
                `;
            } else {
                Object.entries(detail.installs).forEach(([key, install]) => {
                    bodyDetailInstallsForReduct.innerHTML += `
                        <tr>
                            <td>${install.name}</td>    
                            <td>${install.typeMachinesName}</td>   
                            <td style="text-align: center"><i onclick="deleteInstallForDetail(${detail.countInstalls}, '${detailSystemName}', '${detailSystemName}/installs/${key}')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td> 
                        </tr>
                    `;
                });
            }
            
            document.querySelector(`#allertReductDetail`).classList.remove('display-none');
            document.querySelector(`#h2DetailNameForReductDetail`).textContent = `Меню установок для ${detail.name}`;
            document.querySelector(`#h5NameDrawDetailForReructDetail`).textContent = `Чертеж № ${detail.nameDraw}`;
            document.querySelector(`#h5CountInstallsDetailForReductDetail`).textContent = `Кол-во установок: ${detail.countInstalls}`;
            document.querySelector(`#bg-allert`).classList.remove('display-none');

            document.querySelector(`#inputNewInstallNameForDetail`).value = '';
            document.querySelector(`#pErrorAddNewInstallForDetail`).classList.add('display-none');

            readToFirebase(`machines`, machines => {
                const selectorTypeMachine = document.querySelector(`#selectTypesMachinesForReductDetail`);
                selectorTypeMachine.innerHTML = `<option value="">Выберите тип станков</option>`;
                Object.entries(machines).forEach(([key, typeMachines]) => {
                    selectorTypeMachine.innerHTML += `<option value="${key}">${typeMachines.name}</option>`;
                });
            })

            document.querySelector(`#allertReductDetail button`).onclick = function() { addNewInstallForDetail(detailSystemName, detail.countInstalls, `details/${detailSystemName}/installs/${detail.countInstalls}`) };
            closeAllertDownload();
        });
    }
  
    function addNewInstallForDetail(detailSystemName, detailCountInstalls, pathForAddNewInstall){
        const inputNewInstallNameForDetail = document.querySelector(`#inputNewInstallNameForDetail`);
        const selectTypesMachinesForReductDetail = document.querySelector(`#selectTypesMachinesForReductDetail`);
        const pError = document.querySelector(`#pErrorAddNewInstallForDetail`);
        const objNewInstall = {
            name : inputNewInstallNameForDetail.value,
            typeMachinesName : selectTypesMachinesForReductDetail.options[selectTypesMachinesForReductDetail.selectedIndex].textContent,
            typeMachinesSystemName : selectTypesMachinesForReductDetail.value
        };

        if(inputNewInstallNameForDetail.value.length > 2 && selectTypesMachinesForReductDetail.value.length > 0){
            writeToFirebase(pathForAddNewInstall, objNewInstall);
            overwriteToFirebase(`details/${detailSystemName}/countInstalls`, detailCountInstalls+1);
            pError.classList.add('display-none');
            inputNewInstallNameForDetail.value = '';
            selectTypesMachinesForReductDetail.value = '';
        } else {
            pError.classList.remove(`display-none`);
            pError.textContent = `Заполните все поля`;
        }
    }

    function deleteInstallForDetail(countInstallsDetail, detailSystemName, pathInstallForDelete){
        overwriteToFirebase(`details/${pathInstallForDelete}`, {});
        overwriteToFirebase(`details/${detailSystemName}/countInstalls`, countInstallsDetail-1);
    }

    function addNewWorker() {
        const inputNameWorker = document.querySelector('#inputNameAddNewWorker');
        const inputPhotoAddNewWorker = document.querySelector('#inputPhotoAddNewWorker');
        const selectRoleAddNewWorker = document.querySelector('#selectRoleAddNewWorker');
        const pError = document.querySelector(`#pErrorAddNewWorker`);

        if (inputNameWorker.value.length > 4 && selectRoleAddNewWorker.value != '' && inputPhotoAddNewWorker.files[0] && inputNameWorker.value.trim().split(/\s+/).length === 3) {
            
            const path = `workers/${transliterate(inputNameWorker.value)}`;
            const obj = {
                fio: inputNameWorker.value,
                status: 'Нет на работе',
                role: selectRoleAddNewWorker.value,
                dateActualyWorkDay: '',
                actualyLogs: '',
            }

            // Обработка ошибки записи в Firebase
            writeToFirebase(path, obj)
                .then(() => {
                    // Если запись в Firebase прошла успешно, отправляем фото
                    const formData = new FormData();
                    formData.append('name', transliterate(inputNameWorker.value)); 
                    formData.append('image', inputPhotoAddNewWorker.files[0]); 
                    

                    fetch(`${apiLink}/add_image`, {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        inputNameWorker.value = '';
                        selectRoleAddNewWorker.value = '';
                        inputPhotoAddNewWorker.value = '';
                        pError.classList.add(`display-none`);
                        
                    })
                    .catch(error => { // ошибка при отправке фото на api
                     });
                })
                .catch(error => {
                    pError.classList.remove(`display-none`);
                    pError.textContent = 'Человек с таким именем уже зарегистрирован';
            });
            
        } else {
            pError.classList.remove(`display-none`);
            pError.textContent = `Заполните все поля`;
        }
    }

    async function addNewMachineGroup() {
        const inputNameGroup = document.querySelector('#inputNameNewTypeMachine');
        const pError = document.querySelector('#pErrorTypeMachineAdd');

        if (inputNameGroup.value.length > 3) {
            const path = `machines/${transliterate(inputNameGroup.value)}`;
            const obj = {
                name: inputNameGroup.value
            };

            try {
                await writeToFirebase(path, obj);
                inputNameGroup.value = '';
                pError.classList.add('display-none');
            } catch (e) {
                pError.classList.remove('display-none');
                pError.textContent = 'Группа станков с таким именем уже существует';
            }
        } else {
            pError.classList.remove('display-none');
            pError.textContent = 'Введите название для новой группы станков';
        }
    }

    async function addNewMachine(){
        const inputNameNewMachine = document.querySelector('#inputNameNewMachine');
        const selectTypesMachinesForAddMachine = document.querySelector('#selectTypesMachinesForAddMachine');
        const pError = document.querySelector(`#pErrorAddNewMachine`);

        if(inputNameNewMachine.value.length > 3 && selectTypesMachinesForAddMachine.value != ''){
            const path = `machines/${selectTypesMachinesForAddMachine.value}/machines/${transliterate(inputNameNewMachine.value)}`;
            
            const obj = {
                name: inputNameNewMachine.value,
                systemName: transliterate(inputNameNewMachine.value),
                status: 'Выключен',
                detail: '-',
                install: '-',
                operator: '-',
                naladchik: '-',
                startTime: '-',
                timeDetail: '-',
                timeChangeDetail: '-',
                dateNaladki: '-',
                detailSystemName: '-',
                nameUp: '-',
                nameDraw: '-',
                typeMachine: selectTypesMachinesForAddMachine.value
            }

            try{
                await writeToFirebase(path, obj);
                inputNameNewMachine.value = '';
                pError.classList.add('display-none');
            } catch(e){
                pError.classList.remove('display-none');
                pError.textContent = 'Станок с таким названием уже есть';
            }

        } else {
            pError.classList.remove('display-none');
            pError.textContent = 'Заполните все поля';
        }
    }

    async function addNewDetail() {
        const inputNameNewDetail = document.querySelector(`#inputNameNewDetail`);
        const inputNameDrawNewDetail = document.querySelector(`#inputNameDrawNewDetail`);
        const pError = document.querySelector(`#pErrorAddNewDetail`);

        const name = inputNameNewDetail.value.trim();
        const nameDraw = inputNameDrawNewDetail.value.trim();

        // Сброс цвета основного ввода
        inputNameNewDetail.style.borderColor = '';
        inputNameDrawNewDetail.style.borderColor = '';
        pError.classList.add('display-none');

        // Проверка имени детали и чертежа
        if (name.length <= 1 || nameDraw.length === 0) {
            pError.classList.remove('display-none');
            pError.textContent = 'Заполните все поля';
            if (name.length <= 1) inputNameNewDetail.style.borderColor = 'red';
            if (nameDraw.length === 0) inputNameDrawNewDetail.style.borderColor = 'red';
            return;
        }

        // Формируем объект после всех валидаций
        const systemName = `${transliterate(name)}_${transliterate(nameDraw)}`;
        const objNewDetail = {
            name: name,
            nameDraw: nameDraw,
            systemName: systemName,
            countInstalls: 0,
        };

        try{
            openAllertDownload();
            await asyncWriteToFirebase(`details/${systemName}`, objNewDetail);
            const countDetails = await asyncReadToFirebase(`detailsCount`);
            if(countDetails){
                await asyncOverwriteToFirebase(`detailsCount`, countDetails+1);
            } else {
                await asyncOverwriteToFirebase(`detailsCount`, 1);
            }

            inputNameNewDetail.value = '';
            inputNameDrawNewDetail.value = '';
            closeAllertDownload();
            if(selectedPanel == 'storage'){
                printPanelStorage();
            } else if(selectedPanel == 'details'){
                printDetailsPanel();
            }
        } catch (e) {
            pError.classList.remove('display-none');
            pError.textContent = 'Деталь с таким именем и названием чертежа уже есть';
            inputNameDrawNewDetail.style.borderColor = 'red';
            inputNameNewDetail.style.borderColor = 'red';
        }
    }

    function closeAllAllerts(){
        const listAllerts = ['bg-allert', `allertCalculateSalary`,  `allertConfirmDelete`, `allertStatWorkersTwoWeen`, `allertReductDetail`,
        `allertReductInformationWorker`, `allertMountPanelForDetailInformation`, `allertDetailInformationChart`, `allertReductWorkDay`, `allertAddVacantionOrHospital`,
        `allertDetailInformationYearForWorker`, `allertReductGrafikWorkersDay`];

        Object.values(listAllerts).forEach(allert => {
            document.querySelector(`#${allert}`).classList.add('display-none');
        })
    }

    function openAllert(idAllert){
        document.querySelector(`#${idAllert}`).classList.remove('display-none');
        document.querySelector(`#bg-allert`).classList.remove('display-none');
    }

    function searchWorkerInTable(){
        const inputSearchFioWorker = document.querySelector(`#inputSearchFioWorker`);
        const searchText = inputSearchFioWorker.value.toLowerCase();
        const trs = document.querySelectorAll(`#tb-workers-table tr`);

        trs.forEach(tr => {
            const fioWorker = tr.querySelector('td').textContent.toLowerCase();

            if(fioWorker.includes(searchText)) {
                tr.style.display = '';
            } else {
                tr.style.display = 'none';
            }
        });
    }
    
    function searchWorkerInTableTwoWeekStat() {
        const inputSearchFioWorker = document.querySelector('#inputSearchWorkerInStatTwoWeek');
        const searchText = inputSearchFioWorker.value.toLowerCase();
        const trs = document.querySelectorAll('#tbodyTableStatWorkersTwoWeek tr');

        // Сначала скрываем все строки
        trs.forEach(tr => {
            tr.style.display = 'none';
        });

        // Затем ищем совпадения и показываем нужные строки + следующие за ними
        trs.forEach((tr, index) => {
            const fioWorker = tr.querySelector('td')?.textContent.toLowerCase() || '';

            if (fioWorker.includes(searchText)) {
                tr.style.display = '';
                const nextTr = trs[index + 1];
                if (nextTr) {
                    nextTr.style.display = '';
                }
            }
        });
    }

    function openAllertCalculateSalary(countSeconds, countDays, selectedWorkerSystemName, startRange, endRange, horlyRateWorker, selectedWorkerName, dateActualyWorkDay, credit){
        countSecondsTimeForCalculateSalary = countSeconds;
        countDaysForCalculateSalary = countDays;
        creditWorkerForCalculateSalary = credit;
        if(dateActualyWorkDay != 0){
            countDaysForCalculateSalary++;
            const dateNow = Date.now();
            countSecondsTimeForCalculateSalary += (dateNow - dateActualyWorkDay) / 1000;
        }
        if(horlyRateWorker){
            horlyRateWorkerForCalculateSalary = horlyRateWorker;
        } else {
            horlyRateWorkerForCalculateSalary = 0;
        }
        
        closeAllAllerts();
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        document.querySelector(`#allertCalculateSalary`).classList.remove('display-none');
        document.querySelector(`#spanWorkerFioForAllertSalary`).textContent = selectedWorkerName;
        document.querySelector(`#spanHourlyRateForAllertSalary`).textContent = `${horlyRateWorkerForCalculateSalary} грн/ч`;
        document.querySelector(`#spanCountHoursForAllertSalary`).textContent = secondsToTimeFormat(countSecondsTimeForCalculateSalary);
        document.querySelector(`#spanCountDaysForAllertSalary`).textContent = `${countDaysForCalculateSalary} смен`;
        document.querySelector(`#spanCreditSum`).textContent = `${credit} грн`; 
        document.querySelector(`#checkboxMinusCredit`).checked = false;
        document.querySelector(`#inputMinusCreditAllertSalary`).value = '';
        document.querySelector(`#inputAddCreditAllertSalary`).value = '';
        document.querySelector(`#inputTotalSumAllertSalary`).value = '';
        document.querySelector(`#buttonPayedSalaryWorker`).onclick = function () {
            clickPaySalaryWorker(selectedWorkerSystemName, startRange, endRange);
        };

        calculateSumSalary();
    }

    function closeAllertCalculatesalary(){
        document.querySelector(`#allertCalculateSalary`).classList.add('display-none');
        document.querySelector(`#allertStatWorkersTwoWeen`).classList.remove('display-none');
    }

    function calculateSumSalary(){
        const minusTimeObed = document.querySelector(`#checkboxMinusTimeObed`).checked;
        const minusTimePereodevachka = document.querySelector(`#checkboxMinusTimePereodevachka`).checked;
        let countHours = 0;
        countHours = Math.round(countSecondsTimeForCalculateSalary / 3600);
        if(minusTimeObed){
            countHours = countHours - (1800 * countDaysForCalculateSalary) / 3600
        }
        if(minusTimePereodevachka){
            countHours = countHours - (1800 * countDaysForCalculateSalary) / 3600
        }
        document.querySelector(`#spanCountHoursForCalculateSalary`).textContent = countHours;
        const resSalary = horlyRateWorkerForCalculateSalary * countHours;
        document.querySelector(`#spanResSumSalary`).textContent = `${resSalary} грн`;

        // обработка менюшки долга
        const checkboxMinusCredit = document.querySelector(`#checkboxMinusCredit`);
        const inputMinusCreditAllertSalary = document.querySelector(`#inputMinusCreditAllertSalary`);
        const inputAddCreditAllertSalary = document.querySelector(`#inputAddCreditAllertSalary`);
        let credit = 0;
        if(inputMinusCreditAllertSalary.value){
            credit -= inputMinusCreditAllertSalary.value;
        }
        if(inputAddCreditAllertSalary.value){
            credit = inputAddCreditAllertSalary.value;
        }

        document.querySelector(`#spanTotalSumAllertSalary`).textContent = `${Number(resSalary) + Number(credit)} грн`;
        totalSumForAllertSalary = Number(resSalary) + Number(credit);
    }

    function changeSumMinusCreditAllertSalary(){
        const input = document.querySelector(`#inputMinusCreditAllertSalary`);
        const sum = Number(input.value);
        if(sum >= creditWorkerForCalculateSalary){
            input.value = creditWorkerForCalculateSalary;
            document.querySelector(`#checkboxMinusCredit`).checked = true;
        } else {
            document.querySelector(`#checkboxMinusCredit`).checked = false;
        }
        document.querySelector(`#inputAddCreditAllertSalary`).value = '';
        calculateSumSalary();
    }

    function changeSumAddCreditAllertSalary(){
        document.querySelector(`#checkboxMinusCredit`).checked = false;
        document.querySelector(`#inputMinusCreditAllertSalary`).value = '';
        calculateSumSalary();
    }

    function clickMinusCreditAllertSalary(){
        const checkboxMinusCredit = document.querySelector(`#checkboxMinusCredit`);
        const inputMinusCreditAllertSalary = document.querySelector(`#inputMinusCreditAllertSalary`);
        const inputAddCreditAllertSalary = document.querySelector(`#inputAddCreditAllertSalary`);

        if(checkboxMinusCredit.checked){
            inputMinusCreditAllertSalary.value = creditWorkerForCalculateSalary;
            inputAddCreditAllertSalary.value = '';
        } else {
            inputMinusCreditAllertSalary.value = '';
        }

        calculateSumSalary();
    }

    function clickDeleteWorker(worker){
        overwriteToFirebase(`workers/${worker}`, {});
        overwriteToFirebase(`logs/workers/${worker}`, {});
        fetch(`${apiLink}/delete_image`, {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain'
            },
            body: worker.trim()
        })
        .then()
        .catch();
    }

    function clickDeleteMachine(type, name){
        overwriteToFirebase(`machines/${type}/machines/${name}`, {});
        overwriteToFirebase(`logs/machines/${type}/machines/${name}`, {});
    }

    async function clickDeleteDetail(systemName){
        openAllertDownload();

        await asyncOverwriteToFirebase(`details/${systemName}`, {});
        await asyncOverwriteToFirebase(`logs/details/${systemName}`, {});
        const countDetails = await asyncReadToFirebase(`detailsCount`);
        await asyncOverwriteToFirebase(`detailsCount`, countDetails-1);

        closeAllertDownload();
        selectPanel('details-panel');
    }

    function openAllertConfirmDelete(typeOperation, name, type, event){
        event.stopPropagation();
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        document.querySelector(`#allertConfirmDelete`).classList.remove('display-none');

        typeOperationForDelete = typeOperation;
        nameForDelete = name;
        typeFordelete = type;
    }

    function clickConfirmAllertDelete(){
        closeAllAllerts();

        if(typeOperationForDelete == `worker`){
            clickDeleteWorker(nameForDelete);
        } else if(typeOperationForDelete == `machine`){
            clickDeleteMachine(typeFordelete, nameForDelete);
        } else if(typeOperationForDelete == `detail`){
            clickDeleteDetail(nameForDelete);
        }
    }

    async function printStatWorkersTwoWeek(){
        openAllertDownload();
        const startRange = getPastSaturday(currentStatDate);
        const endRange = getNextFriday(currentStatDate);
        const daysInRangeDates = getDaysInRangeForStatsTwoWeek(startRange, endRange);
        
        document.querySelector(`#allertStatWorkersTwoWeen`).classList.add('display-none');
        const tbodyTableStatWorkersTwoWeek = document.querySelector(`#tbodyTableStatWorkersTwoWeek`);
        const tHeadTableStatWorkersTwoWeek = document.querySelector(`#tHeadTableStatWorkersTwoWeek`);
        tHeadTableStatWorkersTwoWeek.innerHTML = `
            <tr>
                <th>ФИО</th>
                <th>Сб</th>
                <th>Вс</th>
                <th>Пн</th>
                <th>Вт</th>
                <th>Ср</th>
                <th>Чт</th>
                <th>Пт</th>
                <th>Всего часов</th>
            </tr>`;
        const thsHead = Array.from(tHeadTableStatWorkersTwoWeek.querySelectorAll("th"));
        await printHeadTable();
        await printBodyTable();
        document.querySelector(`#allertStatWorkersTwoWeen`).classList.remove('display-none');
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        document.querySelector(`#h2DateRangeStatTwoWeekWorkers`).textContent = `${getNumberAndMountForDateNow(startRange)} - ${getNumberAndMountForDateNow(endRange)}`;
        closeAllertDownload();
        

        async function printHeadTable() {
            for (const dayInRange of Object.values(daysInRangeDates)) {
                const targetTh = thsHead.find(th => th.textContent.trim().toLowerCase().slice(0, 2) === dayInRange.dayName.toLowerCase());
                targetTh.innerHTML += `<br/>${getNumberAndMountForDateNow(dayInRange.dayStart)}`;
            }
        }

        async function printBodyTable1() {
            tbodyTableStatWorkersTwoWeek.innerHTML = '';
            const workers = await asyncReadToFirebase(`workers`);
            
            const sortedWorkers = Object.entries(workers).sort(([, a], [, b]) => {
                const isAGuard = a.role === 'okhrana';
                const isBGuard = b.role === 'okhrana';
                if (isAGuard && !isBGuard) return 1;
                if (!isAGuard && isBGuard) return -1;
                return a.fio.localeCompare(b.fio);
            });

            for(const [key, worker] of sortedWorkers){
                const logs = await asyncReadFirebaseByKeyRange(`logs/workers/${key}/workdays`, daysInRangeDates[0].dayStart, daysInRangeDates[13].dayEnd);
                let totalTimeMilliseconds = 0;
                let countWorkDays = 0;
                let noPayedDays = 0;
                let dateActualyWorkDay = 0;

                if(!logs){
                    continue;;
                }

                tbodyTableStatWorkersTwoWeek.innerHTML += `
                    <tr id="tr-first-${key}">
                        <td rowspan="2">${formatName(worker.fio)}<br/><button onclick="openAllertChartDetailInformation('worker', 'period', '${key}', '${daysInRangeDates[0].dayStart}', '${daysInRangeDates[13].dayEnd}')">Статистика</button></td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[0].dayStart)}', '${JSON.stringify(daysInRangeDates[0].dayEnd)}')" id="td-${key}-${daysInRangeDates[0].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[1].dayStart)}', '${JSON.stringify(daysInRangeDates[1].dayEnd)}')" id="td-${key}-${daysInRangeDates[1].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[2].dayStart)}', '${JSON.stringify(daysInRangeDates[2].dayEnd)}')" id="td-${key}-${daysInRangeDates[2].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[3].dayStart)}', '${JSON.stringify(daysInRangeDates[3].dayEnd)}')" id="td-${key}-${daysInRangeDates[3].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[4].dayStart)}', '${JSON.stringify(daysInRangeDates[4].dayEnd)}')" id="td-${key}-${daysInRangeDates[4].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[5].dayStart)}', '${JSON.stringify(daysInRangeDates[5].dayEnd)}')" id="td-${key}-${daysInRangeDates[5].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[6].dayStart)}', '${JSON.stringify(daysInRangeDates[6].dayEnd)}')" id="td-${key}-${daysInRangeDates[6].number}">-<br>-</td>
                        <td id="td-${key}-totalTime" rowspan="2">-</td>
                    </tr>
                    <tr id="tr-two-${key}">
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[7].dayStart)}', '${JSON.stringify(daysInRangeDates[7].dayEnd)}')" id="td-${key}-${daysInRangeDates[7].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[8].dayStart)}', '${JSON.stringify(daysInRangeDates[8].dayEnd)}')" id="td-${key}-${daysInRangeDates[8].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[9].dayStart)}', '${JSON.stringify(daysInRangeDates[9].dayEnd)}')" id="td-${key}-${daysInRangeDates[9].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[10].dayStart)}', '${JSON.stringify(daysInRangeDates[10].dayEnd)}')" id="td-${key}-${daysInRangeDates[10].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[11].dayStart)}', '${JSON.stringify(daysInRangeDates[11].dayEnd)}')" id="td-${key}-${daysInRangeDates[11].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[12].dayStart)}', '${JSON.stringify(daysInRangeDates[12].dayEnd)}')" id="td-${key}-${daysInRangeDates[12].number}">-<br>-</td>
                        <td onclick="clickReductWorkDayForWorker('${key}', '${worker.fio}','${JSON.stringify(daysInRangeDates[13].dayStart)}', '${JSON.stringify(daysInRangeDates[13].dayEnd)}')" id="td-${key}-${daysInRangeDates[13].number}">-<br>-</td>
                    </tr>
                `; 

                for(const log of Object.values(logs)){
                    if (getDayOfMonth(log.startWorkDay) == getDayOfMonth(log.endWorkDay)) {
                        if(document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML != '-<br>-'){
                            document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML += `<br><br>${getHoursAndMinutesInDateNow(log.startWorkDay)}<br>${getHoursAndMinutesInDateNow(log.endWorkDay)}`;
                        } else {
                            document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML = `${getHoursAndMinutesInDateNow(log.startWorkDay)}<br>${getHoursAndMinutesInDateNow(log.endWorkDay)}`;
                        }
                                   
                        if(log?.statusPayed == true){
                            document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).classList.add('green-allocation');
                        } else {
                            noPayedDays++;
                        }         
                    } else {
                        try{
                            if(document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML != '-<br>-'){
                                document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML = `<br><br>${getHoursAndMinutesInDateNow(log.startWorkDay)}<br>->`;
                            } else {
                                document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML = `${getHoursAndMinutesInDateNow(log.startWorkDay)}<br>->`;
                            }
                            if(log?.statusPayed == true){
                                document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).classList.add('green-allocation');
                            } else {
                                noPayedDays++;
                            }

                            if(document.querySelector(`#td-${key}-${getDayOfMonth(log.endWorkDay)}`).innerHTML != '-<br>-'){
                                document.querySelector(`#td-${key}-${getDayOfMonth(log.endWorkDay)}`).innerHTML = `<br><br><- <br>${getHoursAndMinutesInDateNow(log.endWorkDay)}`;
                            } else {
                                document.querySelector(`#td-${key}-${getDayOfMonth(log.endWorkDay)}`).innerHTML = `<- <br>${getHoursAndMinutesInDateNow(log.endWorkDay)}`;
                            }
                            if(log?.statusPayed == true){
                                document.querySelector(`#td-${key}-${getDayOfMonth(log.endWorkDay)}`).classList.add('green-allocation');
                            }
                        } catch(e){}
                    }

                    totalTimeMilliseconds += Number(log.endWorkDay - log.startWorkDay);
                    if(Number(log.endWorkDay - log.startWorkDay) > 14400000){
                        countWorkDays++;
                    }

                }

                try{
                    const today = new Date();
                    const dayOfMonth = today.getDate();
                    const timestampToday = today.getTime();
                    if(document.querySelector(`#td-${key}-${dayOfMonth}`).innerHTML == `-<br>-` && timestampToday > startRange && timestampToday < daysInRangeDates[13].dayEnd){
                        if(worker.dateActualyWorkDay != ''){
                            dateActualyWorkDay = worker.dateActualyWorkDay;
                            document.querySelector(`#td-${key}-${dayOfMonth}`).classList.add(`yellow-allocation`);
                            document.querySelector(`#td-${key}-${dayOfMonth}`).innerHTML = `${getHoursAndMinutesInDateNow(worker.dateActualyWorkDay).trim()}`;
                        }
                    }
                } catch(error){
                    console.log(error);
                }
                                
                document.querySelector(`#td-${key}-totalTime`).innerHTML = `${secondsToTimeFormat(totalTimeMilliseconds / 1000)} </br> ${countWorkDays} смен</br> 
                    <button onClick="openAllertCalculateSalary(${totalTimeMilliseconds / 1000}, ${countWorkDays}, '${key}', 
                    ${startRange}, ${endRange}, ${worker.horlyRate}, '${formatName(`${worker.fio}`)}', ${dateActualyWorkDay}, ${worker?.credit ?? 0})">Зарплата</button></br>
                `;

                if(noPayedDays == 0){
                    document.querySelector(`#tr-first-${key}`).classList.add('green-allocation');
                    document.querySelector(`#tr-two-${key}`).classList.add('green-allocation');
                }

            }
        }

        async function printBodyTable2() {
            // Очистка
            tbodyTableStatWorkersTwoWeek.innerHTML = '';

            // Считываем и сортируем сотрудников
            const workers = await asyncReadToFirebase('workers') || {};
            const sortedWorkers = Object.entries(workers).sort(([, a], [, b]) => {
                const ag = a.role === 'okhrana', bg = b.role === 'okhrana';
                if (ag !== bg) return ag ? 1 : -1;
                return a.fio.localeCompare(b.fio);
            });

            // Пакетно считываем логи
            const logsResults = await Promise.all(sortedWorkers.map(
                ([key]) => asyncReadFirebaseByKeyRange(`logs/workers/${key}/workdays`, daysInRangeDates[0].dayStart, daysInRangeDates[13].dayEnd)
            ));

            // Составляем HTML строк таблицы
            let tbodyHTML = '';
            sortedWorkers.forEach(([key, worker]) => {
                let r1 = `<tr id="tr-first-${key}"><td rowspan="2">${formatName(worker.fio)}<br/>
                <button onclick="openAllertChartDetailInformation('worker','period','${key}','${daysInRangeDates[0].dayStart}','${daysInRangeDates[13].dayEnd}')">Статистика</button></td>`;
                let r2 = `<tr id="tr-two-${key}">`;

                daysInRangeDates.forEach((day, idx) => {
                const onclick = `onclick="clickReductWorkDayForWorker('${key}','${worker.fio}','${day.dayStart}','${day.dayEnd}')"`;
                const cell = `<td ${onclick} id="td-${key}-${day.number}">-<br>-</td>`;
                idx < 7 ? r1 += cell : r2 += cell;
                });

                r1 += `<td id="td-${key}-totalTime" rowspan="2">-</td></tr>`;
                r2 += `</tr>`;
                tbodyHTML += r1 + r2;
            });

            // Вставляем таблицу в DOM
            tbodyTableStatWorkersTwoWeek.innerHTML = tbodyHTML;

            // Обновляем каждую строку данных
            sortedWorkers.forEach(([key, worker], idx) => {
                const logs = logsResults[idx] || {};
                let totalTimeMs = 0, countWorkDays = 0, noPayedDays = 0, dateActual = 0;

                const cellContents = {};
                const cellClasses = {};
                daysInRangeDates.forEach(day => {
                const k = String(day.number);
                cellContents[k] = [];
                cellClasses[k] = [];
                });

                // Обрабатываем логи
                Object.values(logs).forEach(log => {
                const sd = String(getDayOfMonth(log.startWorkDay));
                const ed = String(getDayOfMonth(log.endWorkDay));
                const ts = getHoursAndMinutesInDateNow(log.startWorkDay);
                const te = getHoursAndMinutesInDateNow(log.endWorkDay);
                const paid = log.statusPayed;

                // Инициализация на случай неожиданных ключей
                if (!cellContents[sd]) { cellContents[sd] = []; cellClasses[sd] = []; }
                if (!cellContents[ed]) { cellContents[ed] = []; cellClasses[ed] = []; }

                if (sd === ed) {
                    cellContents[sd].push(`${ts}<br>${te}`);
                    paid ? cellClasses[sd].push('green-allocation') : noPayedDays++;
                } else {
                    cellContents[sd].push(`${ts}<br>->`);
                    cellContents[ed].push(`&lt;-<br>${te}`);
                    if (paid) {
                    cellClasses[sd].push('green-allocation');
                    cellClasses[ed].push('green-allocation');
                    } else {
                    noPayedDays++;
                    }
                }

                const diff = log.endWorkDay - log.startWorkDay;
                totalTimeMs += diff;
                if (diff > 14400000) countWorkDays++;
                });

                // Жёлтая подсветка на сегодня
                try {
                const now = Date.now();
                const today = String(new Date().getDate());
                if (
                    now > daysInRangeDates[0].dayStart &&
                    now < daysInRangeDates[13].dayEnd &&
                    worker.dateActualyWorkDay
                ) {
                    cellContents[today].push(getHoursAndMinutesInDateNow(worker.dateActualyWorkDay).trim());
                    cellClasses[today].push('yellow-allocation');
                    dateActual = worker.dateActualyWorkDay;
                }
                } catch(e) {
                console.error('Error in today highlight', e);
                }

                // Вставляем содержимое ячеек
                requestAnimationFrame(() => {
                daysInRangeDates.forEach(day => {
                    const k = String(day.number);
                    const cell = document.getElementById(`td-${key}-${day.number}`);
                    if (!cell) return;
                    cell.innerHTML = cellContents[k].length ? cellContents[k].join('<br><br>') : '-<br>-';
                    cell.className = '';
                    if (cellClasses[k].length) cell.classList.add(...new Set(cellClasses[k]));
                });

                const totalCell = document.getElementById(`td-${key}-totalTime`);
                if (totalCell) {
                    totalCell.innerHTML = `${secondsToTimeFormat(totalTimeMs / 1000)}<br>${countWorkDays} смен<br>
                    <button onclick="openAllertCalculateSalary(${totalTimeMs / 1000}, ${countWorkDays}, '${key}', ${daysInRangeDates[0].dayStart}, ${daysInRangeDates[13].dayEnd}, ${worker.horlyRate}, '${formatName(worker.fio)}', ${dateActual}, ${worker.credit || 0})">Зарплата</button><br>`;
                }

                if (noPayedDays === 0) {
                    document.getElementById(`tr-first-${key}`)?.classList.add('green-allocation');
                    document.getElementById(`tr-two-${key}`)?.classList.add('green-allocation');
                }
                });
            });
        }
    
        async function printBodyTable() {
            tbodyTableStatWorkersTwoWeek.innerHTML = '';

            const workers = await asyncReadToFirebase('workers') || {};
            const grafikObj = await asyncReadToFirebase('grafik/workers') || {};

            const sortedWorkers = Object.entries(workers).sort(([, a], [, b]) => {
                const ag = a.role === 'okhrana', bg = b.role === 'okhrana';
                if (ag !== bg) return ag ? 1 : -1;
                return a.fio.localeCompare(b.fio);
            });

            const logsResults = await Promise.all(sortedWorkers.map(
                ([key]) => asyncReadFirebaseByKeyRange(
                    `logs/workers/${key}/workdays`,
                    daysInRangeDates[0].dayStart,
                    daysInRangeDates[13].dayEnd
                )
            ));

            let tbodyHTML = '';
            sortedWorkers.forEach(([key, worker]) => {
                let r1 = `<tr id="tr-first-${key}"><td rowspan="2">${formatName(worker.fio)}<br/>
                <button onclick="openAllertChartDetailInformation('worker','period','${key}','${daysInRangeDates[0].dayStart}','${daysInRangeDates[13].dayEnd}')">Статистика</button></td>`;
                let r2 = `<tr id="tr-two-${key}">`;

                daysInRangeDates.forEach((day, idx) => {
                    const onclick = `onclick="clickReductWorkDayForWorker('${key}','${worker.fio}','${day.dayStart}','${day.dayEnd}')"`; 
                    const cell = `<td ${onclick} id="td-${key}-${day.number}">-<br>-</td>`;
                    idx < 7 ? r1 += cell : r2 += cell;
                });

                r1 += `<td id="td-${key}-totalTime" rowspan="2">-</td></tr>`;
                r2 += `</tr>`;
                tbodyHTML += r1 + r2;
            });

            tbodyTableStatWorkersTwoWeek.innerHTML = tbodyHTML;

            sortedWorkers.forEach(([key, worker], idx) => {
                const logs = logsResults[idx] || {};
                let totalTimeMs = 0, countWorkDays = 0, noPayedDays = 0, dateActual = 0;

                const cellContents = {};
                const cellClasses = {};
                daysInRangeDates.forEach(day => {
                    const k = String(day.number);
                    cellContents[k] = [];
                    cellClasses[k] = [];
                });

                Object.values(logs).forEach(log => {
                    const sd = String(getDayOfMonth(log.startWorkDay));
                    const ed = String(getDayOfMonth(log.endWorkDay));
                    const ts = getHoursAndMinutesInDateNow(log.startWorkDay);
                    const te = getHoursAndMinutesInDateNow(log.endWorkDay);
                    const paid = log.statusPayed;

                    if (!cellContents[sd]) { cellContents[sd] = []; cellClasses[sd] = []; }
                    if (!cellContents[ed]) { cellContents[ed] = []; cellClasses[ed] = []; }

                    if (sd === ed) {
                        cellContents[sd].push(`${ts}<br>${te}`);
                        paid ? cellClasses[sd].push('green-allocation') : noPayedDays++;
                    } else {
                        cellContents[sd].push(`${ts}<br>->`);
                        cellContents[ed].push(`&lt;-<br>${te}`);
                        if (paid) {
                            cellClasses[sd].push('green-allocation');
                            cellClasses[ed].push('green-allocation');
                        } else {
                            noPayedDays++;
                        }
                    }

                    const diff = log.endWorkDay - log.startWorkDay;
                    totalTimeMs += diff;
                    if (diff > 14400000) countWorkDays++;
                });

                // Подсветка на сегодня
                try {
                    const now = Date.now();
                    const today = String(new Date().getDate());
                    if (
                        now > daysInRangeDates[0].dayStart &&
                        now < daysInRangeDates[13].dayEnd &&
                        worker.dateActualyWorkDay
                    ) {
                        cellContents[today].push(getHoursAndMinutesInDateNow(worker.dateActualyWorkDay).trim());
                        cellClasses[today].push('yellow-allocation');
                        dateActual = worker.dateActualyWorkDay;
                    }
                } catch (e) {
                    console.error('Error in today highlight', e);
                }

                // Подсветка .red-allocation по графику
                daysInRangeDates.forEach(day => {
                    const k = String(day.number);
                    const dateStr = getFormattedDateForGrafik(day.dayStart); // '2025-06-01'
                    const grafikStr = grafikObj[dateStr] || '';
                    const scheduledWorkers = grafikStr.split(',').map(x => x.trim());

                    const hasLog = Object.values(logs).some(log => {
                        const logDay = getDayOfMonth(log.startWorkDay);
                        return logDay == k;
                    }) || (
                        worker.dateActualyWorkDay &&
                        getDayOfMonth(worker.dateActualyWorkDay) == k
                    );


                    const scheduled = scheduledWorkers.includes(key);

                    if (!hasLog && scheduled) {
                        cellClasses[k].push('red-allocation');
                    }
                });

                // Вставка в DOM
                requestAnimationFrame(() => {
                    daysInRangeDates.forEach(day => {
                        const k = String(day.number);
                        const cell = document.getElementById(`td-${key}-${day.number}`);
                        if (!cell) return;
                        cell.innerHTML = cellContents[k].length ? cellContents[k].join('<br><br>') : '-<br>-';
                        cell.className = '';
                        if (cellClasses[k].length) cell.classList.add(...new Set(cellClasses[k]));
                    });

                    const totalCell = document.getElementById(`td-${key}-totalTime`);
                    if (totalCell) {
                        totalCell.innerHTML = `${secondsToTimeFormat(totalTimeMs / 1000)}<br>${countWorkDays} смен<br>
                        <button onclick="openAllertCalculateSalary(${totalTimeMs / 1000}, ${countWorkDays}, '${key}', ${daysInRangeDates[0].dayStart}, ${daysInRangeDates[13].dayEnd}, ${worker.horlyRate}, '${formatName(worker.fio)}', ${dateActual}, ${worker.credit || 0})">Зарплата</button><br>`;
                    }

                    if (noPayedDays === 0) {
                        document.getElementById(`tr-first-${key}`)?.classList.add('green-allocation');
                        document.getElementById(`tr-two-${key}`)?.classList.add('green-allocation');
                    }
                });
            });
        }
    
    
    
    }

    function openAllertDownload() {
        document.querySelector(`#bgDownloadSpinner`).classList.remove(`display-none`);
        document.querySelector(`#downloadSpinner`).classList.remove(`display-none`);
        
        // Устанавливаем время начала загрузки
        downloadStartTime = Date.now();
        
        // Настроим таймер для проверки, если прошло 20 секунд
        downloadTimer = setTimeout(() => {
            const elapsedTime = Date.now() - downloadStartTime;
            if (elapsedTime >= 20000) {
                // Если прошло 20 секунд или больше, перезагружаем страницу
                console.log("Загрузка заняла слишком много времени. Перезагружаем страницу.");
                location.reload(); // Перезагружаем страницу
            }
        }, 20000); // 20 секунд
    }

    function closeAllertDownload() {
        document.querySelector(`#bgDownloadSpinner`).classList.add(`display-none`);
        document.querySelector(`#downloadSpinner`).classList.add(`display-none`);
        
        // Проверяем, если был таймер, то очищаем его, так как загрузка завершена до 10 секунд
        if (downloadTimer !== null) {
            clearTimeout(downloadTimer);
            downloadTimer = null; // Очищаем переменную таймера
        }
        
        // Сбросим переменную времени, так как загрузка завершена
        downloadStartTime = null;
    }

    function addNewRole(){ 
        const inputRoleName = document.querySelector(`#inputNameNewRole`);
        const roleName = inputRoleName.value.trim();
        const pErrorAddNewRole = document.querySelector(`#pErrorAddNewRole`);

        const cbWorkInMachine = document.querySelector(`#cbWorkInMachine`);
        const cbSetupMachine = document.querySelector(`#cbSetupMachine`);
        const cbDetailsMenu = document.querySelector(`#cbDetailsMenu`);
        const cbCheckCountDetails = document.querySelector(`#cbCheckCountDetails`);
        const cbStorageDetails = document.querySelector(`#cbStorageDetails`);
        const cbCreateGrafikWorkers = document.querySelector(`#cbCreateGrafikWorkers`);
        
        if(roleName.length > 2){
            readToFirebase(`roles/${transliterate(roleName.toLowerCase())}`, role => {
                if(!role){
                    pErrorAddNewRole.classList.add(`display-none`);
                    let objNewRole = {
                        name: `${roleName}`,
                    };

                    objNewRole.workInMachine = cbWorkInMachine.checked;
                    objNewRole.setupMachine = cbSetupMachine.checked;
                    objNewRole.addDetails = cbDetailsMenu.checked;
                    objNewRole.checkCountDetails = cbCheckCountDetails.checked;
                    objNewRole.storageDetails = cbStorageDetails.checked;
                    objNewRole.createGrafikWorkers = cbCreateGrafikWorkers.checked;

                    writeToFirebase(`roles/${transliterate(roleName.toLowerCase())}`, objNewRole);
                    inputRoleName.value = '';
                } else {
                    pErrorAddNewRole.classList.remove('display-none');
                    pErrorAddNewRole.textContent = `Должность с таким именем уже существует`;

                }
            });
        } else {
            pErrorAddNewRole.classList.remove('display-none');
            pErrorAddNewRole.textContent = `Название должно быть минимум 3 символа`;
        }
    }

    function reductInfoWorker(event, workerSystemName){
        event.stopPropagation();
        const inputActualRoleForReductInformationWorker = document.querySelector(`#inputActualRoleForReductInformationWorker`);
        const selectListRolesForReductInformationWorker = document.querySelector(`#selectListRolesForReductInformationWorker`);
        const pErrorNewRoleForReductInformationWorker = document.querySelector(`#pErrorNewRoleForReductInformationWorker`);
        const inputNewFioForReductInformationWorker = document.querySelector(`#inputNewFioForReductInformationWorker`);
        const pErrorNewFioForReductIntormationWorker = document.querySelector(`#pErrorNewFioForReductIntormationWorker`);
        const buttonChangeRoleForReductInformationWorker = document.querySelector(`#buttonChangeRoleForReductInformationWorker`);
        const buttonChangeFioForReductInformationWorker = document.querySelector(`#buttonChangeFioForReductInformationWorker`);
        const buttonChangeHorlyRateForReductInformationWorker = document.querySelector(`#buttonChangeHorlyRateForReductInformationWorker`);
        const inputNewHorlyRateForReductInformationWorker = document.querySelector(`#inputNewHorlyRateForReductInformationWorker`);
        const pErrorNewHorlyRateForReductInformationWorker = document.querySelector(`#pErrorNewHorlyRateForReductInformationWorker`);
        const pErrorCreditForReductInformationWorker = document.querySelector(`#pErrorCreditForReductInformationWorker`);
        const inputAddCreditForReductInformationWorker = document.querySelector(`#inputAddCreditForReductInformationWorker`);
        const inputMinusCreditForReductInformationWorker = document.querySelector(`#inputMinusCreditForReductInformationWorker`);
        const buttonChangeCreditForReductInformationWorker = document.querySelector(`#buttonChangeCreditForReductInformationWorker`);

        pErrorNewRoleForReductInformationWorker.classList.add(`display-none`);
        pErrorNewFioForReductIntormationWorker.classList.add(`display-none`);
        pErrorNewHorlyRateForReductInformationWorker.classList.add(`display-none`);
        pErrorCreditForReductInformationWorker.classList.add(`display-none`);
        inputNewFioForReductInformationWorker.value = '';
        inputNewHorlyRateForReductInformationWorker.value = '';
        inputAddCreditForReductInformationWorker.value = '';
        inputMinusCreditForReductInformationWorker.value = '';

        readToFirebase(`workers/${workerSystemName}`, worker => {
            document.querySelector(`#h2TitleFioWorkerForReductInformation`).textContent = `Редактирование информации для ${worker.fio}`;

            document.querySelector(`#allertReductInformationWorker`).classList.remove(`display-none`);
            document.querySelector(`#bg-allert`).classList.remove(`display-none`);

            if(worker.horlyRate){
                document.querySelector(`#inputActualyHorlyRateForReductInformationWorker`).value = `${worker.horlyRate} грн/ч`;
            } else {
                document.querySelector(`#inputActualyHorlyRateForReductInformationWorker`).value = `0 грн/ч`;
            }

            if(worker.credit){
                document.querySelector(`#inputActualyCreditForReductInformationWorker`).value = `${worker.credit} грн`;
            } else {
                document.querySelector(`#inputActualyCreditForReductInformationWorker`).value = `0 грн`;
            }


            readToFirebase(`roles`, roles => {
                selectListRolesForReductInformationWorker.innerHTML = `<option value="">Выберите новую должность</option>`;
                Object.entries(roles).forEach(([key, role]) => {
                    selectListRolesForReductInformationWorker.innerHTML += `<option value="${key}">${role.name}</option>`;
                });
                inputActualRoleForReductInformationWorker.value = roles[worker.role].name;
            });

            buttonChangeRoleForReductInformationWorker.onclick = function(){
                clickReductRoleForWorker(worker.role, selectListRolesForReductInformationWorker.value, workerSystemName);
            };

            buttonChangeFioForReductInformationWorker.onclick = function() {
                clickReductFioForWorker(workerSystemName, inputNewFioForReductInformationWorker.value);
            };

            buttonChangeHorlyRateForReductInformationWorker.onclick = function() {
                clickReductHorlyRateForWorker(workerSystemName, inputNewHorlyRateForReductInformationWorker.value);
            };

            inputAddCreditForReductInformationWorker.oninput = function() {
                inputMinusCreditForReductInformationWorker.value = '';
            };
            
            inputMinusCreditForReductInformationWorker.oninput = function() {
                inputAddCreditForReductInformationWorker.value = '';
                if(Number(inputMinusCreditForReductInformationWorker.value) > Number(worker.credit)){
                    inputMinusCreditForReductInformationWorker.value = worker.credit;
                }
            };

            buttonChangeCreditForReductInformationWorker.onclick = function(){
                clickReductCreditForWorker(workerSystemName, worker.credit);
            };


        });
    }

    function clickReductRoleForWorker(oldRole, newRole, workerSystemName){
        const pErrorNewRoleForReductInformationWorker = document.querySelector(`#pErrorNewRoleForReductInformationWorker`);

        if(!newRole){
            pErrorNewRoleForReductInformationWorker.textContent = 'Выберите новую должность';
            pErrorNewRoleForReductInformationWorker.classList.remove('display-none');
            return;
        }

        if(oldRole == newRole){
            pErrorNewRoleForReductInformationWorker.textContent = 'Данная должность уже установлена';
            pErrorNewRoleForReductInformationWorker.classList.remove('display-none');
            return;
        }

        pErrorNewRoleForReductInformationWorker.classList.add(`display-none`);

        overwriteToFirebase(`workers/${workerSystemName}/role`, newRole);
        document.querySelector(`#allertReductInformationWorker`).classList.add(`display-none`);
        document.querySelector(`#bg-allert`).classList.add(`display-none`);
    }

    function clickReductHorlyRateForWorker(workerSystemName, newHorlyRateWorker){
        const pErrorNewHorlyRateForReductInformationWorker = document.querySelector(`#pErrorNewHorlyRateForReductInformationWorker`);
        
        if(newHorlyRateWorker > 0){
            overwriteToFirebase(`workers/${workerSystemName}/horlyRate`, newHorlyRateWorker);
            closeAllAllerts();
        } else {
            pErrorNewHorlyRateForReductInformationWorker.classList.remove('display-none');
        }
    }

    function clickReductCreditForWorker(workerSystemName, credit){
        let creditWorker = 0;
        if(credit){
            creditWorker = Number(credit);
        }
        const minusInput = document.querySelector(`#inputMinusCreditForReductInformationWorker`);
        const addInput = document.querySelector(`#inputAddCreditForReductInformationWorker`);

        if(Number(minusInput.value) > 0){
            overwriteToFirebase(`workers/${workerSystemName}/credit`, Number(creditWorker) - Number(minusInput.value));
            closeAllAllerts();
            let value = 0;
            value -= Number(minusInput.value);
            addLog(workerSystemName, value);
        } else if(Number(addInput.value) > 0){
            overwriteToFirebase(`workers/${workerSystemName}/credit`, Number(creditWorker) + Number(addInput.value));
            closeAllAllerts();
            addLog(workerSystemName, Number(addInput.value));
        } else {
            document.querySelector(`#pErrorCreditForReductInformationWorker`).classList.remove('display-none');
        }

        function addLog(workerSystemName, value){
            const dateNow = Date.now();
            const log = {
                date: dateNow,
                typeLog: 'Credit',
                newCredit: creditWorker + value,
                oldCredit: creditWorker,
                value: value
            };

            writeToFirebase(`logs/workers/${workerSystemName}/credit/${dateNow}`, log);
        }
    }

    function clickReductFioForWorker(oldSystemFio, newFio){
        const newSystemFio = transliterate(newFio);

        const pErrorNewFioForReductIntormationWorker = document.querySelector(`#pErrorNewFioForReductIntormationWorker`);
        pErrorNewFioForReductIntormationWorker.classList.add(`display-none`);

        if(newFio.length < 4){
            pErrorNewFioForReductIntormationWorker.classList.remove(`display-none`);
            pErrorNewFioForReductIntormationWorker.textContent = 'ФИО должно состоять минимум из пяти букв';
            return;
        }
        
        if(newFio.trim().split(/\s+/).length !== 3){
            pErrorNewFioForReductIntormationWorker.classList.remove(`display-none`);
            pErrorNewFioForReductIntormationWorker.textContent = 'ФИО должно состоять минимум из трех слов';
            return;
        }

        readToFirebase(`workers/${newSystemFio}`, protectWorker => {
            if(protectWorker){
                pErrorNewFioForReductIntormationWorker.classList.remove(`display-none`);
                pErrorNewFioForReductIntormationWorker.textContent = 'Человек с таким именем уже есть';
            } else {
                readToFirebase(`workers/${oldSystemFio}`, workerOldFio => {
                    if (!workerOldFio) {
                        // Если данных нет, показываем ошибку
                        pErrorNewFioForReductIntormationWorker.classList.remove(`display-none`);
                        pErrorNewFioForReductIntormationWorker.textContent = 'Работник с таким ФИО не найден';
                        return; // Прерываем выполнение
                    }
                    let objNewFioWorker = workerOldFio;
                    objNewFioWorker.fio = newFio;
                    writeToFirebase(`workers/${newSystemFio}`, objNewFioWorker);
                    overwriteToFirebase(`workers/${oldSystemFio}`, {});
                    readToFirebase(`logs/workers/${oldSystemFio}/logs`, oldLogs => {
                        const logs = oldLogs;
                        writeToFirebase(`logs/workers/${newSystemFio}/logs`, logs);
                        overwriteToFirebase(`logs/workers/${oldSystemFio}/logs`, {});
                    })
                    const payload = {
                        oldName: oldSystemFio,
                        newName: newSystemFio
                    };

                    console.log("Отправка данных: ", payload);

                    fetch(`${apiLink}/rename_image`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Ответ от API: ", data);
                    })
                    .catch(error => {
                        console.error("Ошибка отправки запроса: ", error);
                    });
                });

                document.querySelector(`#allertReductInformationWorker`).classList.add(`display-none`);
                document.querySelector(`#bg-allert`).classList.add(`display-none`);
            }
        });

    }

    async function openAllertMounthPanelForDetailInformation1(type, systemName, timeStamp) {
        openAllertDownload();
        document.querySelector(`#allertMountPanelForDetailInformation`).classList.add('display-none');

        const h2TitleNameMountPanelForDetailInformation = document.querySelector(`#h2TitleNameMountPanelForDetailInformation`);
        const containerDatesCalendar = document.querySelector(`#containerDatesCalendar`);
        
        document.querySelector(`#buttonPreviousMountPanel`).onclick = function(){
            openAllertMounthPanelForDetailInformation(type, systemName, getPreviousMonth(Number(timeStamp)));
        }
        document.querySelector(`#buttonNextMountPanel`).onclick = function(){
            openAllertMounthPanelForDetailInformation(type, systemName, getNextMonth(Number(timeStamp)));
        }
        containerDatesCalendar.innerHTML = '';

        const objThisMount = getMonthInfo(Number(timeStamp));
        const { startOfMonth, endOfMonth, mounthNameUa, mounthNameRu, year } = objThisMount;

        document.querySelector(`#buttonDetailInformationChartMounth`).onclick = function(){
            openAllertChartDetailInformation('worker', 'period', systemName, startOfMonth, endOfMonth);
        }

        document.querySelector(`#buttonDetailInformationWorkerYearMountPanel`).onclick = function(){
            openAllertStatWorkerYear(systemName, timeStamp);
        };

        document.querySelector(`#h3YearMountPanelForDetailInformation`).textContent = year;
        document.querySelector(`#h3MountNameUkrMountPanelForDetailInformation`).textContent = mounthNameUa;
        document.querySelector(`#h3MountNameRusMountPanelForDetailInformation`).textContent = mounthNameRu;

        const arrayDaysThisMonth = getDaysInRange(startOfMonth, endOfMonth);
        const firstDayOfMonth = new Date(startOfMonth).getDay();

        // Пустые ячейки перед первым днём месяца
        let normalizedFirstDay = firstDayOfMonth === 0 ? 7 : firstDayOfMonth;

        for (let i = 1; i < normalizedFirstDay; i++) {
            containerDatesCalendar.innerHTML += `
                <div><div class="container"></div></div>
            `;
        }


        if (type === 'worker') {
            const worker = await asyncReadToFirebase(`workers/${systemName}`);
            h2TitleNameMountPanelForDetailInformation.textContent = worker.fio;

            for (const day of arrayDaysThisMonth) {
                const logWorkDay = await asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/workdays`, day.startDateMs, day.endDateMs);
                
                let arrayCoefficients = [];
                let timerDay = '';

                if(logWorkDay){
                    const objLogWorkDay = Object.values(logWorkDay)[0];
                    timerDay = (objLogWorkDay.endWorkDay - objLogWorkDay.startWorkDay) / 1000;
                    timerDay = secondsToTimeFormat(Number(timerDay));
                    
                    const logsMachines = await asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/machines`, objLogWorkDay.startWorkDay, objLogWorkDay.endWorkDay);

                    if(logsMachines){
                        for(const logMachine of Object.values(logsMachines)){
                            if(logMachine.typeLog == `Производство`){
                                const machineTime = Number(logMachine.countDetails) * (
                                    minSecToSeconds(logMachine.timeDetail) + minSecToSeconds(logMachine.timeChangeDetail)
                                );
                                const timer = (Number(logMachine.endTime) - Number(logMachine.startTime)) / 1000;
                                const res = machineTime / timer;
                                arrayCoefficients.push(res);
                            }
                        }
                    }
                }

                const averageCoefficient = arrayCoefficients.length ? parseFloat((arrayCoefficients.reduce((a, b) => a + b, 0) / arrayCoefficients.length).toFixed(2)) : 0;
                
                if(averageCoefficient != 0){
                    containerDatesCalendar.innerHTML += `
                        <div onclick="openAllertChartDetailInformation('worker', 'day', '${systemName}', '${day.startDateMs}', '${day.endDateMs}')"
                        style="background-color: ${getColorForCoefficient(averageCoefficient)}" class="item">
                            <div class="container">
                                <h3>${day.day}</h3>
                                <p>${timerDay}</p>
                                <p>${arrayCoefficients.length ? Math.round(averageCoefficient * 100) + '%' : ''}</p>
                            </div>
                        </div>
                    `;
                } else {
                    const vacantionDay = await asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/vacation`, day.startDateMs, day.endDateMs);
                    if(vacantionDay){
                        containerDatesCalendar.innerHTML += `
                            <div class="item">
                                    <div class="container">
                                        <h3>${day.day}</h3>
                                        <p>Отпуск</p>
                                        <p></p>
                                    </div>
                                </div>
                         `;
                    } else {
                        const hospitalDay = await asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/hospital`, day.startDateMs, day.endDateMs);
                        
                        if(hospitalDay){
                            containerDatesCalendar.innerHTML += `
                                <div class="item">
                                        <div class="container">
                                            <h3>${day.day}</h3>
                                            <p>Больничный</p>
                                            <p></p>
                                        </div>
                                    </div>
                            `;
                        } else {
                            containerDatesCalendar.innerHTML += `
                                <div onclick="openAllertAddHospitalOrVacantionWorker('${systemName}', '${day.startDateMs}')"
                                style="background-color: ${getColorForCoefficient(averageCoefficient)}" class="item">
                                    <div class="container">
                                        <h3>${day.day}</h3>
                                        <p>${timerDay}</p>
                                        <p>${arrayCoefficients.length ? Math.round(averageCoefficient * 100) + '%' : ''}</p>
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
            }
        }

        document.querySelector(`#bg-allert`).classList.remove('display-none');
        document.querySelector(`#allertMountPanelForDetailInformation`).classList.remove('display-none');
        closeAllertDownload();
    }

    async function openAllertMounthPanelForDetailInformation(type, systemName, timeStamp) {
    openAllertDownload();
    document.querySelector(`#allertMountPanelForDetailInformation`).classList.add('display-none');

    const h2TitleNameMountPanelForDetailInformation = document.querySelector(`#h2TitleNameMountPanelForDetailInformation`);
    const containerDatesCalendar = document.querySelector(`#containerDatesCalendar`);

    document.querySelector(`#buttonPreviousMountPanel`).onclick = function(){
        openAllertMounthPanelForDetailInformation(type, systemName, getPreviousMonth(Number(timeStamp)));
    }
    document.querySelector(`#buttonNextMountPanel`).onclick = function(){
        openAllertMounthPanelForDetailInformation(type, systemName, getNextMonth(Number(timeStamp)));
    }
    containerDatesCalendar.innerHTML = '';

    const objThisMount = getMonthInfo(Number(timeStamp));
    const { startOfMonth, endOfMonth, mounthNameUa, mounthNameRu, year } = objThisMount;

    document.querySelector(`#buttonDetailInformationChartMounth`).onclick = function(){
        openAllertChartDetailInformation('worker', 'period', systemName, startOfMonth, endOfMonth);
    }

    document.querySelector(`#buttonDetailInformationWorkerYearMountPanel`).onclick = function(){
        openAllertStatWorkerYear(systemName, timeStamp);
    };

    document.querySelector(`#h3YearMountPanelForDetailInformation`).textContent = year;
    document.querySelector(`#h3MountNameUkrMountPanelForDetailInformation`).textContent = mounthNameUa;
    document.querySelector(`#h3MountNameRusMountPanelForDetailInformation`).textContent = mounthNameRu;

    const arrayDaysThisMonth = getDaysInRange(startOfMonth, endOfMonth);
    const firstDayOfMonth = new Date(startOfMonth).getDay();
    let normalizedFirstDay = firstDayOfMonth === 0 ? 7 : firstDayOfMonth;

    // Пустые ячейки перед первым днём месяца
    let html = '';
    for (let i = 1; i < normalizedFirstDay; i++) {
        html += `<div><div class="container"></div></div>`;
    }

    if (type === 'worker') {
        const worker = await asyncReadToFirebase(`workers/${systemName}`);
        h2TitleNameMountPanelForDetailInformation.textContent = worker.fio;

        // Запросы для каждого дня — собираем массив промисов
        const dayDataPromises = arrayDaysThisMonth.map(async (day) => {
            const logWorkDay = await asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/workdays`, day.startDateMs, day.endDateMs);
            
            let arrayCoefficients = [];
            let timerDay = '';

            if(logWorkDay){
                const objLogWorkDay = Object.values(logWorkDay)[0];
                timerDay = (objLogWorkDay.endWorkDay - objLogWorkDay.startWorkDay) / 1000;
                timerDay = secondsToTimeFormat(Number(timerDay));
                
                const logsMachines = await asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/machines`, objLogWorkDay.startWorkDay, objLogWorkDay.endWorkDay);

                if(logsMachines){
                    for(const logMachine of Object.values(logsMachines)){
                        if(logMachine.typeLog == `Производство`){
                            const machineTime = Number(logMachine.countDetails) * (
                                minSecToSeconds(logMachine.timeDetail) + minSecToSeconds(logMachine.timeChangeDetail)
                            );
                            const timer = (Number(logMachine.endTime) - Number(logMachine.startTime)) / 1000;
                            const res = machineTime / timer;
                            arrayCoefficients.push(res);
                        }
                    }
                }
            }

            const averageCoefficient = arrayCoefficients.length ? parseFloat((arrayCoefficients.reduce((a, b) => a + b, 0) / arrayCoefficients.length).toFixed(2)) : 0;

            if(averageCoefficient != 0){
                return `
                    <div onclick="openAllertChartDetailInformation('worker', 'day', '${systemName}', '${day.startDateMs}', '${day.endDateMs}')"
                    style="background-color: ${getColorForCoefficient(averageCoefficient)}" class="item">
                        <div class="container">
                            <h3>${day.day}</h3>
                            <p>${timerDay}</p>
                            <p>${arrayCoefficients.length ? Math.round(averageCoefficient * 100) + '%' : ''}</p>
                        </div>
                    </div>
                `;
            } else {
                // Проверяем отпуск и больничный параллельно
                const [vacationDay, hospitalDay] = await Promise.all([
                    asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/vacation`, day.startDateMs, day.endDateMs),
                    asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/hospital`, day.startDateMs, day.endDateMs)
                ]);

                if(vacationDay){
                    return `
                        <div class="item">
                            <div class="container">
                                <h3>${day.day}</h3>
                                <p>Отпуск</p>
                                <p></p>
                            </div>
                        </div>
                    `;
                } else if(hospitalDay){
                    return `
                        <div class="item">
                            <div class="container">
                                <h3>${day.day}</h3>
                                <p>Больничный</p>
                                <p></p>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div onclick="openAllertAddHospitalOrVacantionWorker('${systemName}', '${day.startDateMs}')"
                        style="background-color: ${getColorForCoefficient(averageCoefficient)}" class="item">
                            <div class="container">
                                <h3>${day.day}</h3>
                                <p>${timerDay}</p>
                                <p>${arrayCoefficients.length ? Math.round(averageCoefficient * 100) + '%' : ''}</p>
                            </div>
                        </div>
                    `;
                }
            }
        });

        // Ждем все данные и собираем html
        const dayHtmlArr = await Promise.all(dayDataPromises);
        html += dayHtmlArr.join('');
    }

    containerDatesCalendar.innerHTML = html;

    document.querySelector(`#bg-allert`).classList.remove('display-none');
    document.querySelector(`#allertMountPanelForDetailInformation`).classList.remove('display-none');
    closeAllertDownload();
}

    async function openAllertAddHospitalOrVacantionWorker(workerSystemName, timeStamp){
        openAllertDownload();
        document.querySelector(`#allertMountPanelForDetailInformation`).classList.add('display-none');
        const year = getYearBounds(Number(timeStamp));

        const hospitalDays = await asyncReadFirebaseByKeyRange(`logs/workers/${workerSystemName}/hospital`, year.startOfYear, year.endOfYear);
        const vacationDays = await asyncReadFirebaseByKeyRange(`logs/workers/${workerSystemName}/vacation`, year.startOfYear, year.endOfYear);

        let countHospitalDays = 0;
        if(hospitalDays){
            countHospitalDays = Object.values(hospitalDays).length;
        }

        let countVacationDays = 0;
        if(vacationDays){
            countVacationDays = Object.values(vacationDays).length;
        }

        document.querySelector(`#spanCountHospitalForAllertAddVacantionOrHospital`).textContent = countHospitalDays;
        document.querySelector(`#spanCountVacantionForAllertAddVacantionOrHospital`).textContent = countVacationDays;
        
        
        const pArray = document.querySelectorAll(`#allertAddVacantionOrHospital p`);
        pArray[0].textContent = `Больничных в ${new Date(Number(timeStamp)).getFullYear()}`;
        pArray[1].textContent = `Отпускных в ${new Date(Number(timeStamp)).getFullYear()}`;

        const buttonsArray = document.querySelectorAll(`#allertAddVacantionOrHospital button`);

        buttonsArray[0].onclick = async function(){
            openAllertDownload();
            await asyncWriteToFirebase(`logs/workers/${workerSystemName}/hospital/${timeStamp + 10}`, { date: timeStamp + 10, dateAdd: Date.now() });
            closeAllertDownload();
            closeAllAllerts();
        }

        buttonsArray[1].onclick = async function(){
            openAllertDownload();
            await asyncWriteToFirebase(`logs/workers/${workerSystemName}/vacation/${timeStamp + 10}`, { date: timeStamp + 10, dateAdd: Date.now() });
            closeAllertDownload();
            closeAllAllerts();
        }

        buttonsArray[2].onclick = function(){
            document.querySelector(`#allertMountPanelForDetailInformation`).classList.remove('display-none');
            document.querySelector(`#allertAddVacantionOrHospital`).classList.add('display-none');
        }
        document.querySelector(`#allertAddVacantionOrHospital`).classList.remove('display-none');

        closeAllertDownload();
    }

    function printChartToDetailInformation(data, typeChart, nameChart) {
        const container = document.querySelector('#containerChartForAllertDetailInformation');
        container.innerHTML = ''; // очищаем содержимое

        if (echarts.getInstanceByDom(container)) {
            echarts.dispose(container); // Удаляем старую инициализацию
        }

        const chart = echarts.init(container); // используем сам контейнер

        if (typeChart === 'pie') {
            const option = {
                title: {
                    text: nameChart,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        return `${params.data.description || ''}`;
                    }
                },
                legend: {
                    show: false
                },
                series: [
                    {
                        name: nameChart,
                        type: 'pie',
                        radius: '70%',
                        data: data,
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#fff',
                            fontWeight: 600,
                            formatter: function (params) {
                                return params.data.title || params.name;
                            }
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };

            chart.setOption(option);
            }  else if (typeChart === 'diagram') {
            const categories = data.map(item => item.name);
            const values = data.map(item => item.value);

            const option = {
                title: {
                    text: nameChart,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const index = params[0].dataIndex;
                        return data[index].description || `${params[0].name}: ${params[0].value}`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        data: values,
                        type: 'bar',
                        label: {
                            show: true,
                            position: 'top',
                            formatter: function (params) {
                                return data[params.dataIndex].title || params.name;
                            }
                        },
                        itemStyle: {
                            color: '#73C0DE'
                        },
                        emphasis: {
                            focus: 'series'
                        }
                    }
                ]
            };

            chart.setOption(option);
        } else if (typeChart === 'line') {
            // Преобразуем данные для line-графика с заливкой под линией
            const categories = data.map(item => item.name); // X-ось — названия станков
            const values = data.map(item => item.value); // Y-ось — значения

            const option = {
                title: {
                    text: nameChart,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const index = params[0].dataIndex;
                        return data[index].description || `${params[0].name}: ${params[0].value}`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        data: values,
                        type: 'line',
                        smooth: true,
                        areaStyle: {}, // Включаем заливку под линией
                        label: {
                            show: true,
                            position: 'top',
                            formatter: function (params) {
                                return data[params.dataIndex].title || params.name;
                            }
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        itemStyle: {
                            color: '#5470C6' // Цвет линии и заливки (по умолчанию)
                        }
                    }
                ]
            };

            chart.setOption(option);
        } else {
            container.innerHTML = `<p>Тип графика "${typeChart}" не поддерживается.</p>`;
        }
    }

    function changeTypeDataInDetailInformationChart(type){
        const buttons = document.querySelectorAll(`#containerTypesDataInChart div`);

        actualTypeDataChart = type;

        Object.values(buttons).forEach(button => {
            button.classList.remove('select-type');
        });

        if(type == 'time'){
            document.querySelector(`#buttonChangeTypeChartToTime`).classList.add('select-type');
            printChartToDetailInformation(actualDataForChartTime, actualTypeChart, "Продолжитльность работы на станках");
        } else if(type == 'procent'){
            document.querySelector(`#buttonChangeTypeChartToProcent`).classList.add('select-type');
            printChartToDetailInformation(actualDataForChartProcent, actualTypeChart, "Процент продуктивности работы");
        } else if(type == 'details'){
            document.querySelector(`#buttonChangeTypeChartToDetails`).classList.add('select-type');
            printChartToDetailInformation(actualDataForChartCountDetails, actualTypeChart, "Количество деталей");
        }

    }

    function changeTypeChartInDetailInformationChart(type){
        const buttons = document.querySelectorAll(`#containerTypesChart div`);

        actualTypeChart = type;

        Object.values(buttons).forEach(button => {
            button.classList.remove('select-type');
        });

        if(type == 'pie'){
            document.querySelector(`#buttonChangeTypeChartToPie`).classList.add('select-type');
        } else if(type == 'diagram'){
            document.querySelector(`#buttonChangeTypeChartToDiagram`).classList.add('select-type');
        } else if(type == 'line'){
            document.querySelector(`#buttonChangeTypeChartToLine`).classList.add('select-type');
        }

        if(actualTypeDataChart == 'time'){
            printChartToDetailInformation(actualDataForChartTime, actualTypeChart, "Время работы");
        } else if(actualTypeDataChart == 'procent'){
            printChartToDetailInformation(actualDataForChartProcent, actualTypeChart, "Процент результативности");
        } else if(actualTypeDataChart == 'details'){
            printChartToDetailInformation(actualDataForChartCountDetails, actualTypeChart, "Количество деталей");
        }
    }

    function clickCloseAllertChart(){
        document.querySelector(`#allertDetailInformationChart`).classList.add('display-none');
    }
    
    async function clickPaySalaryWorker(workerSystemName, startRange, endRange) {
        const inputTotalSumAllertSalary = document.querySelector(`#inputTotalSumAllertSalary`);
        const pError = document.querySelector(`#allertCalculateSalary .p-error`);

        if(Number(inputTotalSumAllertSalary.value) >= totalSumForAllertSalary){
            pError.classList.add('display-none');
            openAllertDownload();
            const logs = await asyncReadFirebaseByKeyRange(`logs/workers/${workerSystemName}/workdays`, startRange, endRange);
            if(logs){
                for (const [key, log] of Object.entries(logs)) {
                    let newLog = { ...log, statusPayed: true };
                    await asyncOverwriteToFirebase(`logs/workers/${workerSystemName}/workdays/${key}`, newLog);    
                }
                
                let credit = 0;
                const inputAddCreditAllertSalary = document.querySelector(`#inputAddCreditAllertSalary`);
                if(inputAddCreditAllertSalary.value > 0){
                    credit += Number(inputAddCreditAllertSalary.value);
                } else {
                    const inputMinusCreditAllertSalary = document.querySelector(`#inputMinusCreditAllertSalary`);
                    if(inputMinusCreditAllertSalary.value > 0){
                        credit -= Number(inputMinusCreditAllertSalary.value);
                    }
                }

                const dateNow = Date.now();

                const logSalary = {
                    typeLog: 'Выдача ЗП',
                    date: Date.now(),
                    sum: totalSumForAllertSalary,
                    credit: credit,
                    startRange: startRange,
                    endRange: endRange
                };

                await asyncWriteToFirebase(`logs/workers/${workerSystemName}/salary/${dateNow}`, logSalary);

                if(credit != 0){
                    const newCredit = Number(creditWorkerForCalculateSalary) + Number(credit);
                    const logCredit = {
                        date: dateNow,
                        typeLog: 'Credit',
                        newCredit: newCredit,
                        oldCredit: Number(creditWorkerForCalculateSalary),
                        value: Number(credit)
                    };
                    await asyncOverwriteToFirebase(`workers/${workerSystemName}/credit`, newCredit);
                    await asyncWriteToFirebase(`logs/workers/${workerSystemName}/credit/${dateNow}`, logCredit);
                } // добавить запись лога кредита

            }

            closeAllertDownload();

            document.querySelector(`#allertCalculateSalary`).classList.add('display-none');
            document.querySelector(`#allertStatWorkersTwoWeen`).classList.remove('display-none');
            document.querySelector(`#tr-first-${workerSystemName}`).classList.add('green-allocation');
            document.querySelector(`#tr-two-${workerSystemName}`).classList.add('green-allocation');

        } else {
            pError.classList.remove('display-none');
            pError.textContent = 'Введенная сумма меньше необходимой';
        }

    }

    async function openAllertChartDetailInformation(type, typeRange, systemName, startRange, endRange) {
        openAllertDownload();
        actualDataForChartTime = [];
        actualDataForChartProcent = [];
        actualDataForChartCountDetails = [];

        if (type === 'worker') {
            
                const logsWorkDaysThisRange = await asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/workdays`, startRange, endRange);
                if(!logsWorkDaysThisRange){
                    return;
                    console.log(`Нет логов рабочих дней для этого работника по заданному диапазону`);
                }

                let objAllDetails = {};
                let objSetupMachines = {};

                if(typeRange === 'day'){
                    let startWorkDay = 0;
                    let endWorkDay = 0;
                    
                    const logsWorkDays = await asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/workdays`, startRange, endRange);
                    if(logsWorkDays){
                        for(const workdayLog of Object.values(logsWorkDays)){
                            if(startWorkDay == 0){
                                startWorkDay = workdayLog.startWorkDay
                            }
                            endWorkDay = workdayLog.endWorkDay;
                        }   
                    }   

                    const logsMachinesThisRange = await asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/machines`, startRange, endRange);

                    if(logsMachinesThisRange){
                        for(const machineLog of Object.values(logsMachinesThisRange)){
                            if (machineLog.typeLog === 'Производство') {
                                const timeValue = machineLog.endTime - machineLog.startTime;
                                const machineName = machineLog.machine;
                                const timeOnMachine = getTimeDifference(machineLog.startTime, machineLog.endTime);
                                const timeDetailSecs = minSecToSeconds(machineLog.timeDetail);
                                const timeChangeDetailSecs = minSecToSeconds(machineLog.timeChangeDetail);
                                const totalWorkSecs = (timeDetailSecs + timeChangeDetailSecs) * machineLog.countDetails;
                                const normDetails = Math.round((timeValue / 1000) / (timeDetailSecs + timeChangeDetailSecs));
                                const procent = Math.round((Number(machineLog.countDetails) / normDetails) * 100);
                                const commonDesc = `
                                    Станок: ${machineName}</br>
                                    Деталь: ${machineLog.detail} (${machineLog.install})</br>
                                    Время детали: ${machineLog.timeDetail}</br>
                                    Время смены детали: ${machineLog.timeChangeDetail}</br>
                                    Время работы на станке: ${timeOnMachine}</br>
                                    Время работы станка: ${secondsToTimeFormat(totalWorkSecs)}</br>
                                    Сделано деталей: ${machineLog.countDetails}</br>
                                    Норма деталей: ${normDetails}</br>
                                    Процент результативности: ${procent}%</br>
                                    Начало работы на станке: ${formatDate(machineLog.startTime)}</br>
                                    Конец работы на станке: ${formatDate(machineLog.endTime)}</br>
                                    Наладчик: ${formatName(machineLog.naladchik)}
                                `;

                                actualDataForChartTime.push({
                                    value: timeValue,
                                    name: machineName,
                                    title: `${machineName} (${timeOnMachine})`,
                                    description: commonDesc
                                });

                                actualDataForChartCountDetails.push({
                                    value: machineLog.countDetails,
                                    name: machineName,
                                    title: `${machineName}\n ${machineLog.countDetails} шт.`,
                                    description: commonDesc
                                });

                                actualDataForChartProcent.push({
                                    value: timeValue,
                                    name: machineName,
                                    title: `${machineName}\n ${procent}%`,
                                    description: commonDesc
                                });

                                if (!objAllDetails[machineLog.detailSystemName]) {
                                    objAllDetails[machineLog.detailSystemName] = {
                                        detailName: `${machineLog.detail} (${machineLog.install})`,
                                        countDetails: 0
                                    };
                                }
                                objAllDetails[machineLog.detailSystemName].countDetails += Number(machineLog.countDetails);

                            } else if (machineLog.typeLog === 'настройка станка') {
                                objSetupMachines[Object.keys(objSetupMachines).length] = machineLog;
                            }
                        }
                    }

                    // Заполнение общей информации
                    const container = document.querySelector(`#containerGeneralInformationAllertChart`);
                    document.querySelector(`#h2TitleDateAllertDetailInformation`).textContent = formatedDate(Number(endRange));
                    container.innerHTML = `
                        <h3>Общая информация</h3>
                        <div class="container-info"><p>Начало рабочего дня:</p><span>${formatDate(startWorkDay)}</span></div>
                        <div class="container-info"><p>Конец рабочего дня:</p><span>${formatDate(endWorkDay)}</span></div>
                        <div class="container-info"><p>Продолжительность смены:</p><span>${getTimeDifference(startWorkDay, endWorkDay)}</span></div>
                        <div class="container-info"><p>Средний процент результативности:</p><span>-</span></div>
                    `;

                    if (Object.keys(objAllDetails).length > 0) {
                        container.innerHTML += `<h5>Изготовленные детали:</h5>`;
                        Object.values(objAllDetails).forEach(detail => {
                            container.innerHTML += `
                                <div class="container-info">
                                    <p>${detail.detailName}:</p>
                                    <span>${detail.countDetails} шт.</span>
                                </div>
                            `;
                        });
                    }

                    if (Object.keys(objSetupMachines).length > 0) {
                        container.innerHTML += `<h5>Настроенные станки:</h5>`;
                        for (const logSetup of Object.values(objSetupMachines)) {
                            const machine = await new Promise(resolve => {
                                readToFirebase(`${logSetup.machinePath}`, resolve);
                            });
                            container.innerHTML += `
                                <div class="container-info">
                                    <p>${machine.name}:</p>
                                    <span>${logSetup.detail} (${logSetup.install})</br>${logSetup.timeDetail} (${logSetup.timeChangeDetail})</span>
                                </div>`;
                        }
                    }
                } else if (typeRange === 'period') {
                    console.log(`Зашел в период`);
                    let objDetailsInThisPeriod = {};
                    let arrayCoefficientsThisPeriod = [];

                    const arrayWorkDaysThisRange = await asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/workdays`, startRange, endRange);

                    if(!arrayWorkDaysThisRange){
                        return;
                    }

                    for(const logThisDay of Object.values(arrayWorkDaysThisRange)){
                        let objDetailsInThisDay = {};
                        let arrayCoefficientsThisDay = [];


                        const logsMachinesThisDay = await asyncReadFirebaseByKeyRange(`logs/workers/${systemName}/machines`, logThisDay.startWorkDay, logThisDay.endWorkDay);
                        

                        if(!logsMachinesThisDay || logsMachinesThisDay == null){
                            console.log(`Нет логов по станкам за этот день`);
                        } else {
                            for(const logMachine of Object.values(logsMachinesThisDay)){
                                if(logMachine.typeLog === 'Производство'){
                                    // Добавляем в данные за день
                                    if(!objDetailsInThisDay[`${logMachine.detailSystemName}${logMachine.install}`]) {
                                        objDetailsInThisDay[`${logMachine.detailSystemName}${logMachine.install}`] = {
                                            detailName: `${logMachine.detail} (${logMachine.install})`,
                                            countDetails: 0
                                        };
                                    }
                                    objDetailsInThisDay[`${logMachine.detailSystemName}${logMachine.install}`].countDetails += Number(logMachine.countDetails);

                                    // Добавляем в данные за период
                                    if (!objDetailsInThisPeriod[`${logMachine.detailSystemName}${logMachine.install}`]) {
                                        objDetailsInThisPeriod[`${logMachine.detailSystemName}${logMachine.install}`] = {
                                            detailName: `${logMachine.detail} (${logMachine.install})`,
                                            countDetails: 0
                                        };
                                    }
                                    objDetailsInThisPeriod[`${logMachine.detailSystemName}${logMachine.install}`].countDetails += Number(logMachine.countDetails);

                                    // Расчёт коэффициента производительности
                                    const machineTime = Number(logMachine.countDetails) * (minSecToSeconds(logMachine.timeDetail) + minSecToSeconds(logMachine.timeChangeDetail));
                                    const timer = (Number(logMachine.endTime) - Number(logMachine.startTime)) / 1000;
                                    const res = (machineTime / timer) * 100;
                                    arrayCoefficientsThisDay.push(Number(res.toFixed(2)));
                                    
                                }
                            }
                        }

                        // Подготовка описания деталей
                        let descriptionDetails = '';
                        Object.values(objDetailsInThisDay).forEach(detail => {
                            descriptionDetails += `${detail.detailName}: ${detail.countDetails} шт.<br/>`;
                        });

                        const shiftTime = logThisDay.endWorkDay - logThisDay.startWorkDay;
                        const dateLabel = getNumberAndMountForDateNow(logThisDay.endWorkDay);
                        const shiftDuration = getTimeDifference(logThisDay.startWorkDay, logThisDay.endWorkDay);
                        const averageProcent = Math.round(calculateAverage(arrayCoefficientsThisDay));

                        actualDataForChartTime.push({
                            value: shiftTime,
                            name: `${dateLabel}\n(${shiftDuration})`,
                            title: `${dateLabel}\n(${shiftDuration})`,
                            description: `
                                Начало смены: ${formatDate(logThisDay.startWorkDay)}</br>
                                Конец смены: ${formatDate(logThisDay.endWorkDay)}</br>
                                Продолжительность смены: ${shiftDuration}</br>
                                Процент результативности: ${averageProcent}%</br>
                                Изготовленные детали: </br>
                                ${descriptionDetails}
                            `
                        });

                        let countAllsDetailInThisDay = Object.values(objDetailsInThisDay)
                            .reduce((sum, detail) => sum + detail.countDetails, 0);

                        actualDataForChartCountDetails.push({
                            value: countAllsDetailInThisDay,
                            name: `${dateLabel}\n(${countAllsDetailInThisDay} шт.)`,
                            title: `${dateLabel}\n(${countAllsDetailInThisDay} шт.)`,
                            description: `
                                Начало смены: ${formatDate(logThisDay.startWorkDay)}</br>
                                Конец смены: ${formatDate(logThisDay.endWorkDay)}</br>
                                Продолжительность смены: ${shiftDuration}</br>
                                Процент результативности: ${averageProcent}%</br>
                                Изготовленные детали: </br>
                                ${descriptionDetails}
                            `
                        });

                        actualDataForChartProcent.push({
                            value: countAllsDetailInThisDay,
                            name: `${dateLabel}\n(${averageProcent}%)`,
                            title: `${dateLabel}\n(${averageProcent}%)`,
                            description: `
                                Начало смены: ${formatDate(logThisDay.startWorkDay)}</br>
                                Конец смены: ${formatDate(logThisDay.endWorkDay)}</br>
                                Продолжительность смены: ${shiftDuration}</br>
                                Процент результативности: ${averageProcent}%</br>
                                Изготовленные детали: </br>
                                ${descriptionDetails}
                            `
                        });

                        arrayCoefficientsThisPeriod.push(averageProcent);
                    }

                    // Отрисовка общей информации
                    const container = document.querySelector(`#containerGeneralInformationAllertChart`);
                    document.querySelector(`#h2TitleDateAllertDetailInformation`).textContent =
                        `${formatedDate(Number(startRange))} - ${formatedDate(Number(endRange))}`;
                    
                    let allTimeThisPeriod = 0;
                    
                    for(const logDay of Object.values(logsWorkDaysThisRange)){
                        allTimeThisPeriod += logDay.endWorkDay - logDay.startWorkDay;
                    }

                    allTimeThisPeriod = allTimeThisPeriod / 1000;

                    container.innerHTML = `
                        <h3>Общая информация</h3>
                        <div class="container-info"><p>Количество смен:</p><span>${Object.values(logsWorkDaysThisRange).length}</span></div>
                        <div class="container-info"><p>Средняя продолжительность смены:</p><span>${secondsToTimeFormat(allTimeThisPeriod / Object.values(logsWorkDaysThisRange).length)}</span></div>
                        <div class="container-info"><p>Общее количество часов:</p><span>${secondsToTimeFormat(allTimeThisPeriod)}</span></div>
                        <div class="container-info"><p>Средний процент успешности:</p><span>${Math.round(calculateAverage(arrayCoefficientsThisPeriod))}%</span></div>
                        <h5>Изготовленные детали:</h5>
                    `;

                    Object.values(objDetailsInThisPeriod).forEach(detail => {
                        container.innerHTML += `
                            <div class="container-info">
                                <p>${detail.detailName}:</p>
                                <span>${detail.countDetails} шт.</span>
                            </div>
                        `;
                    });
                }

                // // переписываю этот метод
                // const logsThisRange = await new Promise((resolve, reject) => {
                //     readFirebaseByKeyRange(`logs/workers/${systemName}/logs`, startRange, endRange, data => {
                //         if (data) resolve(data);
                //         else reject('Данные не получены или пусты');
                //     });
                // });
                
                // let objAllDetails = {};
                // let objSetupMachines = {};

                // if (typeRange === 'day') {
                //     let startWorkDay = 0;
                //     let endWorkDay = 0;

                //     for (const log of Object.values(logsThisRange)) {
                //         if (log.typeLog === 'Производство') {
                //             const timeValue = log.endTime - log.startTime;
                //             const machineName = log.machine;
                //             const timeOnMachine = getTimeDifference(log.startTime, log.endTime);
                //             const timeDetailSecs = minSecToSeconds(log.timeDetail);
                //             const timeChangeDetailSecs = minSecToSeconds(log.timeChangeDetail);
                //             const totalWorkSecs = (timeDetailSecs + timeChangeDetailSecs) * log.countDetails;
                //             const normDetails = Math.round((timeValue / 1000) / (timeDetailSecs + timeChangeDetailSecs));
                //             const procent = Math.round((Number(log.countDetails) / normDetails) * 100);
                //             const commonDesc = `
                //                 Станок: ${machineName}</br>
                //                 Деталь: ${log.detail} (${log.install})</br>
                //                 Время детали: ${log.timeDetail}</br>
                //                 Время смены детали: ${log.timeChangeDetail}</br>
                //                 Время работы на станке: ${timeOnMachine}</br>
                //                 Время работы станка: ${secondsToTimeFormat(totalWorkSecs)}</br>
                //                 Сделано деталей: ${log.countDetails}</br>
                //                 Норма деталей: ${normDetails}</br>
                //                 Процент результативности: ${procent}%</br>
                //                 Начало работы на станке: ${formatDate(log.startTime)}</br>
                //                 Конец работы на станке: ${formatDate(log.endTime)}</br>
                //                 Наладчик: ${formatName(log.naladchik)}
                //             `;

                //             actualDataForChartTime.push({
                //                 value: timeValue,
                //                 name: machineName,
                //                 title: `${machineName} (${timeOnMachine})`,
                //                 description: commonDesc
                //             });

                //             actualDataForChartCountDetails.push({
                //                 value: log.countDetails,
                //                 name: machineName,
                //                 title: `${machineName}\n ${log.countDetails} шт.`,
                //                 description: commonDesc
                //             });

                //             actualDataForChartProcent.push({
                //                 value: timeValue,
                //                 name: machineName,
                //                 title: `${machineName}\n ${procent}%`,
                //                 description: commonDesc
                //             });

                //             if (!objAllDetails[log.detailSystemName]) {
                //                 objAllDetails[log.detailSystemName] = {
                //                     detailName: `${log.detail} (${log.install})`,
                //                     countDetails: 0
                //                 };
                //             }
                //             objAllDetails[log.detailSystemName].countDetails += Number(log.countDetails);

                //         } else if (log.typeLog === 'Конец рабочего дня') {
                //             startWorkDay = log.startWorkDay;
                //             endWorkDay = log.endWorkDay;

                //         } else if (log.typeLog === 'настройка станка') {
                //             objSetupMachines[Object.keys(objSetupMachines).length] = log;
                //         }
                //     }

                //     // Заполнение общей информации
                //     const container = document.querySelector(`#containerGeneralInformationAllertChart`);
                //     document.querySelector(`#h2TitleDateAllertDetailInformation`).textContent = formatedDate(Number(endRange));
                //     container.innerHTML = `
                //         <h3>Общая информация</h3>
                //         <div class="container-info"><p>Начало рабочего дня:</p><span>${formatDate(startWorkDay)}</span></div>
                //         <div class="container-info"><p>Конец рабочего дня:</p><span>${formatDate(endWorkDay)}</span></div>
                //         <div class="container-info"><p>Продолжительность смены:</p><span>${getTimeDifference(startWorkDay, endWorkDay)}</span></div>
                //         <div class="container-info"><p>Средний процент результативности:</p><span>-</span></div>
                //     `;

                //     if (Object.keys(objAllDetails).length > 0) {
                //         container.innerHTML += `<h5>Изготовленные детали:</h5>`;
                //         Object.values(objAllDetails).forEach(detail => {
                //             container.innerHTML += `
                //                 <div class="container-info">
                //                     <p>${detail.detailName}:</p>
                //                     <span>${detail.countDetails} шт.</span>
                //                 </div>
                //             `;
                //         });
                //     }

                //     if (Object.keys(objSetupMachines).length > 0) {
                //         container.innerHTML += `<h5>Настроенные станки:</h5>`;
                //         for (const logSetup of Object.values(objSetupMachines)) {
                //             const machine = await new Promise(resolve => {
                //                 readToFirebase(`${logSetup.machinePath}`, resolve);
                //             });
                //             container.innerHTML += `
                //                 <div class="container-info">
                //                     <p>${machine.name}:</p>
                //                     <span>${logSetup.detail} (${logSetup.install})</br>${logSetup.timeDetail} (${logSetup.timeChangeDetail})</span>
                //                 </div>`;
                //         }
                //     }

                // } else if (typeRange === 'period') {
                //     let arrayWorksDays = [];
                //     let arrayCoefficientsThisPeriod = [];
                //     let objDetailsInThisPeriod = {};

                //     for (const log of Object.values(logsThisRange)) {
                //         if (log.typeLog === 'Конец рабочего дня') {
                //             const logsThisDay = filterAndSortByKeyRange(log.startWorkDay, log.endWorkDay, logsThisRange);
                //             arrayWorksDays.push(Number(log.endWorkDay) - Number(log.startWorkDay));

                //             let objDetailsInThisDay = {};
                //             let arrayCoefficientsThisDay = [];

                //             for (const logThisDay of Object.values(logsThisDay)) {
                //                 if (logThisDay.typeLog === 'Производство') {
                //                     // Добавляем в данные за день
                //                     if (!objDetailsInThisDay[`${logThisDay.detailSystemName}${logThisDay.install}`]) {
                //                         objDetailsInThisDay[`${logThisDay.detailSystemName}${logThisDay.install}`] = {
                //                             detailName: `${logThisDay.detail} (${logThisDay.install})`,
                //                             countDetails: 0
                //                         };
                //                     }
                //                     objDetailsInThisDay[`${logThisDay.detailSystemName}${logThisDay.install}`].countDetails += Number(logThisDay.countDetails);

                //                     // Добавляем в данные за период
                //                     if (!objDetailsInThisPeriod[`${logThisDay.detailSystemName}${logThisDay.install}`]) {
                //                         objDetailsInThisPeriod[`${logThisDay.detailSystemName}${logThisDay.install}`] = {
                //                             detailName: `${logThisDay.detail} (${logThisDay.install})`,
                //                             countDetails: 0
                //                         };
                //                     }
                //                     objDetailsInThisPeriod[`${logThisDay.detailSystemName}${logThisDay.install}`].countDetails += Number(logThisDay.countDetails);

                //                     // Расчёт коэффициента производительности
                //                     const machineTime = Number(logThisDay.countDetails) * (minSecToSeconds(logThisDay.timeDetail) + minSecToSeconds(logThisDay.timeChangeDetail));
                //                     const timer = (Number(logThisDay.endTime) - Number(logThisDay.startTime)) / 1000;
                //                     const res = (machineTime / timer) * 100;
                //                     arrayCoefficientsThisDay.push(Number(res.toFixed(2)));
                //                 }
                //             }

                //             // Подготовка описания деталей
                //             let descriptionDetails = '';
                //             Object.values(objDetailsInThisDay).forEach(detail => {
                //                 descriptionDetails += `${detail.detailName}: ${detail.countDetails} шт.<br/>`;
                //             });

                //             const shiftTime = log.endWorkDay - log.startWorkDay;
                //             const dateLabel = getNumberAndMountForDateNow(log.endWorkDay);
                //             const shiftDuration = getTimeDifference(log.startWorkDay, log.endWorkDay);
                //             const averageProcent = Math.round(calculateAverage(arrayCoefficientsThisDay));

                //             actualDataForChartTime.push({
                //                 value: shiftTime,
                //                 name: `${dateLabel}\n(${shiftDuration})`,
                //                 title: `${dateLabel}\n(${shiftDuration})`,
                //                 description: `
                //                     Начало смены: ${formatDate(log.startWorkDay)}</br>
                //                     Конец смены: ${formatDate(log.endWorkDay)}</br>
                //                     Продолжительность смены: ${shiftDuration}</br>
                //                     Процент результативности: ${averageProcent}%</br>
                //                     Изготовленные детали: </br>
                //                     ${descriptionDetails}
                //                 `
                //             });

                //             let countAllsDetailInThisDay = Object.values(objDetailsInThisDay)
                //                 .reduce((sum, detail) => sum + detail.countDetails, 0);

                //             actualDataForChartCountDetails.push({
                //                 value: countAllsDetailInThisDay,
                //                 name: `${dateLabel}\n(${countAllsDetailInThisDay} шт.)`,
                //                 title: `${dateLabel}\n(${countAllsDetailInThisDay} шт.)`,
                //                 description: `
                //                     Начало смены: ${formatDate(log.startWorkDay)}</br>
                //                     Конец смены: ${formatDate(log.endWorkDay)}</br>
                //                     Продолжительность смены: ${shiftDuration}</br>
                //                     Процент результативности: ${averageProcent}%</br>
                //                     Изготовленные детали: </br>
                //                     ${descriptionDetails}
                //                 `
                //             });

                //             actualDataForChartProcent.push({
                //                 value: countAllsDetailInThisDay,
                //                 name: `${dateLabel}\n(${averageProcent}%)`,
                //                 title: `${dateLabel}\n(${averageProcent}%)`,
                //                 description: `
                //                     Начало смены: ${formatDate(log.startWorkDay)}</br>
                //                     Конец смены: ${formatDate(log.endWorkDay)}</br>
                //                     Продолжительность смены: ${shiftDuration}</br>
                //                     Процент результативности: ${averageProcent}%</br>
                //                     Изготовленные детали: </br>
                //                     ${descriptionDetails}
                //                 `
                //             });

                //             arrayCoefficientsThisPeriod.push(averageProcent);
                //         }
                //     }

                //     // Отрисовка общей информации
                //     const container = document.querySelector(`#containerGeneralInformationAllertChart`);
                //     document.querySelector(`#h2TitleDateAllertDetailInformation`).textContent =
                //         `${formatedDate(Number(startRange))} - ${formatedDate(Number(endRange))}`;
                    
                //     container.innerHTML = `
                //         <h3>Общая информация</h3>
                //         <div class="container-info"><p>Количество смен:</p><span>${arrayWorksDays.length}</span></div>
                //         <div class="container-info"><p>Средняя продолжительность смены:</p><span>${secondsToTimeFormat(calculateAverage(arrayWorksDays) / 1000)}</span></div>
                //         <div class="container-info"><p>Общее количество часов:</p><span>${secondsToTimeFormat(arrayWorksDays.reduce((sum, val) => sum + val, 0) / 1000)}</span></div>
                //         <div class="container-info"><p>Средний процент успешности:</p><span>${Math.round(calculateAverage(arrayCoefficientsThisPeriod))}%</span></div>
                //         <h5>Изготовленные детали:</h5>
                //     `;

                //     Object.values(objDetailsInThisPeriod).forEach(detail => {
                //         container.innerHTML += `
                //             <div class="container-info">
                //                 <p>${detail.detailName}:</p>
                //                 <span>${detail.countDetails} шт.</span>
                //             </div>
                //         `;
                //     });
                // }


            // Получение информации о работнике
            const workerFio = await asyncReadToFirebase(`workers/${systemName}/fio`);

            document.querySelector(`#h2TitleNameAllertDetailInformation`).textContent = workerFio;
        }

        // Отображение графика
        document.querySelector(`#allertDetailInformationChart`).classList.remove('display-none');

        actualTypeChart = 'line';
        actualTypeDataChart = 'time';
        printChartToDetailInformation(actualDataForChartTime, actualTypeChart, 'Время работы');

        changeTypeDataInDetailInformationChart(`time`);
        changeTypeChartInDetailInformationChart(`line`);
        closeAllertDownload();
    }
    
    async function clickSearchDetailsInDetailsPanel(){
        openAllertDownload();
        const inputSearch = document.querySelector(`#inputSearchDetailInTableDetailsPanel`);
        const searchText = transliterate(inputSearch.value.trim());
        if(searchText != ''){
            const details = await searchByKeyInFirebase(`details`, searchText);
            
            if(details){
                const bodyTable = document.querySelector(`#tb-details-table`);
                bodyTable.innerHTML = '';
                Object.entries(details).forEach(([key, detail]) => {
                    bodyTable.innerHTML += `
                        <tr style="cursor: pointer;" onclick="openAllertReductDetail('${key}')"> 
                            <td>${detail.name}</td>    
                            <td>${detail.nameDraw}</td>    
                            <td>${detail.countInstalls}</td>
                            <td style="text-align: center;"><i onclick="openAllertConfirmDelete('detail','${key}', '')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>  
                        </tr>
                    `;
                });
                document.querySelector(`#details-panel .navigation-menu-table button`).onclick = function() {};
                const countDetails = Object.keys(details).length;
                document.querySelector(`#details-panel .navigation-menu-table h5`).textContent = `Загружено ${countDetails} из ${countDetails}`;
            }
        }    
        closeAllertDownload();
    }

    async function clickReductWorkDayForWorker(workerSystemName, workerFio, startDay, endDay) {
        closeAllAllerts();
        openAllertDownload();

        const formatForDatetimeLocal = timestamp => {
            const date = new Date(timestamp);
            const pad = num => String(num).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        };
        
        const log = await asyncReadFirebaseByKeyRange(`logs/workers/${workerSystemName}/workdays`, startDay, endDay);
        if(log){
            const [key, logEntry] = Object.entries(log)[0];
            document.querySelector(`#inputDateStartWorkDayForAllertReductWorkDay`).value = formatForDatetimeLocal(logEntry.startWorkDay);
            document.querySelector(`#inputDateEndWorkDayForAllertReductWorkDay`).value = formatForDatetimeLocal(logEntry.endWorkDay);

            document.querySelector(`#allertReductWorkDay button`).onclick = function (){
                clickConfirmReductWorkDayForWorker(workerSystemName, key);
            }
        } else {
            document.querySelector(`#inputDateStartWorkDayForAllertReductWorkDay`).value = '';
            document.querySelector(`#inputDateEndWorkDayForAllertReductWorkDay`).value = '';
            document.querySelector(`#allertReductWorkDay button`).onclick = function (){
                clickConfirmReductWorkDayForWorker(workerSystemName, '');
            }
        }

        document.querySelector(`#spanWorkerNameForAllertReductWorkDay`).textContent = formatName(workerFio);
        
        document.querySelector(`#allertReductWorkDay`).classList.remove('display-none');
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        
        closeAllertDownload();
    }

    async function clickConfirmReductWorkDayForWorker(workerSystemName, logKey){
        const inputStartWorkDay = document.querySelector(`#inputDateStartWorkDayForAllertReductWorkDay`);
        const inputEndWorkDay = document.querySelector(`#inputDateEndWorkDayForAllertReductWorkDay`);
        if(inputStartWorkDay.value != '' && inputEndWorkDay.value != ''){
            openAllertDownload();
            const startWorkDay = new Date(inputStartWorkDay.value).getTime();
            const endWorkDay = new Date(inputEndWorkDay.value).getTime();

            const objLog = {
                endWorkDay: endWorkDay,
                startWorkDay: startWorkDay,
                typeLog:"Конец рабочего дня"
            }

            if(logKey != ''){
                await asyncOverwriteToFirebase(`logs/workers/${workerSystemName}/workdays/${logKey}`, {});
            }

            await asyncWriteToFirebase(`logs/workers/${workerSystemName}/workdays/${endWorkDay}`, objLog);

            closeAllertDownload();
            closeAllAllerts();
        } else {
            console.log(`Заполните поля`);
        }
    }
    
    function closeAllertReductWorkDayForWorker(){
        document.querySelector(`#allertReductWorkDay`).classList.remove('display-none');
        document.querySelector(`#allertStatWorkersTwoWeen`).classList.remove('display-none');
    }

    async function protectLoginPass(){
        const loginInput = document.querySelector(`#login`);
        const passInput = document.querySelector(`#password`);

        const authObj = await asyncReadToFirebase(`auth`);
        
        if(loginInput.value == authObj.login && passInput.value == authObj.pass){
            document.querySelector(`#formAuth`).classList.add('display-none');
            localStorage.setItem('loginDate', new Date().toISOString().split('T')[0]);
            selectPanel('workers-panel');
        } else {
            alert('Неправильный логин или пароль!');
        }
    }

    async function openAllertStatWorkerYear(workerSystemName, timeStamp){
        openAllertDownload();
        closeAllAllerts();

        const h5 = document.querySelectorAll(`#allertDetailInformationYearForWorker h5`);
        const spanArray = document.querySelectorAll(`#allertDetailInformationYearForWorker span`);
        const buttonsArray = document.querySelectorAll(`#allertDetailInformationYearForWorker button`);

        const yearObj = getYearBounds(timeStamp);
        h5.textContent = `Статистика за ${new Date(timeStamp).getFullYear()}`;
        
        const hospitalLogs = await asyncReadFirebaseByKeyRange(`logs/workers/${workerSystemName}/hospital`, yearObj.startOfYear, yearObj.endOfYear);
        const vacationLogs = await asyncReadFirebaseByKeyRange(`logs/workers/${workerSystemName}/vacation`, yearObj.startOfYear, yearObj.endOfYear);
        const workdaysLogs = await asyncReadFirebaseByKeyRange(`logs/workers/${workerSystemName}/workdays`, yearObj.startOfYear, yearObj.endOfYear);

        if(vacationLogs){
            spanArray[0].textContent = `${Object.values(vacationLogs).length} дней`;
        } else {
            spanArray[0].textContent = `0 дней`;
        }
        
        if(hospitalLogs){
            spanArray[1].textContent = `${Object.values(hospitalLogs).length} дней`;
        } else {
            spanArray[1].textContent = `0 дней`;
        }

        if(workdaysLogs){
            spanArray[2].textContent = `${Object.values(workdaysLogs).length} смен`;
        } else {
            spanArray[2].textContent = `0 смен`;
        }

        buttonsArray[0].onclick = function(){
            console.log(`Вот список отпусков: ${JSON.stringify(vacationLogs)}`);
        }

        buttonsArray[1].onclick = function(){
            console.log(`Вот список отпусков: ${JSON.stringify(hospitalLogs)}`);
        }

        buttonsArray[2].onclick = function(){
            closeAllAllerts();
            openAllert(`allertMountPanelForDetailInformation`);
        };

        openAllert(`allertDetailInformationYearForWorker`);
        closeAllertDownload();
    }


    // какая статистика можеть быть полезна по человеку за целый год: 
    // количество смен, больничных и отпускных, общее время работы, количество смен, количество деталей сделаных.
    // очень долго будет обрабатываться придумать как это сделать побыстрее
    // придумать как это нормально оформить что бы было удобно и приятно пользоваться
    // план работы на следующую неделю
    // переделать что бы логи были по категориям
    // сделать что бы была возможность назначать отпускные и больничные
    // сделать вход в аминку по логину и паролю
    // сделать график для рабочих
    // придумать какой-то график для составления графика, узнать какой принцип составления

    
    // добавить склад деталей в админку
    // добавить какую-то панельку заказы или что-то подобное

</script>
</body>
</html>
