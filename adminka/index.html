<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css" type="text/css">
    <title>Админ панель</title>
    <link rel="shortcut icon" href="#">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/imask"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="../functions.js"></script>
</head>
<body> 
    <div class="leftColumn">
        <header><h5>Админ меню</h5></header>
        <div class="main-part">
            <div onclick="selectPanel('workers-panel')" class="item">
                <i class="fa-solid fa-user-secret"></i>
                <p>Работники</p>
            </div>
            <div onclick="selectPanel('machines-panel')" class="item">
                <i class="fa-solid fa-robot"></i>
                <p>Станки</p>
            </div>
            <div onclick="selectPanel('details-panel')" class="item">
                <i class="fa-solid fa-gears"></i>
                <p>Детали</p>
            </div>
            <!-- <div onclick="selectPanel('orders-panel')" class="item">
                <i class="fa-solid fa-file-invoice"></i>
                <p>Заказы</p>
            </div> -->
        </div>
    </div>
    <div></div>
    <div class="centerColumn">
        <header></header>
        <div class="title-div">
            <h2 id="h2TitlePanel"></h2>
            <i id="iconStatWorkersTwoWeek" style="color: #777; font-size: 24px; cursor: pointer;" class="fas fa-chart-line" onclick="printStatWorkersTwoWeek()"></i>
        </div>
        <div class="main-part">
            <div id="workers-panel" class="display-none">
                <div class="div-white-bg">
                    <input oninput="searchWorkerInTable()" id="inputSearchFioWorker" placeholder="Введите ФИО человек для поиска..." type="text">
                </div>
                <div class="div-white-bg">
                    <table>
                        <thead>
                            <tr>
                                <th>ФИО</th>
                                <th>Статус</th>
                                <th>Рабочие места</th>
                                <th>Начало рабочей смены</th>
                                <th style="text-align: center;">Инфо</th>
                                <th style="text-align: center;">Удалить</th>
                            </tr>
                        </thead>
                        <tbody id="tb-workers-table" style="max-height: 400px; overflow-y: auto;">
                            <tr><td colspan="5">Нет данных</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="div-white-bg">
                    <h2>Добавление нового работника</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением нового человека</h5>
                        </div>
                        <div class="container-form">
                            <h5>ФИО Человека</h5>
                            <input id="inputNameAddNewWorker" type="text">
                            <h5>Должность человека</h5>
                            <select id="selectRoleAddNewWorker">
                                <option value="">Выберите должность человека</option>
                                <option value="operator">Оператор</option>
                                <option value="naladchik">Наладчик</option>
                            </select>
                            <h5>Фото человека для входа в систему</h5>
                            <input id="inputPhotoAddNewWorker" type="file" accept="image/*">
                            <p id="pErrorAddNewWorker" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля.</p>
                            <button onclick="addNewWorker()">Добавить</button>
                        </div>
                    </div>
                </div>
                <div class="div-white-bg">
                    <h2>Добавление новой должности</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением новой должности</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название должности</h5>
                            <input id="inputNameNewRole" type="text">
                            <h5>Выберите уровни доступа</h5>
                            <div class="container-checkbox-add-role">
                                <input id="cbWorkInMachine" type="checkbox">
                                <p>Работать на станках</p>
                            </div>
                            <div class="container-checkbox-add-role">
                                <input id="cbSetupMachine" type="checkbox">
                                <p>Настраивать станки</p>
                            </div>
                            <p id="pErrorAddNewRole" style="margin-bottom: 12px !important;" class="p-error display-none"></p>
                            <button onclick="addNewRole()">Добавить</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="machines-panel">
                <div id="containerTablesMachines"></div>
                <div class="div-white-bg">
                    <h2>Добавление нового станка</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением нового станка</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название станка</h5>
                            <input id="inputNameNewMachine" type="text">
                            <h5>Тип станка</h5>
                            <select id="selectTypesMachinesForAddMachine">
                                <option value="">Выберите тип станка</option>
                            </select>
                            <p id="pErrorAddNewMachine" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля</p>
                            <button onclick="addNewMachine()">Добавить</button>
                        </div>
                    </div>
                </div>
                <div class="div-white-bg">
                    <h2>Добавить новую группу станков</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением новой группы станков</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название новой группы станков</h5>
                            <input id="inputNameNewTypeMachine" type="text">
                            <p id="pErrorTypeMachineAdd" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля</p>
                            <button onclick="addNewMachineGroup()">Добавить</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="details-panel">
                <div class="div-white-bg">
                    <input oninput="searchDetailInTable()" id="inputSearchDetailInTable" placeholder="Введите название детали или чертежа для поиска..." type="text">
                </div>
                <div class="div-white-bg">
                    <h2>Все детали</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Номер чертежа</th>
                                <th>Количество<br/>установок</th>
                                <th style="text-align: center;">Удалить</th>
                            </tr>
                        </thead>
                        <tbody id="tb-details-table" style="max-height: 400px; overflow-y: auto;"> </tbody>
                    </table>
                    <div class="navigation-menu-table">
                        <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                            <button onclick="changePageTableDetails(-1)">Назад</button>
                            <div id="containerButtonsCountRowsTableDetails">
                                <button onclick="changeCountRowsInTableDetails(15)" class="select-button">15</button>
                                <button onclick="changeCountRowsInTableDetails(25)" class="">25</button>
                                <button onclick="changeCountRowsInTableDetails(50)" class="">50</button>
                                <button onclick="changeCountRowsInTableDetails(100)" class="">100</button>
                            </div>
                            <button onclick="changePageTableDetails(1)">Вперед</button>
                        </div>
                        <h5 id="h5NumberPageTableDetails">Страница 1/1</h5>
                    </div>
                </div>
                <div class="div-white-bg">
                    <h2>Добавить новую деталь</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением новой детали</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название новой детали</h5>
                            <input id="inputNameNewDetail" type="text">
                            <h5>Название чертежа детали</h5>
                            <input id="inputNameDrawNewDetail" type="text">
                            <p id="pErrorAddNewDetail" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля</p>
                            <button onclick="addNewDetail()">Добавить</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="orders-panel">
                <div class="div-white-bg">
                    <h2>Актуальные заказы</h2>
                    <div class="order-container">
                        <div class="container" style="margin-bottom: 12px;">
                            <h3>№09212</h3>
                            <div class="container-status">
                                <h3>В работе</h3>
                            </div>
                        </div>
                        <div class="container">
                            <p>Дата приема:</p>
                            <span>05.02.2025</span>
                        </div>
                        <div class="container">
                            <p>Дата сдачи:</p>
                            <span>05.06.2025</span>
                        </div>
                        <div class="container">
                            <p>Заказчик:</p>
                            <span>Тестовый</span>
                        </div>
                        <div class="container">
                            <p>Количество отгрузок:</p>
                            <span>2</span>
                        </div>
                        <h4>Детали:</h4>
                        <div class="container">
                            <p>Наколювач <br>123-321-123</p>
                            <span><span style="color: green;">1200 </span>/ 5000</span>
                        </div>
                        <div class="container">
                            <p>Бобишка <br>123-321-123</p>
                            <span><span style="color: green;">1200 </span>/ 5000</span>
                        </div>
                        <div class="container">
                            <p>Наколювач <br>123-321-123</p>
                            <span><span style="color: green;">1200 </span>/ 5000</span>
                        </div>
                        <div class="container">
                            <p>Наколювач <br>123-321-123</p>
                            <span><span style="color: green;">1200 </span>/ 5000</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div onclick="closeAllAllerts()" id="bg-allert" class="display-none"></div>

    <div id="allertNewSelectDateForWorkerInfo" class="display-none allert-select-dates-for-more-info">
        <div class="container">
            <span class="close-btn" onclick="closeAllAllerts()">&times;</span>
            <h2 style="margin-bottom: 12px;">Выбор периода</h2>
            <p>Для получения дополнительной информации по <b id="bNameSelectedWorkerName"></b><br/><p style="margin-top: 8px;">Выберите период:</p></p>
            <div class="date-filter">
                <input type="date" id="inputStartDateForUserDetailInfo" placeholder="Начальная дата">
                <span>—</span>
                <input type="date" id="inputEndDateForUserDetailInfo" placeholder="Конечная дата">
            </div>
            <button class="show-btn" onclick="showDetailInfoForWorker()">Показать</button>
        </div>
    </div>

    <div id="allertNewSelectDateForMachineInfo" class="display-none allert-select-dates-for-more-info">
        <div class="container">
            <span class="close-btn" onclick="closeAllAllerts()">&times;</span>
            <h2 style="margin-bottom: 12px;">Выбор периода</h2>
            <p>Для получения дополнительной информации по <b id="bNameSelectedMachineName"></b><br/><p style="margin-top: 8px;">Выберите период:</p></p>
            <div class="date-filter">
                <input type="date" id="inputStartDateForMachineDetailInfo" placeholder="Начальная дата">
                <span>—</span>
                <input type="date" id="inputEndDateForMachineDetailInfo" placeholder="Конечная дата">
            </div>
            <button class="show-btn" onclick="showDetailInfoForMachine()">Показать</button>
        </div>
    </div>

    <div id="allertDetailInformationForWorker" class="alert-window display-none allertMountPanel">
        <div class="container-name">
            <div style="display: flex; align-items: center;">
                <h2 id="h2WorkerNameForDetailInformation" style=" margin-right: 12px;"></h2>
            </div>
            <div style="display: flex; align-items: center;">
                <i onclick="openAllertDetailInformationForWorkerPeriod()" style="color: #777; margin-right: 12px; cursor: pointer;" class="fas fa-chart-line"></i>
                <h2 id="h2RangeDatesSelectedWorkerDetailInformation"></h2>
            </div>
        </div>
        <div class="container">
            <div>
                <i style="cursor: pointer;" onclick="changeMounthDetailInformationWorker('back')" class="fa fa-chevron-left"></i>
            </div>
            <div>
                <div class="container-name-mounth">
                    <h3 id="h3SelectedYearForDetailInformationWorker"></h3>
                    <div style="display: flex; align-items: center;">
                        <h3 id="h3SelectedMounthUaForDetailInformationWorker"></h3>
                        <i style="color: #777; margin-left: 12px; cursor: pointer;" class="fas fa-chart-line" onclick="openAllertDetailInFormationForWorkerMounth()"></i>
                    </div>
                    <h3 id="h3SelectedMounthRuForDetailInformationWorker"></h3>
                </div>
                <div class="container-days-name">
                    <p>Понедельник</p>
                    <p>Вторник</p>
                    <p>Среда</p>
                    <p>Четверг</p>
                    <p>Пятница</p>
                    <p>Суббота</p>
                    <p>Воскресенье</p>
                </div>
                <div id="containerDatesCalendar" class="container-dates"></div>
            </div>
            <div>
                <i style="cursor: pointer;" onclick="changeMounthDetailInformationWorker('next')" class="fa fa-chevron-right"></i>
            </div>
        </div>
    </div>

    <div id="allertDetailInformationForMachine" class="alert-window display-none allertMountPanel">
        <div class="container-name">
            <div style="display: flex; align-items: center;">
                <h2 id="h2MachineNameForDetailInformation" style=" margin-right: 12px;"></h2>
            </div>
            <div style="display: flex; align-items: center;">
                <i onclick="openAllertDetailInFormationForMachinePeriod()" style="color: #777; margin-right: 12px; cursor: pointer;" class="fas fa-chart-line"></i>
                <h2 id="h2RangeDatesSelectedMachineDetailInformation"></h2>
            </div>
        </div>
        <div class="container">
            <div>
                <i style="cursor: pointer;" onclick="changeMounthDetailInformationMachine('back')" class="fa fa-chevron-left"></i>
            </div>
            <div>
                <div class="container-name-mounth">
                    <h3 id="h3SelectedYearForDetailInformationMachine"></h3>
                    <div style="display: flex; align-items: center;">
                        <h3 id="h3SelectedMounthUaForDetailInformationMachine"></h3>
                        <i style="color: #777; margin-left: 12px; cursor: pointer;" class="fas fa-chart-line" onclick="openAllertDetailInFormationForMachineMounth()"></i>
                    </div>
                    <h3 id="h3SelectedMounthRuForDetailInformationMachine"></h3>
                </div>
                <div class="container-days-name">
                    <p>Понедельник</p>
                    <p>Вторник</p>
                    <p>Среда</p>
                    <p>Четверг</p>
                    <p>Пятница</p>
                    <p>Суббота</p>
                    <p>Воскресенье</p>
                </div>
                <div id="containerDatesCalendarMachine" class="container-dates"></div>
            </div>
            <div>
                <i style="cursor: pointer;" onclick="changeMounthDetailInformationMachine('next')" class="fa fa-chevron-right"></i>
            </div>
        </div>
    </div>

    <div id="allertDetailInFormationForWorkerDay" class="alert-window display-none allert-diagrams">
        <div class="diagrams-part">
            <div class="title-container">
                <h2 id="h2NameWorkerDetailInformationForWorkerDay"></h2>
                <h2 id="h2DateDetailInformationForWorkerDay"></h2>
            </div>
            <div onclick="changeInformationToGeneralForWorkerDetailsInformationDays()" id="containerDiagramsForDetailInformationWorkerDay" class="container-diagrams"> </div>
        </div>
        <div class="info-part">
            <div style="max-height: 340px; overflow-y: auto;">
                <div id="containerMachineInformationForDayForWorkerDetailInformation" class="display-none"> </div> 
                <div id="containerGeneralInformationForDayForWorkerDetailInformation"> </div> 
            </div>
            <div onclick="closeAllertForDetailsInformationForWorkerForWorkDay()" style="cursor: pointer;" class="button-close">Закрыть</div>  
        </div>
    </div>

    <div id="allertDetailInFormationForMachineDay" class="alert-window display-none allert-diagrams">
        <div class="diagrams-part">
            <div class="title-container">
                <h2 id="h2NameMachineDetailInformationForMachineDay"></h2>
                <h2 id="h2DateDetailInformationForMachineDay"></h2>
            </div>
            <div onclick="changeInformationToGeneralForMachineDetailsInformationDays()" id="containerDiagramsForDetailInformationMachineDay" class="container-diagrams"> </div>
        </div>
        <div class="info-part">
            <div style="max-height: 340px; overflow-y: auto;">
                <div id="containerMachineInformationForDayForMachineDetailInformation" class="display-none"> </div> 
                <div id="containerGeneralInformationForDayForMachineDetailInformation"> </div> 
            </div>
            <div onclick="closeAllertForDetailsInformationForMachineForWorkDay()" style="cursor: pointer;" class="button-close">Закрыть</div>  
        </div>
    </div>

    <div id="allertDetailInformationForWorkerMounth" class="alert-window display-none allert-diagrams">
        <div class="diagrams-part">
            <div class="title-container">
                <h2 id="h2NameWorkerDetailInformationForMounth"></h2>
                <h2 id="h2DateDetailInformationForMounth"></h2>
            </div>
            <div onclick="changeInfirmationToGeneralForWorkerDetailsInFOrmationMounth()" id="containerDiagramsForDetailInformationMounthWorker" class="container-diagrams"> </div>
        </div>
        <div class="info-part">
            <div style="max-height: 320px; overflow-y: auto;">
                <div id="containerDayInformationForMounthForWorkerDetailInformation" class="display-none"> </div>
                <div id="containerGeneralInformationForMounthForWorkerDetailInformation"> </div> 
            </div>
            <div onclick="closeAllertForDetailsInformationForWorkerForMounth()" class="button-close">Закрыть</div>  
        </div>
    </div>

    <div id="allertDetailInformationForMachineMounth" class="alert-window display-none allert-diagrams">
        <div class="diagrams-part">
            <div class="title-container">
                <h2 id="h2NameMachineDetailInformationForMounth"></h2>
                <h2 id="h2DateDetailInformationForMounthMachine"></h2>
            </div>
            <div onclick="changeInformationToGeneralForMachineDetailsInFormationMounth()" id="containerDiagramsForDetailInformationMounthMachine" class="container-diagrams"> </div>
        </div>
        <div class="info-part">
            <div style="max-height: 320px; overflow-y: auto;">
                <div id="containerDayInformationForMounthForMachineDetailInformation" class="display-none"> </div>
                <div id="containerGeneralInformationForMounthForMachineDetailInformation"> </div> 
            </div>
            <div onclick="closeAllertForDetailsInformationForMachineForMounth()" class="button-close">Закрыть</div>  
        </div>
    </div>

    <div id="allertDetailInformationForWorkerPeriod" class="alert-window display-none allert-diagrams">
        <div class="diagrams-part">
            <div class="title-container">
                <h2 id="h2NameWorkerDetailInformationForPeriod"></h2>
                <h2 style="text-align: end;" id="h2DateDetailInformationForPeriod"></h2>
            </div>
            <div onclick="changeInfirmationToGeneralForWorkerDetailsInformationPeriod()" id="containerDiagramsForDetailInformationPeriodWorker" class="container-diagrams"> </div>
        </div>
        <div class="info-part">
            <div style="max-height: 350px; overflow-y: auto;">
                <div id="containerDayInformationForPeriodForWorkerDetailInformation" class="display-none"> </div> 
                <div id="containerGeneralInformationForPeriodForWorkerDetailInformation"> </div> 
            </div>
            <div onclick="closeAllertForDetailsInformationForWorkerForPeriod()" class="button-close">Закрыть</div>  
        </div>
    </div>

    <div id="allertDetailInformationForMachinePeriod" class="alert-window display-none allert-diagrams">
        <div class="diagrams-part">
            <div class="title-container">
                <h2 id="h2NameMachineDetailInformationForPeriod"></h2>
                <h2 style="text-align: end;" id="h2DateDetailInformationForPeriodMachine"></h2>
            </div>
            <div onclick="changeInformationToGeneralForMachineDetailsInFormationPeriod()" id="containerDiagramsForDetailInformationPeriodMachine" class="container-diagrams"> </div>
        </div>
        <div class="info-part">
            <div style="max-height: 350px; overflow-y: auto;">
                <div id="containerDayInformationForPeriodForMachineDetailInformation" class="display-none"> </div> 
                <div id="containerGeneralInformationForPeriodForMachineDetailInformation"> </div> 
            </div>
            <div onclick="closeAllertForDetailsInformationForMachineForPeriod()" class="button-close">Закрыть</div>  
        </div>
    </div>

    <div id="allertCalculateSalary" class="alert-window display-none" style="width: 300px;">
        <h3 style="text-align: center;">Расчитать ЗП</h3>
        <div class="container">
            <p>Количество часов:</p>
            <span id="spanCountHoursForAllertSalary"></span>
        </div>
        <div class="container">
            <p>Отнять время на обед</p>
            <input onclick="calculateSumSalary()" id="checkboxMinusTimeObed" type="checkbox">
        </div>
        <div class="container">
            <p>Отнять время на переодевачку</p>
            <input onclick="calculateSumSalary()" id="checkboxMinusTimePereodevachka" type="checkbox">
        </div>
        <input oninput="calculateSumSalary()" type="number" style="text-align: center;" id="inputSumHoursForCalculateSalary" placeholder="Введите почасовую ставку в грн...">
        <div class="container">
            <p>Итого часов работы:</p>
            <span id="spanCountHoursForCalculateSalary"></span>
        </div>
        <div class="container">
            <p>Итого ЗП:</p>
            <span id="spanResSumSalary"> грн</span>
        </div>
        <button onclick="closeAllertCalculatesalary()">Закрыть</button>
        <!-- Какая информация может быть полезна в этом окне? -->
        <!-- Количество часов, Отминусовывать время на обед, Отминусовывать время на передевачку -->
    </div>

    <div id="rotateAlert" class="rotate-alert">
        <div class="rotate-content">
            <i class="fas fa-sync-alt"></i>
            <h2>Поверните устройство</h2>
            <p>Для корректной работы приложения используйте горизонтальное положение экрана.</p>
        </div>
    </div>

    <div id="allertConfirmDelete" class="display-none">
        <h5>Подтвердить удаление?</h5>
        <button onclick="clickConfirmAllertDelete()">Подтвердить</button>
    </div>

    <div id="allertStatWorkersTwoWeen" class="alert-window display-none">
        <h2>Статистика за последние 2 недели</h2>
        <input oninput="searchWorkerInTableTwoWeekStat()" id="inputSearchWorkerInStatTwoWeek" placeholder="Введите ФИО человек для поиска..." type="text" style="margin: 16px 0px;">
        <table>
            <thead id="tHeadTableStatWorkersTwoWeek"></thead>
            <tbody id="tbodyTableStatWorkersTwoWeek" style="max-height: 400px; overflow-y: auto;"></tbody>
        </table>

    </div>
    <div id="allertReductDetail" class="allert display-none">
        <h2 id="h2DetailNameForReductDetail"></h2>
        <h5 id="h5NameDrawDetailForReructDetail"></h5>
        <h5 id="h5CountInstallsDetailForReductDetail" style="padding-bottom: 6px; margin-bottom: 12px; border-bottom: 1px solid #e4e9f3;"></h5>
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>Название установки</th>
                    <th>Тип станков</th>
                    <th style="text-align: center;">Удалить</th>
                </tr>
            </thead>
            <tbody id="bodyDetailInstallsForReduct"> </tbody>
        </table>
        <div style="display: flex; margin-top: 12px; justify-content: center;">
            <div class="div-description">
                <p>Тут можно поставить какое-то уведомление связанно с добавлением новой детали</p>
            </div>
            <div class="container-form">
                <h5>Название установки</h5>
                <input id="inputNewInstallNameForDetail" type="text" placeholder="Название новой установки">
                <h5>Выберите группу станков</h5>
                <select id="selectTypesMachinesForReductDetail">
                    <option value="">Выберите тип станков</option>
                </select>
                <p class="p-error display-none" id="pErrorAddNewInstallForDetail" style="margin-bottom: 6px !important;"></p>
                <button>Добавить</button>
            </div>
        </div>
    </div>

    <div id="bgDownloadSpinner" class="display-none"></div>
    <div id="downloadSpinner" class="display-none"></div>
<script>
    selectPanel('workers-panel');

    const apiLink = `https://vps-api.ngrok.dev`;

    let selectedWorkerForGetMoreInfo = '';
    let selectedDetailForGetMoreInfo = '';
    let selectedPathMachineForGetMoreInfo = '';

    let workerObjForDetailInformation = {};
    let workerLogsForDetailInformation = [];
    
    let machineObjForDetailInformation = {};
    let machineLogsForDetailInformation = [];
    
    let arraySelectedMounthsForDetailInformation = [];
    let indexSelectedMountForDetailInformation = 0;

    let countSecondsTimeForCalculateSalary = 0;
    let countDaysForCalculateSalary = 0;
    let selectorLastAllert = ``;

    let startSelectPeriodForDetailInformationWorker = 0;
    let endSelectPeriodForDetailInformationWorker = 0;

    let startSelectPeriodForDetailInformationMachine = 0;
    let endSelectPeriodForDetailInformationMachine = 0;

    let typeOperationForDelete = '';
    let nameForDelete = '';
    let typeFordelete = '';

    let countRowsInTableDetail = 15;
    let numberPageTableDetail = 1;


    function selectPanel(selectedPanel) {
        const listPanels = ['workers-panel', 'machines-panel', 'details-panel', `orders-panel`];
        listPanels.forEach(panel => {
            document.querySelector(`#${panel}`).classList.add('display-none');
        });

        if(selectedPanel == 'workers-panel'){
            document.querySelector(`#iconStatWorkersTwoWeek`).classList.remove('display-none');
            printWorkersPanel();
        } else if(selectedPanel == 'machines-panel'){
            document.querySelector(`#iconStatWorkersTwoWeek`).classList.add('display-none');
            printMachinesPanel();
        } else if(selectedPanel == 'details-panel'){
            document.querySelector(`#iconStatWorkersTwoWeek`).classList.add('display-none');
            printDetailsPanel();
        } else if(selectedPanel == `orders-panel`){
            document.querySelector(`#iconStatWorkersTwoWeek`).classList.add('display-none');
            printOrdersPanel();
        }
    }

    function printWorkersPanel(){
        openAllertDownload();
        document.querySelector('#h2TitlePanel').textContent = `Работники`;
        document.querySelector('#workers-panel').classList.remove('display-none');
        printTableWorkersPanel();
        printSelectRoleWorker();

        function printTableWorkersPanel(){
            const bodyTableWorkers = document.querySelector(`#tb-workers-table`);
            listenToFirebase(`workers`, data => {
                if(!data){
                    bodyTableWorkers.innerHTML = `<tr><td colspan='6'>Нет данных</td></tr>`;
                    closeAllertDownload();
                    return;
                }

                bodyTableWorkers.innerHTML = '';
                const timeNow = Date.now();

                Object.entries(data).forEach(([key, worker]) => {
                    const statusClass = worker.status === "На работе" ? "green-allocation" : "";
                    const time = formatDate(worker.dateActualyWorkDay);
                    let actualyPlaces = '-';
                    let workerDateActualyWorkDay = '-';

                    if (worker.dateActualyWorkDay && !isNaN(new Date(worker.dateActualyWorkDay).getTime())) {
                        workerDateActualyWorkDay = formatDate(Number(worker.dateActualyWorkDay));
                    }

                    if(worker.status == `На работе`){
                        try{
                            actualyPlaces = '';
                            Object.values(worker.actualyLogs).forEach(log => {
                                actualyPlaces += `${log.machine} -> ${log.detail} -> ${log.install} <br/><br/>`;
                            });
                        } catch (e){
                            actualyPlaces = '-';
                        }
                    }

                    bodyTableWorkers.innerHTML += `
                        <tr class="${statusClass}">
                            <td>${worker.fio}</td>
                            <td>${worker.status}</td>
                            <td>${actualyPlaces}</td>
                            <td>${workerDateActualyWorkDay}</td>
                            <td style="text-align: center;"><i style="cursor: pointer;" onclick="clickMoreInfoForWorker('${transliterate(worker.fio)}')" class="fas fa-info-circle"></i></td>
                            <td style="text-align: center;"><i onclick="openAllertConfirmDelete('worker','${key}', '-')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>
                        </tr>
                    `;
                    closeAllertDownload();
                })
                sortTableByLastName(`tb-workers-table`);
            });
        }
    
        function printSelectRoleWorker(){
            const selectRole = document.querySelector(`#selectRoleAddNewWorker`);
            
            listenToFirebase(`roles`, roles => {
                selectRole.innerHTML = `<option value="">Выберите должность человека</option>`;
                if(roles){
                    Object.entries(roles).forEach(([key, role]) => {
                        selectRole.innerHTML += `<option value="${key}">${role.name}</option>`;
                    });
                }
            });
        }
    }

    function printMachinesPanel(){
        openAllertDownload();
        document.querySelector('#h2TitlePanel').textContent = `Станки`;
        document.querySelector('#machines-panel').classList.remove('display-none');
        printTableMachinePanel();
        printSelectTypesMachines();

        function printTableMachinePanel(){
            const containerTablesMachines = document.querySelector('#containerTablesMachines');
            listenToFirebase('machines', (data) => {
                if (!data) {
                    closeAllertDownload();
                    return;
                }
                
                containerTablesMachines.innerHTML = ''; // Очищаем контейнер перед добавлением
                
                Object.keys(data).forEach(categoryKey => {
                    const category = data[categoryKey];
                    if (!category.name || !category.machines) return;
                    
                    const tableDiv = document.createElement('div');
                    tableDiv.classList.add('div-white-bg');
                    
                    const title = document.createElement('h2');
                    title.textContent = category.name;
                    tableDiv.appendChild(title);
                    
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Название станка</th>
                                <th>Статус</th>
                                <th>Деталь</th>
                                <th>Установка</th>
                                <th>Время установки</th>
                                <th>Оператор</th>
                                <th>Наладчик</th>
                                <th>УП</th>
                                <th>Время работы</th>
                                <th style="text-align: center;">Инфо</th>
                                <th style="text-align: center;">Удалить</th>
                            </tr>
                        </thead>
                    `;
                    
                    const tbody = document.createElement('tbody');
                    Object.keys(category.machines).forEach(machineKey => {
                        const machine = category.machines[machineKey];
                        const row = document.createElement('tr');
                        
                        if (machine.status === 'Занят') {
                            row.classList.add('green-allocation');
                        } else if (machine.status === 'Настройка') {
                            row.classList.add('yellow-table');
                        }
                        
                        let timeWorkThisMachine = `-`;
                        if(getTimeDifference(Date.now(), machine.startTime) != `NaN:NaN`){
                            timeWorkThisMachine = getTimeDifference(Date.now(), machine.startTime);
                        }
                        row.innerHTML = `
                            <td>${machine.name}</td>
                            <td>${machine.status}</td>
                            <td>${machine.detail}</td>
                            <td>${machine.install}</td>
                            <td>${machine.timeDetail}(${machine.timeChangeDetail})</td>
                            <td>${formatName(machine.operator)}</td>
                            <td>${formatName(machine.naladchik)}</td>
                            <td>${machine.nameUp}</td>
                            <td>${timeWorkThisMachine}</td>
                            <td style="text-align: center;"><i onclick="clickDetailInformationMachine('${categoryKey}/machines/${machineKey}')" class="fas fa-info-circle"></i></td>
                            <td style="text-align: center;"><i onclick="openAllertConfirmDelete('machine', '${machine.systemName}', '${machine.typeMachine}')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    table.appendChild(tbody);
                    tableDiv.appendChild(table);
                    containerTablesMachines.appendChild(tableDiv);
                });
                closeAllertDownload();
            });
        }

        function printSelectTypesMachines() {
            const selectTypesMachinesForAddMachine = document.querySelector('#selectTypesMachinesForAddMachine');
            
            listenToFirebase('machines', (data) => {
                let res = '<option value="">Выберите тип станка</option>';
                if (!data) {
                    return;
                }
                Object.entries(data).forEach(([key, value]) => {
                    res += `<option value="${key}">${value.name}</option>`;
                });
                selectTypesMachinesForAddMachine.innerHTML = res;
            });
        }
    }

    async function printDetailsPanel(){
        openAllertDownload();
        document.querySelector('#h2TitlePanel').textContent = `Детали`;
        document.querySelector('#details-panel').classList.remove('display-none');
        
        try {
            const details = await new Promise((resolve, reject) => {
                listenToFirebase('details', data => {
                    if (data === undefined) {
                        reject('Ошибка чтения данных из Firebase');
                    } else {
                        resolve(data);
                    }
                });
            });

            if (!details) {
                document.querySelector('#tb-details-table').innerHTML = `
                    <tr>
                        <td colspan="4">Детали не найдены</td>
                    </tr>
                `;
            } else {
                allDetails = Object.values(details);
                printDetailsInTable();
                closeAllertDownload();
            }

        } catch (error) {
            console.error('Ошибка при загрузке деталей:', error);
            document.querySelector('#tb-details-table').innerHTML = `
                <tr>
                    <td colspan="4">Ошибка загрузки данных</td>
                </tr>
            `;
        }
    }

    function printOrdersPanel(){
        document.querySelector('#h2TitlePanel').textContent = `Заказы`;
        document.querySelector('#orders-panel').classList.remove('display-none');
        // что должен показываться в каждом заказе
        // дата приема заказа, дата когда нужно сдать, перечисление деталей которые есть в спецификации, 
        // прогресс какой-то, количество отгрузок,  когда какие отгрузки, какие детали были в отгрузке и тд и тп 
        
        // от кого заказ
        // номер заказа
        // дата приема заказа
        // дата когда нужно сдать заказ
        // какой-то прогресс заказа
        // количество отгрузок
        // список деталей данного заказа
        // и рядом количество деталей которое уже отгрузили
        // номера накладных отгрузок
        // массив отгрузок что бы можно было посмотреть детальную информацию по отгрузке номер накладной и тд и тп
        // статус в работе, завершен
    }

    function printDetailsInTable(){
        const bodyTableDetails = document.querySelector(`#tb-details-table`);
        bodyTableDetails.innerHTML =  '';
        
        const startNumberDetailPrint = countRowsInTableDetail*numberPageTableDetail-countRowsInTableDetail;
        const endNumberDetailPrint = countRowsInTableDetail*numberPageTableDetail;
        
        document.querySelector(`#h5NumberPageTableDetails`).textContent = `Страница ${numberPageTableDetail}/${Math.ceil(allDetails.length/countRowsInTableDetail)}`

        const filterDetails = allDetails.slice(startNumberDetailPrint, endNumberDetailPrint);
        Object.values(filterDetails).forEach(detail => {
            bodyTableDetails.innerHTML += `
                <tr style="cursor: pointer;" onclick="openAllertReductDetail('${detail.systemName}')"> 
                    <td>${detail.name}</td>    
                    <td>${detail.nameDraw}</td>    
                    <td>${detail.countInstalls}</td>
                    <td style="text-align: center;"><i onclick="openAllertConfirmDelete('detail','${detail.systemName}', '')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>  
                </tr>
            `;
        });
       
    }

    function openAllertReductDetail(detailSystemName){
        console.log(`вібрал деталь`)
        openAllertDownload();
        listenToFirebase(`details/${detailSystemName}`, detail => {
            const bodyDetailInstallsForReduct = document.querySelector(`#bodyDetailInstallsForReduct`);
            bodyDetailInstallsForReduct.innerHTML = '';
            
            if(!detail.installs){
                bodyDetailInstallsForReduct.innerHTML += `
                    <tr>
                        <td colspan=3>Нет установок для данной детали</td>  
                    </tr>
                `;
            } else {
                Object.entries(detail.installs).forEach(([key, install]) => {
                    bodyDetailInstallsForReduct.innerHTML += `
                        <tr>
                            <td>${install.name}</td>    
                            <td>${install.typeMachinesName}</td>   
                            <td style="text-align: center"><i onclick="deleteInstallForDetail(${detail.countInstalls}, '${detailSystemName}', '${detailSystemName}/installs/${key}')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td> 
                        </tr>
                    `;
                });
            }
            
            document.querySelector(`#allertReductDetail`).classList.remove('display-none');
            document.querySelector(`#h2DetailNameForReductDetail`).textContent = `Меню установок для ${detail.name}`;
            document.querySelector(`#h5NameDrawDetailForReructDetail`).textContent = `Чертеж № ${detail.nameDraw}`;
            document.querySelector(`#h5CountInstallsDetailForReductDetail`).textContent = `Кол-во установок: ${detail.countInstalls}`;
            document.querySelector(`#bg-allert`).classList.remove('display-none');

            document.querySelector(`#inputNewInstallNameForDetail`).value = '';
            document.querySelector(`#pErrorAddNewInstallForDetail`).classList.add('display-none');

            readToFirebase(`machines`, machines => {
                const selectorTypeMachine = document.querySelector(`#selectTypesMachinesForReductDetail`);
                selectorTypeMachine.innerHTML = `<option value="">Выберите тип станков</option>`;
                Object.entries(machines).forEach(([key, typeMachines]) => {
                    selectorTypeMachine.innerHTML += `<option value="${key}">${typeMachines.name}</option>`;
                });
            })

            document.querySelector(`#allertReductDetail button`).onclick = function() { addNewInstallForDetail(detailSystemName, detail.countInstalls, `details/${detailSystemName}/installs/${detail.countInstalls}`) };
            closeAllertDownload();
        });
    }

    
    function addNewInstallForDetail(detailSystemName, detailCountInstalls, pathForAddNewInstall){
        const inputNewInstallNameForDetail = document.querySelector(`#inputNewInstallNameForDetail`);
        const selectTypesMachinesForReductDetail = document.querySelector(`#selectTypesMachinesForReductDetail`);
        const pError = document.querySelector(`#pErrorAddNewInstallForDetail`);
        const objNewInstall = {
            name : inputNewInstallNameForDetail.value,
            typeMachinesName : selectTypesMachinesForReductDetail.options[selectTypesMachinesForReductDetail.selectedIndex].textContent,
            typeMachinesSystemName : selectTypesMachinesForReductDetail.value
        };

        if(inputNewInstallNameForDetail.value.length > 2 && selectTypesMachinesForReductDetail.value.length > 0){
            writeToFirebase(pathForAddNewInstall, objNewInstall);
            overwriteToFirebase(`details/${detailSystemName}/countInstalls`, detailCountInstalls+1);
            pError.classList.add('display-none');
            inputNewInstallNameForDetail.value = '';
            selectTypesMachinesForReductDetail.value = '';
        } else {
            pError.classList.remove(`display-none`);
            pError.textContent = `Заполните все поля`;
        }
    }

    function deleteInstallForDetail(countInstallsDetail, detailSystemName, pathInstallForDelete){
        overwriteToFirebase(`details/${pathInstallForDelete}`, {});
        overwriteToFirebase(`details/${detailSystemName}/countInstalls`, countInstallsDetail-1);
    }

    function changePageTableDetails(type){
        if ((type === 1 && numberPageTableDetail < Math.ceil(allDetails.length/countRowsInTableDetail)) ||
            (type === -1 && numberPageTableDetail > 1)) {
            numberPageTableDetail += type;
            printDetailsInTable();
        }
    }

    function changeCountRowsInTableDetails(i){
        if(i != countRowsInTableDetail){
            countRowsInTableDetail = i;
            const buttons = document.querySelectorAll(`#containerButtonsCountRowsTableDetails button`);

            Object.values(buttons).forEach(button => {
                if(button.textContent == countRowsInTableDetail){
                    button.classList.add('select-button');
                } else {
                    button.classList.remove('select-button');
                }
            });

            printDetailsInTable();
        }
    }

    function addNewWorker() {
        const inputNameWorker = document.querySelector('#inputNameAddNewWorker');
        const inputPhotoAddNewWorker = document.querySelector('#inputPhotoAddNewWorker');
        const selectRoleAddNewWorker = document.querySelector('#selectRoleAddNewWorker');
        const pError = document.querySelector(`#pErrorAddNewWorker`);

        if (inputNameWorker.value.length > 4 && selectRoleAddNewWorker.value != '' && inputPhotoAddNewWorker.files[0] && inputNameWorker.value.trim().split(/\s+/).length === 3) {
            
            const path = `workers/${transliterate(inputNameWorker.value)}`;
            const obj = {
                fio: inputNameWorker.value,
                status: 'Нет на работе',
                role: selectRoleAddNewWorker.value,
                dateActualyWorkDay: '',
                actualyLogs: '',
            }

            // Обработка ошибки записи в Firebase
            writeToFirebase(path, obj)
                .then(() => {
                    // Если запись в Firebase прошла успешно, отправляем фото
                    const formData = new FormData();
                    formData.append('name', transliterate(inputNameWorker.value)); 
                    formData.append('image', inputPhotoAddNewWorker.files[0]); 
                    

                    fetch(`${apiLink}/add_image`, {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        inputNameWorker.value = '';
                        selectRoleAddNewWorker.value = '';
                        inputPhotoAddNewWorker.value = '';
                        pError.classList.add(`display-none`);
                        
                    })
                    .catch(error => { // ошибка при отправке фото на api
                     });
                })
                .catch(error => {
                    pError.classList.remove(`display-none`);
                    pError.textContent = 'Человек с таким именем уже зарегистрирован';
            });
            
        } else {
            pError.classList.remove(`display-none`);
            pError.textContent = `Заполните все поля`;
        }
    }

    async function addNewMachineGroup() {
        const inputNameGroup = document.querySelector('#inputNameNewTypeMachine');
        const pError = document.querySelector('#pErrorTypeMachineAdd');

        if (inputNameGroup.value.length > 3) {
            const path = `machines/${transliterate(inputNameGroup.value)}`;
            const obj = {
                name: inputNameGroup.value
            };

            try {
                await writeToFirebase(path, obj);
                inputNameGroup.value = '';
                pError.classList.add('display-none');
            } catch (e) {
                pError.classList.remove('display-none');
                pError.textContent = 'Группа станков с таким именем уже существует';
            }
        } else {
            pError.classList.remove('display-none');
            pError.textContent = 'Введите название для новой группы станков';
        }
    }

    async function addNewMachine(){
        const inputNameNewMachine = document.querySelector('#inputNameNewMachine');
        const selectTypesMachinesForAddMachine = document.querySelector('#selectTypesMachinesForAddMachine');
        const pError = document.querySelector(`#pErrorAddNewMachine`);

        if(inputNameNewMachine.value.length > 3 && selectTypesMachinesForAddMachine.value != ''){
            const path = `machines/${selectTypesMachinesForAddMachine.value}/machines/${transliterate(inputNameNewMachine.value)}`;
            
            const obj = {
                name: inputNameNewMachine.value,
                systemName: transliterate(inputNameNewMachine.value),
                status: 'Выключен',
                detail: '-',
                install: '-',
                operator: '-',
                naladchik: '-',
                startTime: '-',
                timeDetail: '-',
                timeChangeDetail: '-',
                dateNaladki: '-',
                detailSystemName: '-',
                nameUp: '-',
                nameDraw: '-',
                typeMachine: selectTypesMachinesForAddMachine.value
            }

            try{
                await writeToFirebase(path, obj);
                inputNameNewMachine.value = '';
                pError.classList.add('display-none');
            } catch(e){
                pError.classList.remove('display-none');
                pError.textContent = 'Станок с таким названием уже есть';
            }

        } else {
            pError.classList.remove('display-none');
            pError.textContent = 'Заполните все поля';
        }
    }

    async function addNewDetail() {
        const inputNameNewDetail = document.querySelector('#inputNameNewDetail');
        const inputNameDrawNewDetail = document.querySelector('#inputNameDrawNewDetail');
        const pError = document.querySelector('#pErrorAddNewDetail');

        const name = inputNameNewDetail.value.trim();
        const nameDraw = inputNameDrawNewDetail.value.trim();

        // Сброс цвета основного ввода
        inputNameNewDetail.style.borderColor = '';
        inputNameDrawNewDetail.style.borderColor = '';
        pError.classList.add('display-none');

        // Проверка имени детали и чертежа
        if (name.length <= 1 || nameDraw.length === 0) {
            pError.classList.remove('display-none');
            pError.textContent = 'Заполните все поля';
            if (name.length <= 1) inputNameNewDetail.style.borderColor = 'red';
            if (nameDraw.length === 0) inputNameDrawNewDetail.style.borderColor = 'red';
            return;
        }

        // Формируем объект после всех валидаций
        const systemName = `${transliterate(name)}_${transliterate(nameDraw)}`;
        const objNewDetail = {
            name: name,
            nameDraw: nameDraw,
            systemName: systemName,
            countInstalls: 0,
        };

        // Запись в Firebase
        try {
            await writeToFirebase(`details/${systemName}`, objNewDetail);

            inputNameNewDetail.value = '';
            inputNameDrawNewDetail.value = '';
            pError.classList.add('display-none');
        } catch (e) {
            pError.classList.remove('display-none');
            pError.textContent = 'Деталь с таким именем и названием чертежа уже есть';
            inputNameDrawNewDetail.style.borderColor = 'red';
            inputNameNewDetail.style.borderColor = 'red';
        }
    }

    function closeAllAllerts(){
        const listAllerts = ['bg-allert', `allertNewSelectDateForWorkerInfo`, `allertDetailInformationForWorker`, 
        `allertDetailInFormationForWorkerDay`, `allertDetailInformationForWorkerMounth`, 
        `allertDetailInformationForWorkerPeriod`, `allertCalculateSalary`,
        `allertConfirmDelete`, `allertStatWorkersTwoWeen`, `allertNewSelectDateForMachineInfo`,
        `allertDetailInformationForMachine`, `allertDetailInFormationForMachineDay`, `allertReductDetail`];

        Object.values(listAllerts).forEach(allert => {
            document.querySelector(`#${allert}`).classList.add('display-none');
        })
    }

    function clickMoreInfoForWorker(name){
        document.querySelector(`#allertNewSelectDateForWorkerInfo`).classList.remove('display-none');
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        selectedWorkerForGetMoreInfo = name;

        readToFirebase(`workers/${name}/fio`, fio => {
            document.querySelector(`#bNameSelectedWorkerName`).innerHTML = fio;
        });
    }

    function showDetailInfoForWorker(){ 
        openAllertDownload();
        const inputStartDate = document.querySelector("#inputStartDateForUserDetailInfo");
        const inputEndDate = document.querySelector("#inputEndDateForUserDetailInfo");
        const allertDetailInformationForWorker = document.querySelector(`#allertDetailInformationForWorker`);

        const startDateMs = new Date(inputStartDate.value).getTime();
        const endDateMs = new Date(inputEndDate.value).getTime();

        arraySelectedMounthsForDetailInformation = getMonthsInRange(startDateMs, endDateMs);
        indexSelectedMount = 0;
        startSelectPeriodForDetailInformationWorker = startDateMs;
        endSelectPeriodForDetailInformationWorker = endDateMs + 86400000 - 10810000 ; 

        readToFirebase(`workers/${selectedWorkerForGetMoreInfo}`, worker => {
            workerObjForDetailInformation = worker;
            readFirebaseByKeyRange(`logs/workers/${selectedWorkerForGetMoreInfo}/logs`, startSelectPeriodForDetailInformationWorker, endSelectPeriodForDetailInformationWorker,  logsWorker => {
                if(!logsWorker){
                    closeAllertDownload();
                } else {
                    workerLogsForDetailInformation = logsWorker;
                    document.querySelector(`#h2WorkerNameForDetailInformation`).textContent = worker.fio;
                    document.querySelector(`#h2RangeDatesSelectedWorkerDetailInformation`).textContent = `${formatedDateInNormalFormat(inputStartDate.value)} - ${formatedDateInNormalFormat(inputEndDate.value)}`;
                    allertDetailInformationForWorker.classList.remove('display-none');
                    printMountDetailInformationForWorker();
                }
            });
        });
    }

    function changeMounthDetailInformationWorker(type){
        if(type == 'next' && arraySelectedMounthsForDetailInformation.length - 1 > indexSelectedMountForDetailInformation){
            indexSelectedMountForDetailInformation ++;
        } else if(indexSelectedMountForDetailInformation > 0 && type == 'back') {
            indexSelectedMountForDetailInformation --;
        }
        printMountDetailInformationForWorker();
    }

    async function printMountDetailInformationForWorker() {
        const containerDatesCalendar = document.querySelector('#containerDatesCalendar');
        containerDatesCalendar.innerHTML = '';

        const selectedMounth = arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation];

        document.querySelector(`#h3SelectedYearForDetailInformationWorker`).textContent = selectedMounth.year;
        document.querySelector(`#h3SelectedMounthUaForDetailInformationWorker`).textContent = selectedMounth.mounthNameUa;
        document.querySelector(`#h3SelectedMounthRuForDetailInformationWorker`).textContent = selectedMounth.mounthNameRu;

        // Получаем массив дней с учетом асинхронной логики
        const arrayDays = await getDaysInRange(selectedMounth.startOfMonth, selectedMounth.endOfMonth);

        // Получаем день недели для первого дня месяца (0 - воскресенье, 1 - понедельник и т.д.)
        const firstDayOfMonth = new Date(selectedMounth.startOfMonth).getDay();

        // Добавляем пустые элементы в начале, в зависимости от того, с какого дня недели начинается месяц
        for (let i = 1; i < firstDayOfMonth; i++) {
            containerDatesCalendar.innerHTML += `
                <div>
                    <div class="container"></div>
                </div>
            `;
        }

        // Перебираем дни месяца и добавляем их в таблицу
        for (const day of arrayDays) {
            // Фильтруем и сортируем логи для данного дня
            const logs = await filterAndSortByKeyRange(day.startDateMs, day.endDateMs, workerLogsForDetailInformation);
            let timerDay = '';
            let arrayCoefficients = [];
            let startWorkDay = 0;
            let endWorkDay = 0;
            try {
                for (const log of logs) {
                    if (log.typeLog == 'Конец рабочего дня') {
                        timerDay = getTimeDifference(log.endWorkDay, log.startWorkDay);
                        startWorkDay = log.startWorkDay;
                        endWorkDay = log.endWorkDay;
                    } else if (log.typeLog == 'Производство') {
                        let machineTime = Number(log.countDetails) * (minSecToSeconds(log.timeDetail) + minSecToSeconds(log.timeChangeDetail));
                        let timer = (Number(log.endTime) - Number(log.startTime)) / 1000;
                        let res = machineTime / timer;
                        arrayCoefficients.push(res);
                    }
                }
            } catch (error) {
            }

            // Добавляем в DOM информацию о дне
            containerDatesCalendar.innerHTML += `
                <div onclick="openAllertDetailInFormationForWorkerDay('${startWorkDay}', '${endWorkDay}')" style="background-color: ${getColorForCoefficient(arrayCoefficients.length ? (parseFloat((arrayCoefficients.reduce((acc, num) => acc + num, 0) / arrayCoefficients.length).toFixed(2))) : 0)}" class='item'>
                    <div class='container'>
                        <h3>${day.day}</h3>
                        <p>${timerDay}</p>
                        <p>
                        ${arrayCoefficients.length
                            ? Math.round(calculateAverage(arrayCoefficients) * 100) + '%'
                            : ''}
                        </p>
                    </div>
                </div>
            `;
        }
        closeAllertDownload();
    }

    async function openAllertDetailInFormationForWorkerDay(startWorkDay, endWorkDay) {
        if(startWorkDay == '0' || endWorkDay == '0'){
            return;
        }
        openAllertDownload();
        
        document.querySelector('#containerMachineInformationForDayForWorkerDetailInformation').classList.add('display-none');
        document.querySelector('#containerGeneralInformationForDayForWorkerDetailInformation').classList.remove('display-none');

        document.querySelector(`#h2NameWorkerDetailInformationForWorkerDay`).textContent = workerObjForDetailInformation.fio;
        document.querySelector(`#h2DateDetailInformationForWorkerDay`).textContent = formatedDate(Number(endWorkDay));

        const logs = await filterAndSortByKeyRange(startWorkDay, endWorkDay, workerLogsForDetailInformation);

        const detailsMap = new Map();
        let setupMachines = '';
        let diagramsHtml = '';

        for (let [index, log] of logs.entries()) {
            if (log.typeLog === 'Производство') {
                const key = `${log.detail} (${log.install})`;
                const currentCount = detailsMap.get(key) || 0;
                const newCount = currentCount + Number(log.countDetails); // ✅ преобразование
                detailsMap.set(key, newCount);

                const countProcentResult = Math.round(
                    (Number(log.countDetails) / (((log.endTime - log.startTime) / 1000) /
                    (minSecToSeconds(log.timeDetail) + minSecToSeconds(log.timeChangeDetail)))) * 100
                );

                diagramsHtml += `
                    <div onclick="changeInformationToMachineForWorkerDetailsInformation(event, '${log.machine}', '${log.timeDetail}', '${log.timeChangeDetail}', '${log.detail}', 
                    '${log.install}', '${log.countDetails}', '${log.naladchik}', '${log.dateNaladki}',
                    '${secondsToTimeFormat((log.endTime - log.startTime) / 1000)}',
                    '${secondsToTimeFormat(log.countDetails * (minSecToSeconds(log.timeDetail) + minSecToSeconds(log.timeChangeDetail)))}',
                    '${Math.round((((log.endTime - log.startTime) / 1000) / (minSecToSeconds(log.timeDetail) + minSecToSeconds(log.timeChangeDetail))))}')" class="item">
                        <div class="bg-diagram">
                            <div style='height: ${countProcentResult}%' class="result">${countProcentResult}%</div>
                        </div>
                        <p>${log.machine}</p>
                    </div>
                `;
            } else if (log.typeLog === 'настройка станка') {
                await new Promise(resolve => {
                    readToFirebase(`${log.machinePath}`, machine => {
                        setupMachines += `
                            <div class="container-info">
                                <p>${machine.name}:</p>
                                <span>${log.detail} (${log.install})</span>
                            </div>
                        `;
                        resolve();
                    });
                });
            }
        }

        let detailsHtml = '';
        detailsMap.forEach((count, key) => {
            detailsHtml += `
                <div class="container-info">
                    <p>${key}:</p>
                    <span>${count} шт.</span>
                </div>
            `;
        });

        document.querySelector(`#containerGeneralInformationForDayForWorkerDetailInformation`).innerHTML = `
            <h5>Детальная информация</h5>
            <div class="container-info">
                <p>Начало смены:</p>
                <span>${formatDate(Number(startWorkDay))}</span>
            </div>
            <div class="container-info">
                <p>Конец смены:</p>
                <span>${formatDate(Number(endWorkDay))}</span>
            </div>
            <div class="container-info">
                <p>Продолжительность смены:</p>
                <span>${secondsToTimeFormat((endWorkDay - startWorkDay)/1000)}</span>
            </div>
            <div class="container-info">
                <p><b>Изготовленные детали:</b></p>
            </div>
            ${detailsHtml}
            <div class="container-info">
                <p><b>Настроенные станки:</b></p>
            </div>
            ${setupMachines}
        `;
        document.querySelector(`#containerDiagramsForDetailInformationWorkerDay`).innerHTML = diagramsHtml;

        closeAllertDownload();
        document.querySelector(`#allertDetailInFormationForWorkerDay`).classList.remove(`display-none`);
        document.querySelector(`#allertDetailInformationForWorker`).classList.add(`display-none`);
    }

    function changeInformationToMachineForWorkerDetailsInformation(event, machine, timeDetail, timeChangeDetail, detail, install, countDetails, naladchik, dateNaladki, timeWorkInMachine, timeWorkMachine, normaDetails){
        event.stopPropagation();
        const containerMachineInformationForDayForWorkerDetailInformation = document.querySelector('#containerMachineInformationForDayForWorkerDetailInformation');
        document.querySelector('#containerGeneralInformationForDayForWorkerDetailInformation').classList.add('display-none');
        containerMachineInformationForDayForWorkerDetailInformation.classList.remove('display-none');
        containerMachineInformationForDayForWorkerDetailInformation.innerHTML = `
            <h5>${machine}</h5>
            <div class="container-info">
                <p>Время работы на станке:</p>
                <span>${timeWorkInMachine}</span>
            </div>
            <div class="container-info">
                <p>Время работы станка:</p>
                <span>${timeWorkMachine}</span>
            </div>
            <div class="container-info">
                <p>Норма деталей:</p>
                <span>${normaDetails}</span>
            </div>
            <div class="container-info">
                <p>Сделано деталей:</p>
                <span>${countDetails}</span>
            </div>
            <div class="container-info">
                <p>Время детали:</p>
                <span>${timeDetail}</span>
            </div>
            <div class="container-info">
                <p>Время замены детали:</p>
                <span>${timeChangeDetail}</span>
            </div>
            <div class="container-info">
                <p>Деталь:</p>
                <span>${detail}</span>
            </div>
            <div class="container-info">
                <p>Установка:</p>
                <span>${install}</span>
            </div>
            <div class="container-info">
                <p>Наладчик:</p>
                <span>${formatName(naladchik)}</span>
            </div>
            <div class="container-info">
                <p>Дата наладки:</p>
                <span>${formatDate(Number(dateNaladki))}</span>
            </div>
        `;
    }

    function changeInformationToGeneralForWorkerDetailsInformationDays(){
        document.querySelector('#containerMachineInformationForDayForWorkerDetailInformation').classList.add('display-none');
        document.querySelector('#containerGeneralInformationForDayForWorkerDetailInformation').classList.remove('display-none');
    }

    function closeAllertForDetailsInformationForWorkerForWorkDay(){
        document.querySelector('#allertDetailInFormationForWorkerDay').classList.add('display-none');
        document.querySelector('#allertDetailInformationForWorker').classList.remove('display-none');
    }

    async function openAllertDetailInFormationForWorkerMounth(){
        openAllertDownload();
         
        document.querySelector('#containerDayInformationForMounthForWorkerDetailInformation').classList.add('display-none');
        document.querySelector('#containerGeneralInformationForMounthForWorkerDetailInformation').classList.remove('display-none');

        document.querySelector(`#h2NameWorkerDetailInformationForMounth`).textContent = workerObjForDetailInformation.fio;
        document.querySelector(`#h2DateDetailInformationForMounth`).textContent = `${arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].mounthNameUa}`;

        const containerDiagramsForDetailInformationMounthWorker = document.querySelector(`#containerDiagramsForDetailInformationMounthWorker`);

        const containerGeneralInformationForMounthForWorkerDetailInformation = document.querySelector(`#containerGeneralInformationForMounthForWorkerDetailInformation`);

        containerDiagramsForDetailInformationMounthWorker.innerHTML = '';
        containerGeneralInformationForMounthForWorkerDetailInformation.innerHTML = '';

        let htmlDiagrams = ``;

        //const allLogsSelectedMounth = await filterAndSortByKeyRange(arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].startOfMonth, arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].endOfMonth, workerLogsForDetailInformation);
        const allLogsSelectedMounth = await new Promise((resolve, reject) => {
            readFirebaseByKeyRange(
                `logs/workers/${transliterate(workerObjForDetailInformation.fio)}/logs`,
                arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].startOfMonth,
                arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].endOfMonth,
                logs => {
                    resolve(logs); // когда readFirebaseByKeyRange вернёт результат — резолвим промис
                }
            );
        });
        
        let logsEndWorksDays = [];

        let arrayProcentsResultsDays = [];
        let arrayTimesWorkDays = [];
        let arrayDetails = [];

        // находим логи конца дня за весь месяц
        for(index in allLogsSelectedMounth){
            const log = allLogsSelectedMounth[index];
            if(log.typeLog == `Конец рабочего дня`){
                logsEndWorksDays.push(log);
            } 
        }

        // перебираем все логи конца рабочего дня и выводим по ним информацию
        for(index in logsEndWorksDays){
            const logWorkDay = logsEndWorksDays[index];
            // добавляем продолжительность этого дня в милисекундах
            arrayTimesWorkDays.push(Number(logWorkDay.endWorkDay) - Number(logWorkDay.startWorkDay));

            // получаем логи по этому рабочему дню
            const logsThisWorkDay = await filterAndSortByKeyRange(logWorkDay.startWorkDay, logWorkDay.endWorkDay, allLogsSelectedMounth);
            
            const procentsResultsThisDay = [];

            let arrayDetailsThisDay = [];

            for(index in logsThisWorkDay){
                const log = logsThisWorkDay[index];
                if(log.typeLog == 'Производство'){
                    const workTime = Math.round(((Number(log.endTime) - Number(log.startTime)) / 1000));
                    const machineWork = Number(log.countDetails) * (Number(minSecToSeconds(log.timeDetail)) + Number(minSecToSeconds(log.timeChangeDetail)));
                    const procentResult = Math.round(machineWork / workTime * 100);
                    procentsResultsThisDay.push(procentResult);  
                    const objDetail = {
                        installName: `${log.detail} (${log.install})`,
                        countDetails: log.countDetails
                    }      
                    arrayDetails.push(objDetail);  
                    arrayDetailsThisDay.push(objDetail);      
                }
            }

            const procentResult = calculateAverage(procentsResultsThisDay);
            arrayProcentsResultsDays.push(procentResult);
            htmlDiagrams += `
                    <div onclick="changeInformationToDayForWorkerDetailsInformation(event, '${logWorkDay.startWorkDay}', '${logWorkDay.endWorkDay}', '${procentResult}', '${JSON.stringify(arrayDetailsThisDay).replace(/"/g, '&quot;')}')" class="item">
                    <div class="bg-diagram">
                        <div style="height: ${procentResult}%" class="result">${Math.round(procentResult)}%</div>
                    </div>
                    <p>${getDayInDateNow(logWorkDay.endWorkDay)}</p>
                </div>
            `;
        }

        // отрисовываются диаграммы
        containerDiagramsForDetailInformationMounthWorker.innerHTML = htmlDiagrams;
        
        let htmlDetails = '';
        let detailsSummary = {};

        for (let index in arrayDetails) {
            const item = arrayDetails[index];
            if (detailsSummary[item.installName]) {
                detailsSummary[item.installName] += Number(item.countDetails);
            } else {
                detailsSummary[item.installName] = Number(item.countDetails);
            }
        }

        for (let installName in detailsSummary) {
            htmlDetails += `
                <div class="container-info">
                    <p>${installName}:</p>
                    <span>${detailsSummary[installName]} шт.</span> 
                </div>
            `;
        }
        
        // отрисовывается общая информация по месяцу
        containerGeneralInformationForMounthForWorkerDetailInformation.innerHTML = `
            <h5>Детальная информация</h5>
            <div class="container-info">
                <p>Количество часов:</p>
                <span>${secondsToTimeFormat(arrayTimesWorkDays.reduce((acc, num) => acc + num, 0) / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Количество рабочих смен:</p>
                <span>${arrayTimesWorkDays.length}</span>
            </div>
            <div class="container-info">
                <p>Средняя продолжительность смены:</p>
                <span>${secondsToTimeFormat(calculateAverage(arrayTimesWorkDays) / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Средний показатель успешности:</p>
                <span>${Math.round(calculateAverage(arrayProcentsResultsDays))}%</span>
            </div>
            <h5>Изготовленные детали:</h5>
            ${htmlDetails}
            <div onclick='openAllertCalculateSalary(${arrayTimesWorkDays.reduce((acc, num) => acc + num, 0) / 1000}, ${arrayTimesWorkDays.length}, "allertDetailInformationForWorkerMounth")' style='background-color: green; margin-bottom: 12px;' class="button-close">Расчитать ЗП</div>
        `;
        closeAllertDownload();
        document.querySelector('#allertDetailInformationForWorkerMounth').classList.remove('display-none');
        document.querySelector('#allertDetailInformationForWorker').classList.add('display-none');
    }

    function changeInformationToDayForWorkerDetailsInformation(event, startWorkDay, endWorkDay, procentResult, arrayDetails){
        const jsonString = arrayDetails.replace(/&quot;/g, '"');
        const array = JSON.parse(jsonString);
        let htmlDetails = '';
        Object.values(array).forEach(detail => {
            htmlDetails += `<div class="container-info">
                <p>${detail.installName}:</p>
                <span>${detail.countDetails} шт.</span>
            </div>`;
        });

        event.stopPropagation();
        const containerDayInformationForMounthForWorkerDetailInformation = document.querySelector(`#containerDayInformationForMounthForWorkerDetailInformation`);
        document.querySelector(`#containerGeneralInformationForMounthForWorkerDetailInformation`).classList.add('display-none');
        containerDayInformationForMounthForWorkerDetailInformation.classList.remove('display-none');

        containerDayInformationForMounthForWorkerDetailInformation.innerHTML = ``;

    
        containerDayInformationForMounthForWorkerDetailInformation.innerHTML = `
            <h5>${getDayAndMounthInDateNow(Number(endWorkDay))}</h5>
            <div class="container-info">
                <p>Продолжительность смены:</p>
                <span>${secondsToTimeFormat((endWorkDay - startWorkDay) / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Начало смены:</p>
                <span>${getHoursAndMinutesInDateNow(Number(startWorkDay))}</span>
            </div>
            <div class="container-info">
                <p>Конец смены:</p>
                <span>${getHoursAndMinutesInDateNow(Number(endWorkDay))}</span>
            </div>
            <div class="container-info">
                <p>Средний показатель продуктивности:</p>
                <span>${Math.round(procentResult)}%</span>
            </div>
            <h5>Изготовленные детали:</h5>
            ${htmlDetails}
        `;
    }

    function changeInformationToDayForWorkerDetailsInformationPeriod(event, startWorkDay, endWorkDay, procentResult, arrayDetails){
        const jsonString = arrayDetails.replace(/&quot;/g, '"');
        const array = JSON.parse(jsonString);
        let htmlDetails = '';
        Object.values(array).forEach(detail => {
            htmlDetails += `<div class="container-info">
                <p>${detail.installName}:</p>
                <span>${detail.countDetails} шт.</span>
            </div>`;
        });
        event.stopPropagation();
        const containerDayInformationForPeriodForWorkerDetailInformation = document.querySelector(`#containerDayInformationForPeriodForWorkerDetailInformation`);
        document.querySelector(`#containerGeneralInformationForPeriodForWorkerDetailInformation`).classList.add('display-none');
        containerDayInformationForPeriodForWorkerDetailInformation.classList.remove('display-none');

        containerDayInformationForPeriodForWorkerDetailInformation.innerHTML = ``;

    
        containerDayInformationForPeriodForWorkerDetailInformation.innerHTML = `
            <h5>${getDayAndMounthInDateNow(Number(endWorkDay))}</h5>
            <div class="container-info">
                <p>Продолжительность смены:</p>
                <span>${secondsToTimeFormat((endWorkDay - startWorkDay) / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Начало смены:</p>
                <span>${getHoursAndMinutesInDateNow(Number(startWorkDay))}</span>
            </div>
            <div class="container-info">
                <p>Конец смены:</p>
                <span>${getHoursAndMinutesInDateNow(Number(endWorkDay))}</span>
            </div>
            <div class="container-info">
                <p>Средний показатель продуктивности:</p>
                <span>${Math.round(procentResult)}%</span>
            </div>
            <h5>Изготовленные детали:</h5>
            ${htmlDetails}
        `;
    }

    function changeInfirmationToGeneralForWorkerDetailsInFOrmationMounth(){
        document.querySelector(`#containerDayInformationForMounthForWorkerDetailInformation`).classList.add('display-none');
        document.querySelector(`#containerGeneralInformationForMounthForWorkerDetailInformation`).classList.remove('display-none');
    }

    function changeInfirmationToGeneralForWorkerDetailsInformationPeriod(){
        document.querySelector(`#containerDayInformationForPeriodForWorkerDetailInformation`).classList.add('display-none');
        document.querySelector(`#containerGeneralInformationForPeriodForWorkerDetailInformation`).classList.remove('display-none');
    }

    function closeAllertForDetailsInformationForWorkerForMounth(){
        document.querySelector('#allertDetailInformationForWorker').classList.remove('display-none');
        document.querySelector('#allertDetailInformationForWorkerMounth').classList.add('display-none');
    }
    
    async function openAllertDetailInformationForWorkerPeriod(){
        openAllertDownload();
         
        document.querySelector('#containerDayInformationForPeriodForWorkerDetailInformation').classList.add('display-none');
        document.querySelector('#containerGeneralInformationForPeriodForWorkerDetailInformation').classList.remove('display-none');
        
        document.querySelector(`#h2NameWorkerDetailInformationForPeriod`).textContent = workerObjForDetailInformation.fio;
        document.querySelector(`#h2DateDetailInformationForPeriod`).textContent = `${formatedDate(startSelectPeriodForDetailInformationWorker)} - ${formatedDate(endSelectPeriodForDetailInformationWorker)}`;

        const containerDiagramsForDetailInformationPeriodWorker = document.querySelector(`#containerDiagramsForDetailInformationPeriodWorker`);

        const containerGeneralInformationForPeriodForWorkerDetailInformation = document.querySelector(`#containerGeneralInformationForPeriodForWorkerDetailInformation`);

        containerDiagramsForDetailInformationPeriodWorker.innerHTML = '';
        containerGeneralInformationForPeriodForWorkerDetailInformation.innerHTML = '';

        let htmlDiagrams = ``;

        const allLogsSelectedPeriod = await filterAndSortByKeyRange(startSelectPeriodForDetailInformationWorker, endSelectPeriodForDetailInformationWorker, workerLogsForDetailInformation);
        let logsEndWorksDays = [];

        let arrayProcentsResultsDays = [];
        let arrayTimesWorkDays = [];
        let arrayDetails = [];

        // находим логи конца дня за весь месяц
        for(index in allLogsSelectedPeriod){
            const log = allLogsSelectedPeriod[index];
            if(log.typeLog == `Конец рабочего дня`){
                logsEndWorksDays.push(log);
            } 
        }

        // перебираем все логи конца рабочего дня и выводим по ним информацию
        for(index in logsEndWorksDays){
            const logWorkDay = logsEndWorksDays[index];
            // добавляем продолжительность этого дня в милисекундах
            arrayTimesWorkDays.push(Number(logWorkDay.endWorkDay) - Number(logWorkDay.startWorkDay));

            // получаем логи по этому рабочему дню
            const logsThisWorkDay = await filterAndSortByKeyRange(logWorkDay.startWorkDay, logWorkDay.endWorkDay, workerLogsForDetailInformation);
            
            const procentsResultsThisDay = [];

            let arrayDetailsThisDay = [];

            for(index in logsThisWorkDay){
                const log = logsThisWorkDay[index];
                if(log.typeLog == 'Производство'){
                    const workTime = Math.round(((Number(log.endTime) - Number(log.startTime)) / 1000));
                    const machineWork = Number(log.countDetails) * (Number(minSecToSeconds(log.timeDetail)) + Number(minSecToSeconds(log.timeChangeDetail)));
                    const procentResult = Math.round(machineWork / workTime * 100);
                    procentsResultsThisDay.push(procentResult);  
                    const objDetail = {
                        installName: `${log.detail} (${log.install})`,
                        countDetails: log.countDetails
                    }      
                    arrayDetails.push(objDetail);  
                    arrayDetailsThisDay.push(objDetail);      
                }
            }

            const procentResult = calculateAverage(procentsResultsThisDay);
            arrayProcentsResultsDays.push(procentResult);
            htmlDiagrams += `
                    <div onclick="changeInformationToDayForWorkerDetailsInformationPeriod(event, '${logWorkDay.startWorkDay}', '${logWorkDay.endWorkDay}', '${procentResult}', '${JSON.stringify(arrayDetailsThisDay).replace(/"/g, '&quot;')}')" class="item">
                    <div class="bg-diagram">
                        <div style="height: ${procentResult}%" class="result">${Math.round(procentResult)}%</div>
                    </div>
                    <p>${getDayInDateNow(logWorkDay.endWorkDay)}</p>
                </div>
            `;
        }

        // отрисовываются диаграммы
        containerDiagramsForDetailInformationPeriodWorker.innerHTML = htmlDiagrams;
        
        let htmlDetails = '';
        let detailsSummary = {};

        for (let index in arrayDetails) {
            const item = arrayDetails[index];
            if (detailsSummary[item.installName]) {
                detailsSummary[item.installName] += Number(item.countDetails);
            } else {
                detailsSummary[item.installName] = Number(item.countDetails);
            }
        }

        for (let installName in detailsSummary) {
            htmlDetails += `
                <div class="container-info">
                    <p>${installName}:</p>
                    <span>${detailsSummary[installName]} шт.</span> 
                </div>
            `;
        }
        
        // отрисовывается общая информация по периоду
        containerGeneralInformationForPeriodForWorkerDetailInformation.innerHTML = `
            <h5>Детальная информация</h5>
            <div class="container-info">
                <p>Количество часов:</p>
                <span>${secondsToTimeFormat(arrayTimesWorkDays.reduce((acc, num) => acc + num, 0) / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Количество рабочих смен:</p>
                <span>${arrayTimesWorkDays.length}</span>
            </div>
            <div class="container-info">
                <p>Средняя продолжительность смены:</p>
                <span>${secondsToTimeFormat(calculateAverage(arrayTimesWorkDays) / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Средний показатель успешности:</p>
                <span>${Math.round(calculateAverage(arrayProcentsResultsDays))}%</span>
            </div>
            <h5>Изготовленные детали:</h5>
            ${htmlDetails}
            <div onclick='openAllertCalculateSalary(${arrayTimesWorkDays.reduce((acc, num) => acc + num, 0) / 1000}, ${arrayTimesWorkDays.length}, "allertDetailInformationForWorkerPeriod")' style='background-color: green; margin-bottom: 12px;' class="button-close">Расчитать ЗП</div>
        `;

        closeAllertDownload();
        document.querySelector('#allertDetailInformationForWorkerPeriod').classList.remove('display-none');
        document.querySelector('#allertDetailInformationForWorker').classList.add('display-none');
    }

    function closeAllertForDetailsInformationForWorkerForPeriod(){
        document.querySelector('#allertDetailInformationForWorker').classList.remove('display-none');
        document.querySelector('#allertDetailInformationForWorkerPeriod').classList.add('display-none');
    }

    function searchWorkerInTable(){
        const inputSearchFioWorker = document.querySelector(`#inputSearchFioWorker`);
        const searchText = inputSearchFioWorker.value.toLowerCase();
        const trs = document.querySelectorAll(`#tb-workers-table tr`);

        trs.forEach(tr => {
            const fioWorker = tr.querySelector('td').textContent.toLowerCase();

            if(fioWorker.includes(searchText)) {
                tr.style.display = '';
            } else {
                tr.style.display = 'none';
            }
        });
    }
    
    function searchWorkerInTableTwoWeekStat() {
        const inputSearchFioWorker = document.querySelector('#inputSearchWorkerInStatTwoWeek');
        const searchText = inputSearchFioWorker.value.toLowerCase();
        const trs = document.querySelectorAll('#tbodyTableStatWorkersTwoWeek tr');

        // Сначала скрываем все строки
        trs.forEach(tr => {
            tr.style.display = 'none';
        });

        // Затем ищем совпадения и показываем нужные строки + следующие за ними
        trs.forEach((tr, index) => {
            const fioWorker = tr.querySelector('td')?.textContent.toLowerCase() || '';

            if (fioWorker.includes(searchText)) {
                tr.style.display = '';
                const nextTr = trs[index + 1];
                if (nextTr) {
                    nextTr.style.display = '';
                }
            }
        });
    }

    function searchDetailInTable() {
        const inputSearchDetailInTable = document.querySelector('#inputSearchDetailInTable');
        const searchText = inputSearchDetailInTable.value.toLowerCase();
        const trs = document.querySelectorAll('#tb-details-table tr');

        trs.forEach(tr => {
            const tds = tr.querySelectorAll('td');

            if (tds.length >= 2) {
                const firstColumnText = tds[0].textContent.toLowerCase();
                const secondColumnText = tds[1].textContent.toLowerCase();

                if (firstColumnText.includes(searchText) || secondColumnText.includes(searchText)) {
                    tr.style.display = '';
                } else {
                    tr.style.display = 'none';
                }
            }
        });
    }

    function openAllertCalculateSalary(countSeconds, countDays, selector){
        countSecondsTimeForCalculateSalary = countSeconds;
        countDaysForCalculateSalary = countDays;
        selectorLastAllert = selector;
        closeAllAllerts();
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        document.querySelector(`#allertCalculateSalary`).classList.remove('display-none');
        document.querySelector(`#spanCountHoursForAllertSalary`).textContent = secondsToTimeFormat(countSeconds);
        calculateSumSalary();
    }

    function closeAllertCalculatesalary(){
        document.querySelector(`#allertCalculateSalary`).classList.add('display-none');
        document.querySelector(`#${selectorLastAllert}`).classList.remove('display-none');
    }

    function calculateSumSalary(){
        const minusTimeObed = document.querySelector(`#checkboxMinusTimeObed`).checked;
        const minusTimePereodevachka = document.querySelector(`#checkboxMinusTimePereodevachka`).checked;
        let countHours = 0;
        countHours = Math.round(countSecondsTimeForCalculateSalary / 3600);
        if(minusTimeObed){
            countHours = countHours - (1800 * countDaysForCalculateSalary) / 3600
        }
        if(minusTimePereodevachka){
            countHours = countHours - (1800 * countDaysForCalculateSalary) / 3600
        }
        document.querySelector(`#spanCountHoursForCalculateSalary`).textContent = countHours;
        const res = document.querySelector(`#inputSumHoursForCalculateSalary`).value * countHours;
        document.querySelector(`#spanResSumSalary`).textContent = `${res} грн`;
    }

    function clickDeleteWorker(worker){
        overwriteToFirebase(`workers/${worker}`, {});
        overwriteToFirebase(`logs/workers/${worker}`, {});
        fetch(`${apiLink}/delete_image`, {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain'
            },
            body: worker.trim()
        })
        .then()
        .catch();
    }

    function clickDeleteMachine(type, name){
        overwriteToFirebase(`machines/${type}/machines/${name}`, {});
        overwriteToFirebase(`logs/machines/${type}/machines/${name}`, {});
    }

    function clickDeleteDetail(systemName){
        overwriteToFirebase(`details/${systemName}`, {});
        overwriteToFirebase(`logs/details/${systemName}`, {});
    }

    function openAllertConfirmDelete(typeOperation, name, type){
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        document.querySelector(`#allertConfirmDelete`).classList.remove('display-none');

        typeOperationForDelete = typeOperation;
        nameForDelete = name;
        typeFordelete = type;
    }

    function clickConfirmAllertDelete(){
        closeAllAllerts();

        if(typeOperationForDelete == `worker`){
            clickDeleteWorker(nameForDelete);
        } else if(typeOperationForDelete == `machine`){
            clickDeleteMachine(typeFordelete, nameForDelete);
        } else if(typeOperationForDelete == `detail`){
            clickDeleteDetail(nameForDelete);
        }
    }

    async function printStatWorkersTwoWeek() {
        openAllertDownload();
        const tbodyTableStatWorkersTwoWeek = document.querySelector(`#tbodyTableStatWorkersTwoWeek`);
        const tHeadTableStatWorkersTwoWeek = document.querySelector(`#tHeadTableStatWorkersTwoWeek`);
        tHeadTableStatWorkersTwoWeek.innerHTML = `
            <tr>
                <th>ФИО</th>
                <th>Сб</th>
                <th>Вс</th>
                <th>Пн</th>
                <th>Вт</th>
                <th>Ср</th>
                <th>Чт</th>
                <th>Пт</th>
                <th>Всего часов</th>
            </tr>`;
        const thsHead = Array.from(tHeadTableStatWorkersTwoWeek.querySelectorAll("th"));

        const pastSaturday = getPastSaturdayTimestamp(2);
        const nextSaturday = getNextSaturdayTimestamp();
        const daysInRangeDates = getDaysInRangeForStatsTwoWeek(pastSaturday, nextSaturday - 10000);
        await printHeadTable();
        await printBodyTable();
        document.querySelector(`#allertStatWorkersTwoWeen`).classList.remove('display-none');
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        closeAllertDownload();

        async function printHeadTable() {
            for (const dayInRange of Object.values(daysInRangeDates)) {
                const targetTh = thsHead.find(th => th.textContent.trim().toLowerCase().slice(0, 2) === dayInRange.dayName.toLowerCase());
                targetTh.innerHTML += `<br/>${getNumberAndMountForDateNow(dayInRange.dayStart)}`;
            }
        }

        async function printBodyTable() {
            tbodyTableStatWorkersTwoWeek.innerHTML = '';
            await new Promise((resolve) => {
                readToFirebase('workers', async (workers) => {
                    for (const [key, worker] of Object.entries(workers)) {
                        await new Promise((resolveWorker) => {
                            readFirebaseByKeyRange('logs/workers/' + key + '/logs', pastSaturday, nextSaturday, (logs) => {
                                const workerFio = worker.fio;
                                let totalTimeMilliseconds = 0;
                                let countWorkDays = 0;
                                if (!logs) {
                                    resolveWorker();
                                    return;
                                }
                                tbodyTableStatWorkersTwoWeek.innerHTML += `
                                    <tr>
                                        <td rowspan="2">${formatName(workerFio)}</td>
                                        <td id="td-${key}-${daysInRangeDates[0].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[1].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[2].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[3].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[4].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[5].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[6].number}">-<br>-</td>
                                        <td id="td-${key}-totalTime" rowspan="2">-</td>
                                    </tr>
                                    <tr>
                                        <td id="td-${key}-${daysInRangeDates[7].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[8].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[9].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[10].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[11].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[12].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[13].number}">-<br>-</td>
                                    </tr>
                                `;
                                Object.values(logs).forEach(log => {
                                    if (log.typeLog == "Конец рабочего дня") {
                                        if (getDayOfMonth(log.startWorkDay) == getDayOfMonth(log.endWorkDay)) {
                                            try {
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML = `${getHoursAndMinutesInDateNow(log.startWorkDay)}<br>${getHoursAndMinutesInDateNow(log.endWorkDay)}`;
                                            } catch (e) { }
                                        } else {
                                            try {
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML = `${getHoursAndMinutesInDateNow(log.startWorkDay)}<br>->`;
                                            } catch (e) { }
                                            try {
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.endWorkDay)}`).innerHTML = `- <br>${getHoursAndMinutesInDateNow(log.endWorkDay)}`;
                                            } catch (e) { }
                                        }
                                        totalTimeMilliseconds += Number(log.endWorkDay - log.startWorkDay);
                                        countWorkDays++;
                                    }
                                });
                                document.querySelector(`#td-${key}-totalTime`).innerHTML = `${secondsToTimeFormat(totalTimeMilliseconds / 1000)} </br> ${countWorkDays} смен </br> <button onClick="openAllertCalculateSalary(${totalTimeMilliseconds / 1000}, ${countWorkDays}, 'allertStatWorkersTwoWeen')">Зарплата</button>`;
                                resolveWorker();
                            });
                        });
                    }
                    resolve();
                });
            });
        }
    }

    function clickDetailInformationMachine(path){
        document.querySelector(`#allertNewSelectDateForMachineInfo`).classList.remove(`display-none`);
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        selectedPathMachineForGetMoreInfo = `machines/${path}`;
        readToFirebase(`machines/${path}`, machine => {
            document.querySelector(`#bNameSelectedMachineName`).innerHTML = machine.name;
        });
    }

    function showDetailInfoForMachine(){
        const inputStartDate = document.querySelector("#inputStartDateForMachineDetailInfo");
        const inputEndDate = document.querySelector("#inputEndDateForMachineDetailInfo");
        const allertDetailInformationForMachine = document.querySelector(`#allertDetailInformationForMachine`);

        const startDateMs = new Date(inputStartDate.value).getTime();
        const endDateMs = new Date(inputEndDate.value).getTime();

        arraySelectedMounthsForDetailInformation = getMonthsInRange(startDateMs, endDateMs);
        indexSelectedMount = 0;
        startSelectPeriodForDetailInformationMachine = startDateMs;
        endSelectPeriodForDetailInformationMachine = endDateMs + 86400000 - 10810000 ; 

        readToFirebase(`${selectedPathMachineForGetMoreInfo}`, machine => {
            machineObjForDetailInformation = machine;
            readFirebaseByKeyRange(`logs/${selectedPathMachineForGetMoreInfo}/logs`, startSelectPeriodForDetailInformationMachine, endSelectPeriodForDetailInformationMachine, logsMachine => {
                machineLogsForDetailInformation = logsMachine;
                document.querySelector(`#h2MachineNameForDetailInformation`).textContent = machine.name;
                document.querySelector(`#h2RangeDatesSelectedMachineDetailInformation`).textContent = `${formatedDateInNormalFormat(inputStartDate.value)} - ${formatedDateInNormalFormat(inputEndDate.value)}`;
                allertDetailInformationForMachine.classList.remove('display-none');
                printMountDetailInformationForMachine();
            });
        });
    }

    async function printMountDetailInformationForMachine() {
        const containerDatesCalendar = document.querySelector('#containerDatesCalendarMachine');
        containerDatesCalendar.innerHTML = '';

        const selectedMounth = arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation];

        document.querySelector(`#h3SelectedYearForDetailInformationMachine`).textContent = selectedMounth.year;
        document.querySelector(`#h3SelectedMounthUaForDetailInformationMachine`).textContent = selectedMounth.mounthNameUa;
        document.querySelector(`#h3SelectedMounthRuForDetailInformationMachine`).textContent = selectedMounth.mounthNameRu;

        // Получаем массив дней с учетом асинхронной логики
        const arrayDays = await getDaysInRange(selectedMounth.startOfMonth, selectedMounth.endOfMonth);

        // Получаем день недели для первого дня месяца (0 - воскресенье, 1 - понедельник и т.д.)
        const firstDayOfMonth = new Date(selectedMounth.startOfMonth).getDay();

        // Добавляем пустые элементы в начале, в зависимости от того, с какого дня недели начинается месяц
        for (let i = 1; i < firstDayOfMonth; i++) {
            containerDatesCalendar.innerHTML += `
                <div>
                    <div class="container"></div>
                </div>
            `;
        }

        // Перебираем дни месяца и добавляем их в таблицу
        for (const day of arrayDays) {
            // Фильтруем и сортируем логи для данного дня
            const logs = await filterAndSortByKeyRange(day.startDateMs, day.endDateMs, machineLogsForDetailInformation);
            let timerDay = 0;
            let arrayCoefficients = [];
            let startWorkDay = day.startDateMs;
            let endWorkDay = day.endDateMs;
            try {
                for (const log of logs) { // придумать как расчитать сколько по времени работал станок
                    if(log.typeLog == 'Производство'){
                        let machineTime = Number(log.countDetails) * (minSecToSeconds(log.timeDetail) + minSecToSeconds(log.timeChangeDetail));
                        let timer = (Number(log.endTime) - Number(log.startTime)) / 1000;
                        let res = machineTime / timer;
                        arrayCoefficients.push(res);
                        timerDay += Number(log.endTime) - Number(log.startTime);
                    }
                    
                }
            } catch (error) {
            }

            // Добавляем в DOM информацию о дне
            containerDatesCalendar.innerHTML += `
                <div onclick="openAllertDetailInFormationForMachineDay('${startWorkDay}', '${endWorkDay}')" style="background-color: ${getColorForCoefficient(arrayCoefficients.length ? (parseFloat((arrayCoefficients.reduce((acc, num) => acc + num, 0) / arrayCoefficients.length).toFixed(2))) : 0)}" class='item'>
                    <div class='container'>
                        <h3>${day.day}</h3>
                        <p>${secondsToTimeFormat(timerDay / 1000) === "00:00" ? "" : secondsToTimeFormat(timerDay / 1000)}</p>
                        <p>
                        ${arrayCoefficients.length
                            ? Math.round(calculateAverage(arrayCoefficients) * 100) + '%'
                            : ''}
                        </p>
                    </div>
                </div>
            `;
        }
    }

    async function openAllertDetailInFormationForMachineDay(startDay, endDay) {
        document.querySelector(`#allertDetailInFormationForMachineDay`).classList.remove(`display-none`);
        document.querySelector(`#allertDetailInformationForMachine`).classList.add(`display-none`);
        document.querySelector('#containerMachineInformationForDayForMachineDetailInformation').classList.add('display-none');
        document.querySelector('#containerGeneralInformationForDayForMachineDetailInformation').classList.remove('display-none');

        document.querySelector(`#h2NameMachineDetailInformationForMachineDay`).textContent = machineObjForDetailInformation.name;
        document.querySelector(`#h2DateDetailInformationForMachineDay`).textContent = formatedDate(Number(startDay));

        const logs = await filterAndSortByKeyRange(startDay, endDay, machineLogsForDetailInformation);

        let timerWorkMachine = 0;
        let arrayCoefficients = [];

        const detailsMap = new Map();
        let diagramsHtml = '';

        for (let [index, log] of logs.entries()) {
            if (log.typeLog === 'Производство') {
                timerWorkMachine += Number(log.endTime) - Number(log.startTime);
                const key = `${log.detail} (${log.install})`;
                const currentCount = detailsMap.get(key) || 0;
                const newCount = currentCount + Number(log.countDetails);
                detailsMap.set(key, newCount);

                const countProcentResult = Math.round(
                    (Number(log.countDetails) / (((log.endTime - log.startTime) / 1000) /
                    (minSecToSeconds(log.timeDetail) + minSecToSeconds(log.timeChangeDetail)))) * 100
                );
                arrayCoefficients.push(countProcentResult);

                diagramsHtml += `
                    <div onclick="changeInformationToMachineForWorkerDetailsInformationMachine(event, '${log.operator}', '${log.timeDetail}', '${log.timeChangeDetail}', '${log.detail}', 
                    '${log.install}', '${log.countDetails}', '${log.naladchik}', '${log.dateNaladki}',
                    '${secondsToTimeFormat((log.endTime - log.startTime) / 1000)}',
                    '${secondsToTimeFormat(log.countDetails * (minSecToSeconds(log.timeDetail) + minSecToSeconds(log.timeChangeDetail)))}',
                    '${Math.round((((log.endTime - log.startTime) / 1000) / (minSecToSeconds(log.timeDetail) + minSecToSeconds(log.timeChangeDetail))))}')" class="item">
                        <div class="bg-diagram">
                            <div style='height: ${countProcentResult}%' class="result">${countProcentResult}%</div>
                        </div>
                        <p>${formatName(log.operator)}</p>
                    </div>
                `;
            }
        }

        let detailsHtml = '';
        detailsMap.forEach((count, key) => {
            detailsHtml += `
                <div class="container-info">
                    <p>${key}:</p>
                    <span>${count} шт.</span>
                </div>
            `;
        });

        document.querySelector(`#containerGeneralInformationForDayForMachineDetailInformation`).innerHTML = `
            <h5>Детальная информация</h5>
            <div class="container-info">
                <p>Время работы станка:</p>
                <span>${secondsToTimeFormat(timerWorkMachine / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Средний показатель продуктивности:</p>
                <span>${calculateAverage(arrayCoefficients)} %</span>
            </div>
            <div class="container-info">
                <p><b>Изготовленные детали:</b></p>
            </div>
            ${detailsHtml}
        `;

        document.querySelector(`#containerDiagramsForDetailInformationMachineDay`).innerHTML = diagramsHtml;
    }

    function changeInformationToMachineForWorkerDetailsInformationMachine(event, operator, timeDetail, timeChangeDetail, detail, install, countDetails, naladchik, dateNaladki, timeWorkInMachine, timeWorkMachine, normaDetails){
        event.stopPropagation();
        const containerMachineInformationForDayForWorkerDetailInformation = document.querySelector('#containerMachineInformationForDayForMachineDetailInformation');
        document.querySelector('#containerGeneralInformationForDayForMachineDetailInformation').classList.add('display-none');
        containerMachineInformationForDayForWorkerDetailInformation.classList.remove('display-none');
        containerMachineInformationForDayForWorkerDetailInformation.innerHTML = `
            <h5>${formatName(operator)}</h5>
            <div class="container-info">
                <p>Время работы на станке:</p>
                <span>${timeWorkInMachine}</span>
            </div>
            <div class="container-info">
                <p>Время работы станка:</p>
                <span>${timeWorkMachine}</span>
            </div>
            <div class="container-info">
                <p>Норма деталей:</p>
                <span>${normaDetails}</span>
            </div>
            <div class="container-info">
                <p>Сделано деталей:</p>
                <span>${countDetails}</span>
            </div>
            <div class="container-info">
                <p>Время детали:</p>
                <span>${timeDetail}</span>
            </div>
            <div class="container-info">
                <p>Время замены детали:</p>
                <span>${timeChangeDetail}</span>
            </div>
            <div class="container-info">
                <p>Деталь:</p>
                <span>${detail}</span>
            </div>
            <div class="container-info">
                <p>Установка:</p>
                <span>${install}</span>
            </div>
            <div class="container-info">
                <p>Наладчик:</p>
                <span>${formatName(naladchik)}</span>
            </div>
            <div class="container-info">
                <p>Дата наладки:</p>
                <span>${formatDate(Number(dateNaladki))}</span>
            </div>
        `;
    }

    function changeInformationToGeneralForMachineDetailsInformationDays(){
        document.querySelector('#containerMachineInformationForDayForMachineDetailInformation').classList.add('display-none');
        document.querySelector('#containerGeneralInformationForDayForMachineDetailInformation').classList.remove('display-none');
    }

    function closeAllertForDetailsInformationForMachineForWorkDay(){
        document.querySelector('#allertDetailInFormationForMachineDay').classList.add('display-none');
        document.querySelector('#allertDetailInformationForMachine').classList.remove('display-none');
    }

    async function openAllertDetailInFormationForMachineMounth1(){
        document.querySelector('#allertDetailInformationForMachineMounth').classList.remove('display-none');
        document.querySelector('#allertDetailInformationForMachine').classList.add('display-none');
         
        document.querySelector('#containerDayInformationForMounthForMachineDetailInformation').classList.add('display-none');
        document.querySelector('#containerGeneralInformationForMounthForMachineDetailInformation').classList.remove('display-none');

        document.querySelector(`#h2NameMachineDetailInformationForMounth`).textContent = machineObjForDetailInformation.name;
        document.querySelector(`#h2DateDetailInformationForMounthMachine`).textContent = `${arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].mounthNameUa}`;

        const containerDiagramsForDetailInformationMounthMachine = document.querySelector(`#containerDiagramsForDetailInformationMounthMachine`);

        const containerGeneralInformationForMounthForMachineDetailInformation = document.querySelector(`#containerGeneralInformationForMounthForMachineDetailInformation`);

        containerDiagramsForDetailInformationMounthMachine.innerHTML = '';
        containerGeneralInformationForMounthForMachineDetailInformation.innerHTML = '';

        let htmlDiagrams = ``;

        const allLogsSelectedMounth = await filterAndSortByKeyRangeAndKey(arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].startOfMonth, arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].endOfMonth, machineLogsForDetailInformation);
        const arrayDaysThisMounth = await getDaysInRange(arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].startOfMonth, arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].endOfMonth);

        let arrayProcentsResultsMachine = [];
        let arrayTimesWorkMachine = [];
        let arrayDetails = [];

        Object.values(arrayDaysThisMounth).forEach(day => {
            const logsThisDay = filterAndSortByKeyRange(day.startDateMs, day.endDateMs, allLogsSelectedMounth);
            if(logsThisDay.length > 0){
                let arrayProcentResultThisDay = [];
                let timeWorkMachine = 0;
                let arrayLogsThisDayProiz = [];
                Object.values(logsThisDay).forEach(log => {
                    if(log.typeLog == "Производство"){
                        arrayLogsThisDayProiz.push(log);
                        timeWorkMachine += Number(log.endTime) - Number(log.startTime);
                        const workTime = Math.round(((Number(log.endTime) - Number(log.startTime)) / 1000));
                        const machineWork = Number(log.countDetails) * (Number(minSecToSeconds(log.timeDetail)) + Number(minSecToSeconds(log.timeChangeDetail)));
                        const procentResult = Math.round(machineWork / workTime * 100);
                        arrayProcentResultThisDay.push(procentResult);  
                        const objDetail = {
                            installName: `${log.detail} (${log.install})`,
                            countDetails: log.countDetails
                        }      
                        arrayDetails.push(objDetail); 
                    }
                });
                arrayTimesWorkMachine.push(timeWorkMachine);
                arrayProcentsResultsMachine.push(Math.round(calculateAverage(arrayProcentResultThisDay)));                    

                htmlDiagrams += `
                    <div class="item" onclick="changeInformationToDayForMachineDetailsInFormationMounth(event, '${JSON.stringify(arrayLogsThisDayProiz).replace(/"/g, '&quot;')}')">
                        <div class="bg-diagram">
                            <div style="height: ${Math.round(calculateAverage(arrayProcentResultThisDay))}%" class="result">${Math.round(calculateAverage(arrayProcentResultThisDay))}%</div>
                        </div>
                        <p>${day.day}</p>
                    </div>
                `;
            }
        });
        containerDiagramsForDetailInformationMounthMachine.innerHTML = htmlDiagrams;
        
        let htmlDetails = '';
        let detailsSummary = {};

        for (let index in arrayDetails) {
            const item = arrayDetails[index];
            if (detailsSummary[item.installName]) {
                detailsSummary[item.installName] += Number(item.countDetails);
            } else {
                detailsSummary[item.installName] = Number(item.countDetails);
            }
        }

        for (let installName in detailsSummary) {
            htmlDetails += `
                <div class="container-info">
                    <p>${installName}:</p>
                    <span>${detailsSummary[installName]} шт.</span> 
                </div>
            `;
        }
        containerGeneralInformationForMounthForMachineDetailInformation.innerHTML = `
            <h5>Детальная информация</h5>
            <div class="container-info">
                <p>Время работы станка:</p>
                <span>${secondsToTimeFormat(arrayTimesWorkMachine.reduce((acc, num) => acc + num, 0) / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Средний показатель продуктивности:</p>
                <span>${Math.round(calculateAverage(arrayProcentsResultsMachine))}%</span>
            </div>
            <h5>Изготовленные детали:</h5>
            ${htmlDetails}
        `;
    }

    async function openAllertDetailInFormationForMachineMounth(){
        document.querySelector('#allertDetailInformationForMachineMounth').classList.remove('display-none');
        document.querySelector('#allertDetailInformationForMachine').classList.add('display-none');
         
        document.querySelector('#containerDayInformationForMounthForMachineDetailInformation').classList.add('display-none');
        document.querySelector('#containerGeneralInformationForMounthForMachineDetailInformation').classList.remove('display-none');

        document.querySelector(`#h2NameMachineDetailInformationForMounth`).textContent = machineObjForDetailInformation.name;
        document.querySelector(`#h2DateDetailInformationForMounthMachine`).textContent = `${arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].mounthNameUa}`;

        const containerDiagramsForDetailInformationMounthMachine = document.querySelector(`#containerDiagramsForDetailInformationMounthMachine`);

        const containerGeneralInformationForMounthForMachineDetailInformation = document.querySelector(`#containerGeneralInformationForMounthForMachineDetailInformation`);

        containerDiagramsForDetailInformationMounthMachine.innerHTML = '';
        containerGeneralInformationForMounthForMachineDetailInformation.innerHTML = '';

        let htmlDiagrams = ``;

        const allLogsSelectedMounth = await new Promise((resolve, reject) => {
            readFirebaseByKeyRange(
                `logs/machines/${machineObjForDetailInformation.typeMachine}/machines/${machineObjForDetailInformation.systemName}/logs`,
                arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].startOfMonth,
                arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].endOfMonth,
                logs => {
                    resolve(logs); // когда readFirebaseByKeyRange вернёт результат — резолвим промис
                }
            );
        });
        const arrayDaysThisMounth = await getDaysInRange(arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].startOfMonth, arraySelectedMounthsForDetailInformation[indexSelectedMountForDetailInformation].endOfMonth);

        let arrayProcentsResultsMachine = [];
        let arrayTimesWorkMachine = [];
        let arrayDetails = [];

        Object.values(arrayDaysThisMounth).forEach(day => {
            const logsThisDay = filterAndSortByKeyRange(day.startDateMs, day.endDateMs, allLogsSelectedMounth);
            if(logsThisDay.length > 0){
                let arrayProcentResultThisDay = [];
                let timeWorkMachine = 0;
                let arrayLogsThisDayProiz = [];
                Object.values(logsThisDay).forEach(log => {
                    if(log.typeLog == "Производство"){
                        arrayLogsThisDayProiz.push(log);
                        timeWorkMachine += Number(log.endTime) - Number(log.startTime);
                        const workTime = Math.round(((Number(log.endTime) - Number(log.startTime)) / 1000));
                        const machineWork = Number(log.countDetails) * (Number(minSecToSeconds(log.timeDetail)) + Number(minSecToSeconds(log.timeChangeDetail)));
                        const procentResult = Math.round(machineWork / workTime * 100);
                        arrayProcentResultThisDay.push(procentResult);  
                        const objDetail = {
                            installName: `${log.detail} (${log.install})`,
                            countDetails: log.countDetails
                        }      
                        arrayDetails.push(objDetail); 
                    }
                });
                arrayTimesWorkMachine.push(timeWorkMachine);
                arrayProcentsResultsMachine.push(Math.round(calculateAverage(arrayProcentResultThisDay)));                    

                htmlDiagrams += `
                    <div class="item" onclick="changeInformationToDayForMachineDetailsInFormationMounth(event, '${JSON.stringify(arrayLogsThisDayProiz).replace(/"/g, '&quot;')}')">
                        <div class="bg-diagram">
                            <div style="height: ${Math.round(calculateAverage(arrayProcentResultThisDay))}%" class="result">${Math.round(calculateAverage(arrayProcentResultThisDay))}%</div>
                        </div>
                        <p>${day.day}</p>
                    </div>
                `;
            }
        });
        containerDiagramsForDetailInformationMounthMachine.innerHTML = htmlDiagrams;
        
        let htmlDetails = '';
        let detailsSummary = {};

        for (let index in arrayDetails) {
            const item = arrayDetails[index];
            if (detailsSummary[item.installName]) {
                detailsSummary[item.installName] += Number(item.countDetails);
            } else {
                detailsSummary[item.installName] = Number(item.countDetails);
            }
        }

        for (let installName in detailsSummary) {
            htmlDetails += `
                <div class="container-info">
                    <p>${installName}:</p>
                    <span>${detailsSummary[installName]} шт.</span> 
                </div>
            `;
        }
        containerGeneralInformationForMounthForMachineDetailInformation.innerHTML = `
            <h5>Детальная информация</h5>
            <div class="container-info">
                <p>Время работы станка:</p>
                <span>${secondsToTimeFormat(arrayTimesWorkMachine.reduce((acc, num) => acc + num, 0) / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Средний показатель продуктивности:</p>
                <span>${Math.round(calculateAverage(arrayProcentsResultsMachine))}%</span>
            </div>
            <h5>Изготовленные детали:</h5>
            ${htmlDetails}
        `;
    }

    function closeAllertForDetailsInformationForMachineForMounth(){
        document.querySelector('#allertDetailInformationForMachine').classList.remove('display-none');
        document.querySelector('#allertDetailInformationForMachineMounth').classList.add('display-none');
    }

    function changeInformationToDayForMachineDetailsInFormationMounth(event, arrayLogs){
        const jsonString = arrayLogs.replace(/&quot;/g, '"');
        arrayLogs = JSON.parse(jsonString);
        let timeWorkMachine = 0;
        let arrayProcents = [];
        
        let logsHtml = ``;
        let arrayDetails = [];
        // какая тут онформация по дню может быть интересна: время работы станка, средний показатель продуктивности, ну и в каком то нормальном формате вывести кто работал, 
        // сколько и чего сделал, количество деталей, так же можно сделать что бы было видно кто и что настроил, и в статистике по дню это ввести
        event.stopPropagation();
        const containerDayInformationForMounthForMachineDetailInformation = document.querySelector(`#containerDayInformationForMounthForMachineDetailInformation`);
        document.querySelector(`#containerGeneralInformationForMounthForMachineDetailInformation`).classList.add('display-none');
        containerDayInformationForMounthForMachineDetailInformation.classList.remove('display-none');

        Object.values(arrayLogs).forEach(log => {
            timeWorkMachine += Number(log.endTime) - Number(log.startTime);
            const workTime = Math.round(((Number(log.endTime) - Number(log.startTime)) / 1000));
            const machineWork = Number(log.countDetails) * (Number(minSecToSeconds(log.timeDetail)) + Number(minSecToSeconds(log.timeChangeDetail)));
            const procentResult = Math.round(machineWork / workTime * 100);
            arrayProcents.push(procentResult);  
            const objDetail = {
                installName: `${log.detail} (${log.install})`,
                countDetails: log.countDetails
            }      
            arrayDetails.push(objDetail); 
            
            logsHtml += `
                <div class="container-info">
                    <p>Оператор:</p>
                    <span>${formatName(log.operator)}</span>
                </div>
                <div class="container-info">
                    <p>Установка:</p>
                    <span>${log.detail}(${log.install})</span>
                </div>
                <div class="container-info">
                    <p>Количество деталей:</p>
                    <span>${log.countDetails}</span>
                </div>
                <div class="container-info">
                    <p>Время детали:</p>
                    <span>${log.timeDetail}(${log.timeChangeDetail})</span>
                </div>
                <div class="container-info">
                    <p>Время работы на станке:</p>
                    <span>${secondsToTimeFormat((log.endTime - log.startTime) / 1000)}</span>
                </div>
                <div class="container-info">
                    <p>Время работы станка:</p>
                    <span>${secondsToTimeFormat(((log.endTime - log.startTime) / 1000) * (procentResult / 100))}</span>
                </div>
                <div class="container-info">
                    <p>Показатель продуктивности:</p>
                    <span>${procentResult}%</span>
                </div>
            `;
        });

        let htmlDetails = '';
        let detailsSummary = {};

        for (let index in arrayDetails) {
            const item = arrayDetails[index];
            if (detailsSummary[item.installName]) {
                detailsSummary[item.installName] += Number(item.countDetails);
            } else {
                detailsSummary[item.installName] = Number(item.countDetails);
            }
        }

        for (let installName in detailsSummary) {
            htmlDetails += `
                <div class="container-info">
                    <p>${installName}:</p>
                    <span>${detailsSummary[installName]} шт.</span> 
                </div>
            `;
        }

        containerDayInformationForMounthForMachineDetailInformation.innerHTML = `
            <h5>${getDayAndMounthInDateNow(Number(arrayLogs[0].startTime))}</h5>
            <div class="container-info">
                <p>Время работы станка:</p>
                <span>${secondsToTimeFormat(timeWorkMachine / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Средний показатель продуктивности:</p>
                <span>${calculateAverage(arrayProcents)}%</span>
            </div>
            <h5>Изготовленные детали:</h5>
            ${htmlDetails}
            <h5>Подробная информация:</h5>
            ${logsHtml}
        `;

    }

    function changeInformationToGeneralForMachineDetailsInFormationMounth(){
        document.querySelector(`#containerDayInformationForMounthForMachineDetailInformation`).classList.add('display-none');
        document.querySelector(`#containerGeneralInformationForMounthForMachineDetailInformation`).classList.remove('display-none');
    }
    
    async function openAllertDetailInFormationForMachinePeriod(){
        document.querySelector('#allertDetailInformationForMachinePeriod').classList.remove('display-none');
        document.querySelector('#allertDetailInformationForMachine').classList.add('display-none');
         
        document.querySelector('#containerDayInformationForPeriodForMachineDetailInformation').classList.add('display-none');
        document.querySelector('#containerGeneralInformationForPeriodForMachineDetailInformation').classList.remove('display-none');

        document.querySelector(`#h2NameMachineDetailInformationForPeriod`).textContent = machineObjForDetailInformation.name;
        document.querySelector(`#h2DateDetailInformationForPeriodMachine`).textContent = `${formatedDate(getDateValueInInput(`inputStartDateForMachineDetailInfo`))} - ${formatedDate(getDateValueInInput(`inputEndDateForMachineDetailInfo`))}`;

        const containerDiagramsForDetailInformationPeriodMachine = document.querySelector(`#containerDiagramsForDetailInformationPeriodMachine`);

        const containerGeneralInformationForPeriodForMachineDetailInformation = document.querySelector(`#containerGeneralInformationForPeriodForMachineDetailInformation`);

        containerDiagramsForDetailInformationPeriodMachine.innerHTML = '';
        containerGeneralInformationForPeriodForMachineDetailInformation.innerHTML = '';

        let htmlDiagrams = ``;
        // тут придумать как найти диапазон периода
        const allLogsSelectedPeriod = await filterAndSortByKeyRangeAndKey(getDateValueInInput(`inputStartDateForMachineDetailInfo`), getDateValueInInput(`inputEndDateForMachineDetailInfo`), machineLogsForDetailInformation);
        const arrayDaysThisPeriod = await getDaysInRange(getDateValueInInput(`inputStartDateForMachineDetailInfo`), getDateValueInInput(`inputEndDateForMachineDetailInfo`));

        let arrayProcentsResultsMachine = [];
        let arrayTimesWorkMachine = [];
        let arrayDetails = [];

        Object.values(arrayDaysThisPeriod).forEach(day => {
            const logsThisDay = filterAndSortByKeyRange(day.startDateMs, day.endDateMs, allLogsSelectedPeriod);
            if(logsThisDay.length > 0){
                let arrayProcentResultThisDay = [];
                let timeWorkMachine = 0;
                let arrayLogsThisDayProiz = [];
                Object.values(logsThisDay).forEach(log => {
                    if(log.typeLog == "Производство"){
                        arrayLogsThisDayProiz.push(log);
                        timeWorkMachine += Number(log.endTime) - Number(log.startTime);
                        const workTime = Math.round(((Number(log.endTime) - Number(log.startTime)) / 1000));
                        const machineWork = Number(log.countDetails) * (Number(minSecToSeconds(log.timeDetail)) + Number(minSecToSeconds(log.timeChangeDetail)));
                        const procentResult = Math.round(machineWork / workTime * 100);
                        arrayProcentResultThisDay.push(procentResult);  
                        const objDetail = {
                            installName: `${log.detail} (${log.install})`,
                            countDetails: log.countDetails
                        }      
                        arrayDetails.push(objDetail); 
                    }
                });
                arrayTimesWorkMachine.push(timeWorkMachine);
                arrayProcentsResultsMachine.push(Math.round(calculateAverage(arrayProcentResultThisDay)));                    

                htmlDiagrams += `
                    <div class="item" onclick="changeInformationToDayForMachineDetailsInFormationPeriod(event, '${JSON.stringify(arrayLogsThisDayProiz).replace(/"/g, '&quot;')}')">
                        <div class="bg-diagram">
                            <div style="height: ${Math.round(calculateAverage(arrayProcentResultThisDay))}%" class="result">${Math.round(calculateAverage(arrayProcentResultThisDay))}%</div>
                        </div>
                        <p>${day.day}</p>
                    </div>
                `;
            }
        });
        containerDiagramsForDetailInformationPeriodMachine.innerHTML = htmlDiagrams;
        
        let htmlDetails = '';
        let detailsSummary = {};

        for (let index in arrayDetails) {
            const item = arrayDetails[index];
            if (detailsSummary[item.installName]) {
                detailsSummary[item.installName] += Number(item.countDetails);
            } else {
                detailsSummary[item.installName] = Number(item.countDetails);
            }
        }

        for (let installName in detailsSummary) {
            htmlDetails += `
                <div class="container-info">
                    <p>${installName}:</p>
                    <span>${detailsSummary[installName]} шт.</span> 
                </div>
            `;
        }
        containerGeneralInformationForPeriodForMachineDetailInformation.innerHTML = `
            <h5>Детальная информация</h5>
            <div class="container-info">
                <p>Время работы станка:</p>
                <span>${secondsToTimeFormat(arrayTimesWorkMachine.reduce((acc, num) => acc + num, 0) / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Средний показатель продуктивности:</p>
                <span>${Math.round(calculateAverage(arrayProcentsResultsMachine))}%</span>
            </div>
            <h5>Изготовленные детали:</h5>
            ${htmlDetails}
        `;
    }

    function closeAllertForDetailsInformationForMachineForPeriod(){
        document.querySelector('#allertDetailInformationForMachine').classList.remove('display-none');
        document.querySelector('#allertDetailInformationForMachinePeriod').classList.add('display-none');
    }

    function changeInformationToDayForMachineDetailsInFormationPeriod(event, arrayLogs){
        const jsonString = arrayLogs.replace(/&quot;/g, '"');
        arrayLogs = JSON.parse(jsonString);
        let timeWorkMachine = 0;
        let arrayProcents = [];
        
        let logsHtml = ``;
        let arrayDetails = [];
        // какая тут онформация по дню может быть интересна: время работы станка, средний показатель продуктивности, ну и в каком то нормальном формате вывести кто работал, 
        // сколько и чего сделал, количество деталей, так же можно сделать что бы было видно кто и что настроил, и в статистике по дню это ввести
        event.stopPropagation();
        const containerDayInformationForPeriodForMachineDetailInformation = document.querySelector(`#containerDayInformationForPeriodForMachineDetailInformation`);
        document.querySelector(`#containerGeneralInformationForPeriodForMachineDetailInformation`).classList.add('display-none');
        containerDayInformationForPeriodForMachineDetailInformation.classList.remove('display-none');

        Object.values(arrayLogs).forEach(log => {
            timeWorkMachine += Number(log.endTime) - Number(log.startTime);
            const workTime = Math.round(((Number(log.endTime) - Number(log.startTime)) / 1000));
            const machineWork = Number(log.countDetails) * (Number(minSecToSeconds(log.timeDetail)) + Number(minSecToSeconds(log.timeChangeDetail)));
            const procentResult = Math.round(machineWork / workTime * 100);
            arrayProcents.push(procentResult);  
            const objDetail = {
                installName: `${log.detail} (${log.install})`,
                countDetails: log.countDetails
            }      
            arrayDetails.push(objDetail); 
            
            logsHtml += `
                <div class="container-info">
                    <p>Оператор:</p>
                    <span>${formatName(log.operator)}</span>
                </div>
                <div class="container-info">
                    <p>Установка:</p>
                    <span>${log.detail}(${log.install})</span>
                </div>
                <div class="container-info">
                    <p>Количество деталей:</p>
                    <span>${log.countDetails}</span>
                </div>
                <div class="container-info">
                    <p>Время детали:</p>
                    <span>${log.timeDetail}(${log.timeChangeDetail})</span>
                </div>
                <div class="container-info">
                    <p>Время работы на станке:</p>
                    <span>${secondsToTimeFormat((log.endTime - log.startTime) / 1000)}</span>
                </div>
                <div class="container-info">
                    <p>Время работы станка:</p>
                    <span>${secondsToTimeFormat(((log.endTime - log.startTime) / 1000) * (procentResult / 100))}</span>
                </div>
                <div class="container-info">
                    <p>Показатель продуктивности:</p>
                    <span>${procentResult}%</span>
                </div>
            `;
        });

        let htmlDetails = '';
        let detailsSummary = {};

        for (let index in arrayDetails) {
            const item = arrayDetails[index];
            if (detailsSummary[item.installName]) {
                detailsSummary[item.installName] += Number(item.countDetails);
            } else {
                detailsSummary[item.installName] = Number(item.countDetails);
            }
        }

        for (let installName in detailsSummary) {
            htmlDetails += `
                <div class="container-info">
                    <p>${installName}:</p>
                    <span>${detailsSummary[installName]} шт.</span> 
                </div>
            `;
        }

        containerDayInformationForPeriodForMachineDetailInformation.innerHTML = `
            <h5>${getDayAndMounthInDateNow(Number(arrayLogs[0].startTime))}</h5>
            <div class="container-info">
                <p>Время работы станка:</p>
                <span>${secondsToTimeFormat(timeWorkMachine / 1000)}</span>
            </div>
            <div class="container-info">
                <p>Средний показатель продуктивности:</p>
                <span>${calculateAverage(arrayProcents)}%</span>
            </div>
            <h5>Изготовленные детали:</h5>
            ${htmlDetails}
            <h5>Подробная информация:</h5>
            ${logsHtml}
        `;

    }

    function changeInformationToGeneralForMachineDetailsInFormationPeriod(){
        document.querySelector(`#containerDayInformationForPeriodForMachineDetailInformation`).classList.add('display-none');
        document.querySelector(`#containerGeneralInformationForPeriodForMachineDetailInformation`).classList.remove('display-none');
    }
    
    function openAllertDownload(){
        document.querySelector(`#bgDownloadSpinner`).classList.remove(`display-none`);
        document.querySelector(`#downloadSpinner`).classList.remove(`display-none`);
    }

    function closeAllertDownload(){
        document.querySelector(`#bgDownloadSpinner`).classList.add(`display-none`);
        document.querySelector(`#downloadSpinner`).classList.add(`display-none`);
    }

    function addNewRole(){ 
        const inputRoleName = document.querySelector(`#inputNameNewRole`);
        const roleName = inputRoleName.value.trim();
        const pErrorAddNewRole = document.querySelector(`#pErrorAddNewRole`);

        const cbWorkInMachine = document.querySelector(`#cbWorkInMachine`);
        const cbSetupMachine = document.querySelector(`#cbSetupMachine`);
        
        if(roleName.length > 2){
            readToFirebase(`roles/${transliterate(roleName.toLowerCase())}`, role => {
                if(!role){
                    pErrorAddNewRole.classList.add(`display-none`);
                    let objNewRole = {
                        name: `${roleName}`,
                    };

                    objNewRole.workInMachine = cbWorkInMachine.checked;
                    objNewRole.setupMachine = cbSetupMachine.checked;

                    writeToFirebase(`roles/${transliterate(roleName.toLowerCase())}`, objNewRole);
                    inputRoleName.value = '';
                } else {
                    pErrorAddNewRole.classList.remove('display-none');
                    pErrorAddNewRole.textContent = `Должность с таким именем уже существует`;

                }
            });
        } else {
            pErrorAddNewRole.classList.remove('display-none');
            pErrorAddNewRole.textContent = `Название должно быть минимум 3 символа`;
        }
    }


</script>
</body>
</html>
