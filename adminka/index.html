<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css" type="text/css">
    <title>Админ панель</title>
    <link rel="shortcut icon" href="#">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/imask"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="../functions.js"></script>
    
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Мой сайт">
    <link rel="apple-touch-icon" href="../icon.png">
    <link rel="manifest" href="../manifest.json">

</head>
<body> 
    <div class="leftColumn">
        <header><h5>Админ меню</h5></header>
        <div class="main-part">
            <div onclick="selectPanel('workers-panel')" class="item">
                <i class="fa-solid fa-user-secret"></i>
                <p>Работники</p>
            </div>
            <div onclick="selectPanel('machines-panel')" class="item">
                <i class="fa-solid fa-robot"></i>
                <p>Станки</p>
            </div>
            <div onclick="selectPanel('details-panel')" class="item">
                <i class="fa-solid fa-gears"></i>
                <p>Детали</p>
            </div>
            
        </div>
    </div>
    <div></div>
    <div class="centerColumn">
        <header></header>
        <div class="title-div">
            <h2 id="h2TitlePanel"></h2>
            <i id="iconStatWorkersTwoWeek" style="color: #777; font-size: 24px; cursor: pointer;" class="fas fa-chart-line" onclick="printStatWorkersTwoWeek()"></i>
        </div>
        <div class="main-part">
            <div id="workers-panel" class="display-none">
                <div class="div-white-bg">
                    <input oninput="searchWorkerInTable()" id="inputSearchFioWorker" placeholder="Введите ФИО человек для поиска..." type="text">
                </div>
                <div class="div-white-bg">
                    <table>
                        <thead>
                            <tr>
                                <th>ФИО</th>
                                <th>Статус</th>
                                <th>Рабочие места</th>
                                <th>Начало рабочей смены</th>
                                <th style="text-align: center;">Изменить</th>
                                <th style="text-align: center;">Удалить</th>
                            </tr>
                        </thead>
                        <tbody id="tb-workers-table" style="max-height: 400px; overflow-y: auto;">
                            <tr><td colspan="5">Нет данных</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="div-white-bg">
                    <h2>Добавление нового работника</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением нового человека</h5>
                        </div>
                        <div class="container-form">
                            <h5>ФИО Человека</h5>
                            <input id="inputNameAddNewWorker" type="text">
                            <h5>Должность человека</h5>
                            <select id="selectRoleAddNewWorker">
                                <option value="">Выберите должность человека</option>
                                <option value="operator">Оператор</option>
                                <option value="naladchik">Наладчик</option>
                            </select>
                            <h5>Фото человека для входа в систему</h5>
                            <input id="inputPhotoAddNewWorker" type="file" accept="image/*">
                            <p id="pErrorAddNewWorker" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля.</p>
                            <button onclick="addNewWorker()">Добавить</button>
                        </div>
                    </div>
                </div>
                <div class="div-white-bg">
                    <h2>Добавление новой должности</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением новой должности</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название должности</h5>
                            <input id="inputNameNewRole" type="text">
                            <h5>Выберите уровни доступа</h5>
                            <div class="container-checkbox-add-role">
                                <input id="cbWorkInMachine" type="checkbox">
                                <p>Работать на станках</p>
                            </div>
                            <div class="container-checkbox-add-role">
                                <input id="cbSetupMachine" type="checkbox">
                                <p>Настраивать станки</p>
                            </div>
                            <div class="container-checkbox-add-role">
                                <input id="cbDetailsMenu" type="checkbox">
                                <p>Добавление деталей и установок</p>
                            </div>
                            <div class="container-checkbox-add-role">
                                <input id="cbCheckCountDetails" type="checkbox">
                                <p>Проверка количества деталей</p>
                            </div>
                            <div class="container-checkbox-add-role">
                                <input id="cbStorageDetails" type="checkbox">
                                <p>Склад деталей</p>
                            </div>
                            <p id="pErrorAddNewRole" style="margin-bottom: 12px !important;" class="p-error display-none"></p>
                            <button onclick="addNewRole()">Добавить</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="machines-panel">
                <div id="containerTablesMachines"></div>
                <div class="div-white-bg">
                    <h2>Добавление нового станка</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением нового станка</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название станка</h5>
                            <input id="inputNameNewMachine" type="text">
                            <h5>Тип станка</h5>
                            <select id="selectTypesMachinesForAddMachine">
                                <option value="">Выберите тип станка</option>
                            </select>
                            <p id="pErrorAddNewMachine" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля</p>
                            <button onclick="addNewMachine()">Добавить</button>
                        </div>
                    </div>
                </div>
                <div class="div-white-bg">
                    <h2>Добавить новую группу станков</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Тут можно поставить какое-то уведомление связанно с добавлением новой группы станков</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название новой группы станков</h5>
                            <input id="inputNameNewTypeMachine" type="text">
                            <p id="pErrorTypeMachineAdd" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля</p>
                            <button onclick="addNewMachineGroup()">Добавить</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="details-panel">
                <div class="div-white-bg">
                    <div class="div-input-container">
                        <input id="inputSearchDetailInTableDetailsPanel" placeholder="Введите название детали или чертежа для поиска..." type="text">
                        <button onclick="clickSearchDetailsInDetailsPanel()">Поиск</button>
                    </div>
                </div>
                <div class="div-white-bg">
                    <h2>Все детали</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Номер чертежа</th>
                                <th>Количество<br/>установок</th>
                                <th style="text-align: center;">Удалить</th>
                            </tr>
                        </thead>
                        <tbody id="tb-details-table" style="max-height: 400px; overflow-y: auto;"> </tbody>
                    </table>
                    <div class="navigation-menu-table">
                        <div style="width: 100%; display: flex; justify-content: center;">
                            <button>Загрузить еще</button>
                        </div>
                        <h5>Загружено 0 из 0</h5>
                    </div>
                </div>
                <div class="div-white-bg">
                    <h2>Добавить новую деталь</h2>
                    <div class="div-container-add-menu">
                        <div class="div-description">
                            <h5>Перед добавлением новой детали убедитесь, что она ещё не была добавлена ранее, чтобы избежать дублирования</h5>
                        </div>
                        <div class="container-form">
                            <h5>Название новой детали</h5>
                            <input id="inputNameNewDetail" type="text">
                            <h5>Название чертежа детали</h5>
                            <input id="inputNameDrawNewDetail" type="text">
                            <p id="pErrorAddNewDetail" style="margin-bottom: 12px !important;" class="p-error display-none">Ошибка. Заполните все поля</p>
                            <button onclick="addNewDetail()">Добавить</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div onclick="closeAllAllerts()" id="bg-allert" class="display-none"></div>

    <div id="allertMountPanelForDetailInformation" style="width: 1000px; max-width: 95%;" class="display-none allert">
        <h2 id="h2TitleNameMountPanelForDetailInformation"></h2>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <i style="cursor: pointer; font-size: 44px;" id="buttonPreviousMountPanel" class="fa fa-chevron-left"></i>
            <div>
                <div class="container-mount">
                    <h3 id="h3YearMountPanelForDetailInformation"></h3>
                    <div style="display: flex; align-items: center;">
                        <h3 id="h3MountNameUkrMountPanelForDetailInformation"></h3>
                        <i style="color: #777; margin-left: 12px; cursor: pointer;" id="buttonDetailInformationChartMounth" class="fas fa-chart-line"></i>
                    </div>
                    <h3 id="h3MountNameRusMountPanelForDetailInformation"></h3>
                </div>
                <div class="container-days-name">
                    <p>Понедельник</p>
                    <p>Вторник</p>
                    <p>Среда</p>
                    <p>Четверг</p>
                    <p>Пятница</p>
                    <p>Суббота</p>
                    <p>Воскресенье</p>
                </div>
                <div id="containerDatesCalendar" class="container-days-mount"></div>
            </div>
            <i style="cursor: pointer; font-size: 44px;" id="buttonNextMountPanel" class="fa fa-chevron-right"></i>
        </div>
    </div>

    <div id="allertCalculateSalary" class="alert-window display-none" style="width: 300px;">
        <h3 style="text-align: center;">Расчитать ЗП</h3>
        <div class="container">
            <p>Количество часов:</p>
            <span id="spanCountHoursForAllertSalary"></span>
        </div>
        <div class="container">
            <p>Отнять время на обед</p>
            <input onclick="calculateSumSalary()" id="checkboxMinusTimeObed" type="checkbox">
        </div>
        <div class="container">
            <p>Отнять время на переодевачку</p>
            <input onclick="calculateSumSalary()" id="checkboxMinusTimePereodevachka" type="checkbox">
        </div>
        <input oninput="calculateSumSalary()" type="number" style="text-align: center;" id="inputSumHoursForCalculateSalary" placeholder="Введите почасовую ставку в грн...">
        <div class="container">
            <p>Итого часов работы:</p>
            <span id="spanCountHoursForCalculateSalary"></span>
        </div>
        <div class="container">
            <p>Итого ЗП:</p>
            <span id="spanResSumSalary"> грн</span>
        </div>
        <button id="buttonPayedSalaryWorker" style="background-color: green; margin-bottom: 8px; box-shadow: 0 .125rem .75rem rgb(7, 116, 7);">Оплачено</button>
        <button onclick="closeAllertCalculatesalary()">Закрыть</button>
    </div>

    <div id="rotateAlert" class="rotate-alert">
        <div class="rotate-content">
            <i class="fas fa-sync-alt"></i>
            <h2>Поверните устройство</h2>
            <p>Для корректной работы приложения используйте горизонтальное положение экрана.</p>
        </div>
    </div>

    <div id="allertConfirmDelete" class="display-none">
        <h5>Подтвердить удаление?</h5>
        <button onclick="clickConfirmAllertDelete()">Подтвердить</button>
    </div>

    <div id="allertStatWorkersTwoWeen" class="alert-window display-none">
        <div style="display: flex; width: 100%; justify-content: space-between;">
            <h2>Табель рабочих смен за две недели</h2>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <i class="fa fa-angle-double-left" onclick="currentStatDate -= 1209600000; printStatWorkersTwoWeek()"></i>
                <i class="fa fa-chevron-left" onclick="currentStatDate -= 604800000; printStatWorkersTwoWeek()"></i>
                <h2 style="margin: 0px 12px;" id="h2DateRangeStatTwoWeekWorkers"></h2>
                <i class="fa fa-chevron-right" onclick="currentStatDate += 604800000; printStatWorkersTwoWeek()"></i>
                <i class="fa fa-angle-double-right" onclick="currentStatDate += 1209600000; printStatWorkersTwoWeek()"></i>
            </div>
        </div>
        <input oninput="searchWorkerInTableTwoWeekStat()" id="inputSearchWorkerInStatTwoWeek" placeholder="Введите ФИО человек для поиска..." type="text" style="margin: 16px 0px;">
        <table>
            <thead id="tHeadTableStatWorkersTwoWeek"></thead>
            <tbody id="tbodyTableStatWorkersTwoWeek" style="max-height: 400px; overflow-y: auto;"></tbody>
        </table>

    </div>
    
    <div id="allertReductDetail" class="allert display-none">
        <h2 id="h2DetailNameForReductDetail"></h2>
        <h5 id="h5NameDrawDetailForReructDetail"></h5>
        <h5 id="h5CountInstallsDetailForReductDetail" style="padding-bottom: 6px; margin-bottom: 12px; border-bottom: 1px solid #e4e9f3;"></h5>
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>Название установки</th>
                    <th>Тип станков</th>
                    <th style="text-align: center;">Удалить</th>
                </tr>
            </thead>
            <tbody id="bodyDetailInstallsForReduct"> </tbody>
        </table>
        <div style="display: flex; margin-top: 12px; justify-content: center;">
            <div class="div-description">
                <p>Тут можно поставить какое-то уведомление связанно с добавлением новой детали</p>
            </div>
            <div class="container-form">
                <h5>Название установки</h5>
                <input id="inputNewInstallNameForDetail" type="text" placeholder="Название новой установки">
                <h5>Выберите группу станков</h5>
                <select id="selectTypesMachinesForReductDetail">
                    <option value="">Выберите тип станков</option>
                </select>
                <p class="p-error display-none" id="pErrorAddNewInstallForDetail" style="margin-bottom: 6px !important;"></p>
                <button>Добавить</button>
            </div>
        </div>
    </div>

    <div id="allertReductInformationWorker" style="max-width: 400px;" class="allert display-none">
        <h2 id="h2TitleFioWorkerForReductInformation"></h2>
            <div style="max-height: 300px; overflow-y: auto;">
                <div>
                    <h5>Текущая должность:</h5>
                    <input id="inputActualRoleForReductInformationWorker" type="text" readonly>
                    <h5 style="margin-top: 12px; margin-bottom: 8px;">Выберите новую должность</h5>
                    <select id="selectListRolesForReductInformationWorker" style="width: 100%;">
                        <option value="">Выберите новую должность</option>
                    </select>
                    <p style="margin-bottom: 7px !important;" id="pErrorNewRoleForReductInformationWorker" class="p-error display-none"></p>
                    <button id="buttonChangeRoleForReductInformationWorker">Изменить</button>
                </div>
                <div style="margin-top: 24px;">
                    <h5>Изменить ФИО</h5>
                    <input id="inputNewFioForReductInformationWorker" style="margin-bottom: 20px;" type="text" placeholder="Введите новое ФИО">
                    <p style="margin-bottom: 7px !important;" id="pErrorNewFioForReductIntormationWorker" class="p-error display-none"></p>
                    <button id="buttonChangeFioForReductInformationWorker">Изменить</button>
                </div>
        </div>
        
    </div>

    <div id="allertDetailInformationChart" style="z-index: 150;" class="allert display-none">
        <div style="width: 100%; display: flex; justify-content: space-between;">
            <h2 id="h2TitleNameAllertDetailInformation"></h2>
            <div style="display: flex; flex-direction: column; align-items: end;">
                <h2 id="h2TitleDateAllertDetailInformation"></h2>
                <div class="container-types-diagrams">
                    <div id="containerTypesChart" style="margin-right: 8px;" class="bg-types">
                        <div onclick="changeTypeChartInDetailInformationChart('pie')" id="buttonChangeTypeChartToPie"><i class="fas fa-chart-pie"></i></div>
                        <div onclick="changeTypeChartInDetailInformationChart('line')" id="buttonChangeTypeChartToLine"><i class="fas fa-chart-line"></i></div>
                        <div onclick="changeTypeChartInDetailInformationChart('diagram')" id="buttonChangeTypeChartToDiagram"><i class="fas fa-chart-bar"></i></div>
                    </div>
                        <div id="containerTypesDataInChart" class="bg-types">
                        <div onclick="changeTypeDataInDetailInformationChart('time')" id="buttonChangeTypeChartToTime"><i class="fas fa-clock"></i></div>
                        <div onclick="changeTypeDataInDetailInformationChart('procent')"  id="buttonChangeTypeChartToProcent"><i class="fas fa-percent"></i></div>
                        <div onclick="changeTypeDataInDetailInformationChart('details')"  id="buttonChangeTypeChartToDetails"><i class="fas fa-cogs"></i></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mainPart">
            <div id="containerChartForAllertDetailInformation" class="container-diagram"></div>
            <div class="div-cont-general-info-for-allert-chart">
                <div id="containerGeneralInformationAllertChart" class="container-general-information"></div>
                <div class="div-buttons">
                    <button onclick="clickCloseAllertChart()" style="background-color: brown; cursor: pointer;">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="bgDownloadSpinner" class="display-none"></div>
    <div id="downloadSpinner" class="display-none"></div>
<script>
    
    const apiLink = `https://vps-api.ngrok.dev`;

    let typeOperationForDelete = '';
    let nameForDelete = '';
    let typeFordelete = '';

    let currentStatDate = Date.now();

    let downloadStartTime = null;
    let downloadTimer = null;

    // Переменные для отрисовки графика
    let actualDataForChartTime = [];
    let actualDataForChartProcent = [];
    let actualDataForChartCountDetails = [];
    let actualTypeChart = '';
    let actualTypeDataChart = '';

    const limitForDownloadDetailsInDb = 25;

    selectPanel('workers-panel');


    function selectPanel(selectedPanel) {
        const listPanels = ['workers-panel', 'machines-panel', 'details-panel'];
        listPanels.forEach(panel => {
            document.querySelector(`#${panel}`).classList.add('display-none');
        });

        if(selectedPanel == 'workers-panel'){
            document.querySelector(`#iconStatWorkersTwoWeek`).classList.remove('display-none');
            printWorkersPanel();
        } else if(selectedPanel == 'machines-panel'){
            document.querySelector(`#iconStatWorkersTwoWeek`).classList.add('display-none');
            printMachinesPanel();
        } else if(selectedPanel == 'details-panel'){
            document.querySelector(`#iconStatWorkersTwoWeek`).classList.add('display-none');
            printDetailsPanel();
        }
    }

    function printWorkersPanel(){
        openAllertDownload();
        document.querySelector('#h2TitlePanel').textContent = `Работники`;
        document.querySelector('#workers-panel').classList.remove('display-none');
        printTableWorkersPanel();
        printSelectRoleWorker();

        function printTableWorkersPanel(){
            const bodyTableWorkers = document.querySelector(`#tb-workers-table`);
            listenToFirebase(`workers`, data => {
                if(!data){
                    bodyTableWorkers.innerHTML = `<tr><td colspan='6'>Нет данных</td></tr>`;
                    closeAllertDownload();
                    return;
                }

                const sortedWorkers = Object.entries(data).sort(([, a], [, b]) => {
                    const isAGuard = a.role === 'okhrana';
                    const isBGuard = b.role === 'okhrana';

                    if (isAGuard && !isBGuard) return 1;
                    if (!isAGuard && isBGuard) return -1;

                    return a.fio.localeCompare(b.fio);
                });


                bodyTableWorkers.innerHTML = '';
                const timeNow = Date.now();

                for (const [key, worker] of sortedWorkers) {
                    const statusClass = worker.status === "На работе" ? "green-allocation" : "";
                    const time = formatDate(worker.dateActualyWorkDay);
                    let actualyPlaces = '-';
                    let workerDateActualyWorkDay = '-';

                    if (worker.dateActualyWorkDay && !isNaN(new Date(worker.dateActualyWorkDay).getTime())) {
                        workerDateActualyWorkDay = formatDate(Number(worker.dateActualyWorkDay));
                    }

                    if(worker.status == `На работе`){
                        try{
                            actualyPlaces = '';
                            Object.values(worker.actualyLogs).forEach(log => {
                                actualyPlaces += `${log.machine} -> ${log.detail} -> ${log.install} <br/><br/>`;
                            });
                        } catch (e){
                            actualyPlaces = '-';
                        }
                    }

                    bodyTableWorkers.innerHTML += `
                        <tr style="cursor: pointer;" onclick="openAllertMounthPanelForDetailInformation('worker','${transliterate(worker.fio)}', '${Date.now()}')" class="${statusClass}">
                            <td>${worker.fio}</td>
                            <td>${worker.status}</td>
                            <td>${actualyPlaces}</td>
                            <td>${workerDateActualyWorkDay}</td>
                            <td onclick="reductInfoWorker(event, '${transliterate(worker.fio)}')" style="text-align: center;"><i class="fas fa-edit"></i></td>
                            <td style="text-align: center;"><i onclick="openAllertConfirmDelete('worker','${key}', '-')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>
                        </tr>
                    `;
                    closeAllertDownload();
                };
            });
        }
    
        function printSelectRoleWorker(){
            const selectRole = document.querySelector(`#selectRoleAddNewWorker`);
            
            listenToFirebase(`roles`, roles => {
                selectRole.innerHTML = `<option value="">Выберите должность человека</option>`;
                if(roles){
                    Object.entries(roles).forEach(([key, role]) => {
                        selectRole.innerHTML += `<option value="${key}">${role.name}</option>`;
                    });
                }
            });
        }
    }

    function printMachinesPanel(){
        openAllertDownload();
        document.querySelector('#h2TitlePanel').textContent = `Станки`;
        document.querySelector('#machines-panel').classList.remove('display-none');
        printTableMachinePanel();
        printSelectTypesMachines();

        function printTableMachinePanel(){
            const containerTablesMachines = document.querySelector('#containerTablesMachines');
            listenToFirebase('machines', (data) => {
                if (!data) {
                    closeAllertDownload();
                    return;
                }
                
                containerTablesMachines.innerHTML = ''; // Очищаем контейнер перед добавлением
                
                Object.keys(data).forEach(categoryKey => {
                    const category = data[categoryKey];
                    if (!category.name || !category.machines) return;
                    
                    const tableDiv = document.createElement('div');
                    tableDiv.classList.add('div-white-bg');
                    
                    const title = document.createElement('h2');
                    title.textContent = category.name;
                    tableDiv.appendChild(title);
                    
                    const table = document.createElement('table');
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Название станка</th>
                                <th>Статус</th>
                                <th>Деталь</th>
                                <th>Установка</th>
                                <th>Время установки</th>
                                <th>Оператор</th>
                                <th>Наладчик</th>
                                <th>УП</th>
                                <th>Время работы</th>
                                <th style="text-align: center;">Инфо</th>
                                <th style="text-align: center;">Удалить</th>
                            </tr>
                        </thead>
                    `;
                    
                    const tbody = document.createElement('tbody');
                    Object.keys(category.machines).sort((a, b) => {
                        const numA = parseInt(a.match(/\d+$/));
                        const numB = parseInt(b.match(/\d+$/));
                        return numA - numB;
                    }).forEach(machineKey => {
                        const machine = category.machines[machineKey];
                        const row = document.createElement('tr');
                        
                        if (machine.status === 'Занят') {
                            row.classList.add('green-allocation');
                        } else if (machine.status === 'Настройка') {
                            row.classList.add('yellow-table');
                        }
                        
                        let timeWorkThisMachine = `-`;
                        if(getTimeDifference(Date.now(), machine.startTime) != `NaN:NaN`){
                            timeWorkThisMachine = getTimeDifference(Date.now(), machine.startTime);
                        }
                        row.innerHTML = `
                            <td>${machine.name}</td>
                            <td>${machine.status}</td>
                            <td>${machine.detail}</td>
                            <td>${machine.install}</td>
                            <td>${machine.timeDetail}(${machine.timeChangeDetail})</td>
                            <td>${formatName(machine.operator)}</td>
                            <td>${formatName(machine.naladchik)}</td>
                            <td>${machine.nameUp}</td>
                            <td>${timeWorkThisMachine}</td>
                            <td style="text-align: center;"><i onclick="clickDetailInformationMachine('${categoryKey}/machines/${machineKey}')" class="fas fa-info-circle"></i></td>
                            <td style="text-align: center;"><i onclick="openAllertConfirmDelete('machine', '${machine.systemName}', '${machine.typeMachine}')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    table.appendChild(tbody);
                    tableDiv.appendChild(table);
                    containerTablesMachines.appendChild(tableDiv);
                });
                closeAllertDownload();
            });
        }

        function printSelectTypesMachines() {
            const selectTypesMachinesForAddMachine = document.querySelector('#selectTypesMachinesForAddMachine');
            
            listenToFirebase('machines', (data) => {
                let res = '<option value="">Выберите тип станка</option>';
                if (!data) {
                    return;
                }
                Object.entries(data).forEach(([key, value]) => {
                    res += `<option value="${key}">${value.name}</option>`;
                });
                selectTypesMachinesForAddMachine.innerHTML = res;
            });
        }
    }

    async function printDetailsPanel(){
        await printDetailsInTableDetailsPanel(limitForDownloadDetailsInDb);
        document.querySelector('#h2TitlePanel').textContent = `Детали`;
        document.querySelector('#details-panel').classList.remove('display-none');
        
    }

    function printOrdersPanel(){
        document.querySelector('#h2TitlePanel').textContent = `Заказы`;
        document.querySelector('#orders-panel').classList.remove('display-none');
        // что должен показываться в каждом заказе
        // дата приема заказа, дата когда нужно сдать, перечисление деталей которые есть в спецификации, 
        // прогресс какой-то, количество отгрузок,  когда какие отгрузки, какие детали были в отгрузке и тд и тп 
        
        // от кого заказ
        // номер заказа
        // дата приема заказа
        // дата когда нужно сдать заказ
        // какой-то прогресс заказа
        // количество отгрузок
        // список деталей данного заказа
        // и рядом количество деталей которое уже отгрузили
        // номера накладных отгрузок
        // массив отгрузок что бы можно было посмотреть детальную информацию по отгрузке номер накладной и тд и тп
        // статус в работе, завершен
    }

    async function printDetailsInTableDetailsPanel(limit){
        openAllertDownload();
        const bodyTable = document.querySelector(`#tb-details-table`);
        bodyTable.innerHTML =  '';
        const details = await asyncReadFirstNItems(`details`, limit);
        if(details.length > 0){
            details.forEach(({ key, value: detail }) => {
                bodyTable.innerHTML += `
                    <tr style="cursor: pointer;" onclick="openAllertReductDetail('${detail.systemName}')"> 
                        <td>${detail.name}</td>    
                        <td>${detail.nameDraw}</td>    
                        <td>${detail.countInstalls}</td>
                        <td style="text-align: center;"><i onclick="openAllertConfirmDelete('detail','${detail.systemName}', '', event)" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>  
                    </tr>
                `;
            });
        } else {
            bodyTable.innerHTML = `
                <tr>
                    <td colspan="4">Детали не найдены</td>
                </tr>
            `;
        }

        const countAllDetail = await asyncReadToFirebase(`detailsCount`);
        if(limit > countAllDetail){
            document.querySelector(`#details-panel .navigation-menu-table h5`).textContent = `Загружено ${countAllDetail} из ${countAllDetail}`;
            document.querySelector(`#details-panel .navigation-menu-table button`).onclick = function () { };
        } else {
            document.querySelector(`#details-panel .navigation-menu-table h5`).textContent = `Загружено ${limit} из ${countAllDetail}`;
            document.querySelector(`#details-panel .navigation-menu-table button`).onclick = function () { printDetailsInTableDetailsPanel(limit+limitForDownloadDetailsInDb) };
        }

        closeAllertDownload();
    }

    function openAllertReductDetail(detailSystemName){
        console.log(`вібрал деталь`)
        openAllertDownload();
        listenToFirebase(`details/${detailSystemName}`, detail => {
            const bodyDetailInstallsForReduct = document.querySelector(`#bodyDetailInstallsForReduct`);
            bodyDetailInstallsForReduct.innerHTML = '';
            
            if(!detail.installs){
                bodyDetailInstallsForReduct.innerHTML += `
                    <tr>
                        <td colspan=3>Нет установок для данной детали</td>  
                    </tr>
                `;
            } else {
                Object.entries(detail.installs).forEach(([key, install]) => {
                    bodyDetailInstallsForReduct.innerHTML += `
                        <tr>
                            <td>${install.name}</td>    
                            <td>${install.typeMachinesName}</td>   
                            <td style="text-align: center"><i onclick="deleteInstallForDetail(${detail.countInstalls}, '${detailSystemName}', '${detailSystemName}/installs/${key}')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td> 
                        </tr>
                    `;
                });
            }
            
            document.querySelector(`#allertReductDetail`).classList.remove('display-none');
            document.querySelector(`#h2DetailNameForReductDetail`).textContent = `Меню установок для ${detail.name}`;
            document.querySelector(`#h5NameDrawDetailForReructDetail`).textContent = `Чертеж № ${detail.nameDraw}`;
            document.querySelector(`#h5CountInstallsDetailForReductDetail`).textContent = `Кол-во установок: ${detail.countInstalls}`;
            document.querySelector(`#bg-allert`).classList.remove('display-none');

            document.querySelector(`#inputNewInstallNameForDetail`).value = '';
            document.querySelector(`#pErrorAddNewInstallForDetail`).classList.add('display-none');

            readToFirebase(`machines`, machines => {
                const selectorTypeMachine = document.querySelector(`#selectTypesMachinesForReductDetail`);
                selectorTypeMachine.innerHTML = `<option value="">Выберите тип станков</option>`;
                Object.entries(machines).forEach(([key, typeMachines]) => {
                    selectorTypeMachine.innerHTML += `<option value="${key}">${typeMachines.name}</option>`;
                });
            })

            document.querySelector(`#allertReductDetail button`).onclick = function() { addNewInstallForDetail(detailSystemName, detail.countInstalls, `details/${detailSystemName}/installs/${detail.countInstalls}`) };
            closeAllertDownload();
        });
    }
  
    function addNewInstallForDetail(detailSystemName, detailCountInstalls, pathForAddNewInstall){
        const inputNewInstallNameForDetail = document.querySelector(`#inputNewInstallNameForDetail`);
        const selectTypesMachinesForReductDetail = document.querySelector(`#selectTypesMachinesForReductDetail`);
        const pError = document.querySelector(`#pErrorAddNewInstallForDetail`);
        const objNewInstall = {
            name : inputNewInstallNameForDetail.value,
            typeMachinesName : selectTypesMachinesForReductDetail.options[selectTypesMachinesForReductDetail.selectedIndex].textContent,
            typeMachinesSystemName : selectTypesMachinesForReductDetail.value
        };

        if(inputNewInstallNameForDetail.value.length > 2 && selectTypesMachinesForReductDetail.value.length > 0){
            writeToFirebase(pathForAddNewInstall, objNewInstall);
            overwriteToFirebase(`details/${detailSystemName}/countInstalls`, detailCountInstalls+1);
            pError.classList.add('display-none');
            inputNewInstallNameForDetail.value = '';
            selectTypesMachinesForReductDetail.value = '';
        } else {
            pError.classList.remove(`display-none`);
            pError.textContent = `Заполните все поля`;
        }
    }

    function deleteInstallForDetail(countInstallsDetail, detailSystemName, pathInstallForDelete){
        overwriteToFirebase(`details/${pathInstallForDelete}`, {});
        overwriteToFirebase(`details/${detailSystemName}/countInstalls`, countInstallsDetail-1);
    }

    function addNewWorker() {
        const inputNameWorker = document.querySelector('#inputNameAddNewWorker');
        const inputPhotoAddNewWorker = document.querySelector('#inputPhotoAddNewWorker');
        const selectRoleAddNewWorker = document.querySelector('#selectRoleAddNewWorker');
        const pError = document.querySelector(`#pErrorAddNewWorker`);

        if (inputNameWorker.value.length > 4 && selectRoleAddNewWorker.value != '' && inputPhotoAddNewWorker.files[0] && inputNameWorker.value.trim().split(/\s+/).length === 3) {
            
            const path = `workers/${transliterate(inputNameWorker.value)}`;
            const obj = {
                fio: inputNameWorker.value,
                status: 'Нет на работе',
                role: selectRoleAddNewWorker.value,
                dateActualyWorkDay: '',
                actualyLogs: '',
            }

            // Обработка ошибки записи в Firebase
            writeToFirebase(path, obj)
                .then(() => {
                    // Если запись в Firebase прошла успешно, отправляем фото
                    const formData = new FormData();
                    formData.append('name', transliterate(inputNameWorker.value)); 
                    formData.append('image', inputPhotoAddNewWorker.files[0]); 
                    

                    fetch(`${apiLink}/add_image`, {
                        method: 'POST',
                        body: formData,
                    })
                    .then(response => response.json())
                    .then(data => {
                        inputNameWorker.value = '';
                        selectRoleAddNewWorker.value = '';
                        inputPhotoAddNewWorker.value = '';
                        pError.classList.add(`display-none`);
                        
                    })
                    .catch(error => { // ошибка при отправке фото на api
                     });
                })
                .catch(error => {
                    pError.classList.remove(`display-none`);
                    pError.textContent = 'Человек с таким именем уже зарегистрирован';
            });
            
        } else {
            pError.classList.remove(`display-none`);
            pError.textContent = `Заполните все поля`;
        }
    }

    async function addNewMachineGroup() {
        const inputNameGroup = document.querySelector('#inputNameNewTypeMachine');
        const pError = document.querySelector('#pErrorTypeMachineAdd');

        if (inputNameGroup.value.length > 3) {
            const path = `machines/${transliterate(inputNameGroup.value)}`;
            const obj = {
                name: inputNameGroup.value
            };

            try {
                await writeToFirebase(path, obj);
                inputNameGroup.value = '';
                pError.classList.add('display-none');
            } catch (e) {
                pError.classList.remove('display-none');
                pError.textContent = 'Группа станков с таким именем уже существует';
            }
        } else {
            pError.classList.remove('display-none');
            pError.textContent = 'Введите название для новой группы станков';
        }
    }

    async function addNewMachine(){
        const inputNameNewMachine = document.querySelector('#inputNameNewMachine');
        const selectTypesMachinesForAddMachine = document.querySelector('#selectTypesMachinesForAddMachine');
        const pError = document.querySelector(`#pErrorAddNewMachine`);

        if(inputNameNewMachine.value.length > 3 && selectTypesMachinesForAddMachine.value != ''){
            const path = `machines/${selectTypesMachinesForAddMachine.value}/machines/${transliterate(inputNameNewMachine.value)}`;
            
            const obj = {
                name: inputNameNewMachine.value,
                systemName: transliterate(inputNameNewMachine.value),
                status: 'Выключен',
                detail: '-',
                install: '-',
                operator: '-',
                naladchik: '-',
                startTime: '-',
                timeDetail: '-',
                timeChangeDetail: '-',
                dateNaladki: '-',
                detailSystemName: '-',
                nameUp: '-',
                nameDraw: '-',
                typeMachine: selectTypesMachinesForAddMachine.value
            }

            try{
                await writeToFirebase(path, obj);
                inputNameNewMachine.value = '';
                pError.classList.add('display-none');
            } catch(e){
                pError.classList.remove('display-none');
                pError.textContent = 'Станок с таким названием уже есть';
            }

        } else {
            pError.classList.remove('display-none');
            pError.textContent = 'Заполните все поля';
        }
    }

    async function addNewDetail() {
        const inputNameNewDetail = document.querySelector(`#inputNameNewDetail`);
        const inputNameDrawNewDetail = document.querySelector(`#inputNameDrawNewDetail`);
        const pError = document.querySelector(`#pErrorAddNewDetail`);

        const name = inputNameNewDetail.value.trim();
        const nameDraw = inputNameDrawNewDetail.value.trim();

        // Сброс цвета основного ввода
        inputNameNewDetail.style.borderColor = '';
        inputNameDrawNewDetail.style.borderColor = '';
        pError.classList.add('display-none');

        // Проверка имени детали и чертежа
        if (name.length <= 1 || nameDraw.length === 0) {
            pError.classList.remove('display-none');
            pError.textContent = 'Заполните все поля';
            if (name.length <= 1) inputNameNewDetail.style.borderColor = 'red';
            if (nameDraw.length === 0) inputNameDrawNewDetail.style.borderColor = 'red';
            return;
        }

        // Формируем объект после всех валидаций
        const systemName = `${transliterate(name)}_${transliterate(nameDraw)}`;
        const objNewDetail = {
            name: name,
            nameDraw: nameDraw,
            systemName: systemName,
            countInstalls: 0,
        };

        try{
            openAllertDownload();
            await asyncWriteToFirebase(`details/${systemName}`, objNewDetail);
            const countDetails = await asyncReadToFirebase(`detailsCount`);
            if(countDetails){
                await asyncOverwriteToFirebase(`detailsCount`, countDetails+1);
            } else {
                await asyncOverwriteToFirebase(`detailsCount`, 1);
            }

            inputNameNewDetail.value = '';
            inputNameDrawNewDetail.value = '';
            closeAllertDownload();
            if(selectedPanel == 'storage'){
                printPanelStorage();
            } else if(selectedPanel == 'details'){
                printDetailsPanel();
            }
        } catch (e) {
            pError.classList.remove('display-none');
            pError.textContent = 'Деталь с таким именем и названием чертежа уже есть';
            inputNameDrawNewDetail.style.borderColor = 'red';
            inputNameNewDetail.style.borderColor = 'red';
        }
    }

    function closeAllAllerts(){
        const listAllerts = ['bg-allert', `allertCalculateSalary`,  `allertConfirmDelete`, `allertStatWorkersTwoWeen`, `allertReductDetail`,
        `allertReductInformationWorker`, `allertMountPanelForDetailInformation`, `allertDetailInformationChart`];

        Object.values(listAllerts).forEach(allert => {
            document.querySelector(`#${allert}`).classList.add('display-none');
        })
    }

    function searchWorkerInTable(){
        const inputSearchFioWorker = document.querySelector(`#inputSearchFioWorker`);
        const searchText = inputSearchFioWorker.value.toLowerCase();
        const trs = document.querySelectorAll(`#tb-workers-table tr`);

        trs.forEach(tr => {
            const fioWorker = tr.querySelector('td').textContent.toLowerCase();

            if(fioWorker.includes(searchText)) {
                tr.style.display = '';
            } else {
                tr.style.display = 'none';
            }
        });
    }
    
    function searchWorkerInTableTwoWeekStat() {
        const inputSearchFioWorker = document.querySelector('#inputSearchWorkerInStatTwoWeek');
        const searchText = inputSearchFioWorker.value.toLowerCase();
        const trs = document.querySelectorAll('#tbodyTableStatWorkersTwoWeek tr');

        // Сначала скрываем все строки
        trs.forEach(tr => {
            tr.style.display = 'none';
        });

        // Затем ищем совпадения и показываем нужные строки + следующие за ними
        trs.forEach((tr, index) => {
            const fioWorker = tr.querySelector('td')?.textContent.toLowerCase() || '';

            if (fioWorker.includes(searchText)) {
                tr.style.display = '';
                const nextTr = trs[index + 1];
                if (nextTr) {
                    nextTr.style.display = '';
                }
            }
        });
    }

    function openAllertCalculateSalary(countSeconds, countDays, selector, selectedWorkerSystemName, startRange, endRange){
        countSecondsTimeForCalculateSalary = countSeconds;
        countDaysForCalculateSalary = countDays;
        selectorLastAllert = selector;
        closeAllAllerts();
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        document.querySelector(`#allertCalculateSalary`).classList.remove('display-none');
        document.querySelector(`#spanCountHoursForAllertSalary`).textContent = secondsToTimeFormat(countSeconds);
        document.querySelector(`#buttonPayedSalaryWorker`).onclick = function () {
            clickPaySalaryWorker(selectedWorkerSystemName, startRange, endRange);
        };

        calculateSumSalary();
    }

    function closeAllertCalculatesalary(){
        document.querySelector(`#allertCalculateSalary`).classList.add('display-none');
        document.querySelector(`#${selectorLastAllert}`).classList.remove('display-none');
    }

    function calculateSumSalary(){
        const minusTimeObed = document.querySelector(`#checkboxMinusTimeObed`).checked;
        const minusTimePereodevachka = document.querySelector(`#checkboxMinusTimePereodevachka`).checked;
        let countHours = 0;
        countHours = Math.round(countSecondsTimeForCalculateSalary / 3600);
        if(minusTimeObed){
            countHours = countHours - (1800 * countDaysForCalculateSalary) / 3600
        }
        if(minusTimePereodevachka){
            countHours = countHours - (1800 * countDaysForCalculateSalary) / 3600
        }
        document.querySelector(`#spanCountHoursForCalculateSalary`).textContent = countHours;
        const res = document.querySelector(`#inputSumHoursForCalculateSalary`).value * countHours;
        document.querySelector(`#spanResSumSalary`).textContent = `${res} грн`;
    }

    function clickDeleteWorker(worker){
        overwriteToFirebase(`workers/${worker}`, {});
        overwriteToFirebase(`logs/workers/${worker}`, {});
        fetch(`${apiLink}/delete_image`, {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain'
            },
            body: worker.trim()
        })
        .then()
        .catch();
    }

    function clickDeleteMachine(type, name){
        overwriteToFirebase(`machines/${type}/machines/${name}`, {});
        overwriteToFirebase(`logs/machines/${type}/machines/${name}`, {});
    }

    async function clickDeleteDetail(systemName){
        openAllertDownload();

        await asyncOverwriteToFirebase(`details/${systemName}`, {});
        await asyncOverwriteToFirebase(`logs/details/${systemName}`, {});
        const countDetails = await asyncReadToFirebase(`detailsCount`);
        await asyncOverwriteToFirebase(`detailsCount`, countDetails-1);

        closeAllertDownload();
        selectPanel('details-panel');
    }

    function openAllertConfirmDelete(typeOperation, name, type, event){
        event.stopPropagation();
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        document.querySelector(`#allertConfirmDelete`).classList.remove('display-none');

        typeOperationForDelete = typeOperation;
        nameForDelete = name;
        typeFordelete = type;
    }

    function clickConfirmAllertDelete(){
        closeAllAllerts();

        if(typeOperationForDelete == `worker`){
            clickDeleteWorker(nameForDelete);
        } else if(typeOperationForDelete == `machine`){
            clickDeleteMachine(typeFordelete, nameForDelete);
        } else if(typeOperationForDelete == `detail`){
            clickDeleteDetail(nameForDelete);
        }
    }

    async function printStatWorkersTwoWeek(){
        openAllertDownload();
        const startRange = getPastSaturday(currentStatDate);
        const endRange = getNextFriday(currentStatDate);
        const daysInRangeDates = getDaysInRangeForStatsTwoWeek(startRange, endRange);
        
        document.querySelector(`#allertStatWorkersTwoWeen`).classList.add('display-none');
        const tbodyTableStatWorkersTwoWeek = document.querySelector(`#tbodyTableStatWorkersTwoWeek`);
        const tHeadTableStatWorkersTwoWeek = document.querySelector(`#tHeadTableStatWorkersTwoWeek`);
        tHeadTableStatWorkersTwoWeek.innerHTML = `
            <tr>
                <th>ФИО</th>
                <th>Сб</th>
                <th>Вс</th>
                <th>Пн</th>
                <th>Вт</th>
                <th>Ср</th>
                <th>Чт</th>
                <th>Пт</th>
                <th>Всего часов</th>
            </tr>`;
        const thsHead = Array.from(tHeadTableStatWorkersTwoWeek.querySelectorAll("th"));
        await printHeadTable();
        await printBodyTable();
        document.querySelector(`#allertStatWorkersTwoWeen`).classList.remove('display-none');
        document.querySelector(`#bg-allert`).classList.remove('display-none');
        document.querySelector(`#h2DateRangeStatTwoWeekWorkers`).textContent = `${getNumberAndMountForDateNow(startRange)} - ${getNumberAndMountForDateNow(endRange)}`;
        closeAllertDownload();

        async function printHeadTable() {
            for (const dayInRange of Object.values(daysInRangeDates)) {
                const targetTh = thsHead.find(th => th.textContent.trim().toLowerCase().slice(0, 2) === dayInRange.dayName.toLowerCase());
                targetTh.innerHTML += `<br/>${getNumberAndMountForDateNow(dayInRange.dayStart)}`;
            }
        }

        async function printBodyTable() {
            tbodyTableStatWorkersTwoWeek.innerHTML = '';
            await new Promise((resolve) => {
                readToFirebase('workers', async (workers) => {
                    // const sortedWorkers = Object.entries(workers).sort(([, a], [, b]) => {
                    //     return a.fio.localeCompare(b.fio);
                    // });
                    const sortedWorkers = Object.entries(workers).sort(([, a], [, b]) => {
                        const isAGuard = a.role === 'okhrana';
                        const isBGuard = b.role === 'okhrana';

                        if (isAGuard && !isBGuard) return 1;
                        if (!isAGuard && isBGuard) return -1;

                        return a.fio.localeCompare(b.fio);
                    });


                    for (const [key, worker] of sortedWorkers) {
                        await new Promise((resolveWorker) => {
                            //readFirebaseByKeyRange('logs/workers/' + key + '/logs', startRange, endRange, (logs) => {
                            readFirebaseByKeyRange('logs/workers/' + key + '/logs', daysInRangeDates[0].dayStart, daysInRangeDates[13].dayEnd, (logs) => {
                                const workerFio = worker.fio;
                                let totalTimeMilliseconds = 0;
                                let countWorkDays = 0;
                                let noPayedDays = 0;
                                if (!logs) {
                                    resolveWorker();
                                    return;
                                }
                                tbodyTableStatWorkersTwoWeek.innerHTML += `
                                    <tr id="tr-first-${key}">
                                        <td rowspan="2">${formatName(workerFio)}<br/><button onclick="openAllertChartDetailInformation('worker', 'period', '${key}', '${daysInRangeDates[0].dayStart}', '${daysInRangeDates[13].dayEnd}')">Статистика</button></td>
                                        <td id="td-${key}-${daysInRangeDates[0].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[1].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[2].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[3].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[4].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[5].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[6].number}">-<br>-</td>
                                        <td id="td-${key}-totalTime" rowspan="2">-</td>
                                    </tr>
                                    <tr id="tr-two-${key}">
                                        <td id="td-${key}-${daysInRangeDates[7].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[8].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[9].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[10].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[11].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[12].number}">-<br>-</td>
                                        <td id="td-${key}-${daysInRangeDates[13].number}">-<br>-</td>
                                    </tr>
                                `; 
                                Object.values(logs).forEach(log => {
                                    if (log.typeLog == "Конец рабочего дня") {
                                        if (getDayOfMonth(log.startWorkDay) == getDayOfMonth(log.endWorkDay)) {
                                            if(document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML != '-<br>-'){
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML += `<br><br>${getHoursAndMinutesInDateNow(log.startWorkDay)}<br>${getHoursAndMinutesInDateNow(log.endWorkDay)}`;
                                            } else {
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML = `${getHoursAndMinutesInDateNow(log.startWorkDay)}<br>${getHoursAndMinutesInDateNow(log.endWorkDay)}`;
                                            }
                                            
                                            if(log?.statusPayed == true){
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).classList.add('green-allocation');
                                            } else {
                                                noPayedDays++;
                                            }
                                            
                                        } else {
                                            if(document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML != '-<br>-'){
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML = `<br><br>${getHoursAndMinutesInDateNow(log.startWorkDay)}<br>->`;
                                            } else {
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).innerHTML = `${getHoursAndMinutesInDateNow(log.startWorkDay)}<br>->`;
                                            }
                                            if(log?.statusPayed == true){
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.startWorkDay)}`).classList.add('green-allocation');
                                            } else {
                                                noPayedDays++;
                                            }

                                            if(document.querySelector(`#td-${key}-${getDayOfMonth(log.endWorkDay)}`).innerHTML != '-<br>-'){
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.endWorkDay)}`).innerHTML = `<br><br><- <br>${getHoursAndMinutesInDateNow(log.endWorkDay)}`;
                                            } else {
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.endWorkDay)}`).innerHTML = `<- <br>${getHoursAndMinutesInDateNow(log.endWorkDay)}`;
                                            }
                                            if(log?.statusPayed == true){
                                                document.querySelector(`#td-${key}-${getDayOfMonth(log.endWorkDay)}`).classList.add('green-allocation');
                                            }
                                            
                                        }

                                        totalTimeMilliseconds += Number(log.endWorkDay - log.startWorkDay);
                                        countWorkDays++;
                                    }
                                });
                                // отрисовка сегодняшнего дня
                                try{
                                    const today = new Date();
                                    const dayOfMonth = today.getDate();
                                    const timestampToday = today.getTime();
                                    if(document.querySelector(`#td-${key}-${dayOfMonth}`).innerHTML == `-<br>-` && timestampToday > startRange && timestampToday < daysInRangeDates[13].dayEnd){
                                        if(worker.dateActualyWorkDay != ''){
                                            document.querySelector(`#td-${key}-${dayOfMonth}`).classList.add(`yellow-allocation`);
                                            document.querySelector(`#td-${key}-${dayOfMonth}`).innerHTML = `${getHoursAndMinutesInDateNow(worker.dateActualyWorkDay).trim()}`;
                                        }
                                    }
                                } catch(error){
                                    console.log(error);
                                }
                                
                                document.querySelector(`#td-${key}-totalTime`).innerHTML = `${secondsToTimeFormat(totalTimeMilliseconds / 1000)} </br> ${countWorkDays} смен</br> 
                                <button onClick="openAllertCalculateSalary(${totalTimeMilliseconds / 1000}, ${countWorkDays}, 'allertStatWorkersTwoWeen', 
                                '${key}', ${startRange}, ${endRange})">Зарплата</button></br>
                                `;

                                if(noPayedDays == 0){
                                    document.querySelector(`#tr-first-${key}`).classList.add('green-allocation');
                                    document.querySelector(`#tr-two-${key}`).classList.add('green-allocation');
                                }
                                resolveWorker();
                            });
                        });
                    }
                    resolve();
                });
            });
        }

    }

    function openAllertDownload() {
        document.querySelector(`#bgDownloadSpinner`).classList.remove(`display-none`);
        document.querySelector(`#downloadSpinner`).classList.remove(`display-none`);
        
        // Устанавливаем время начала загрузки
        downloadStartTime = Date.now();
        
        // Настроим таймер для проверки, если прошло 20 секунд
        downloadTimer = setTimeout(() => {
            const elapsedTime = Date.now() - downloadStartTime;
            if (elapsedTime >= 20000) {
                // Если прошло 20 секунд или больше, перезагружаем страницу
                console.log("Загрузка заняла слишком много времени. Перезагружаем страницу.");
                location.reload(); // Перезагружаем страницу
            }
        }, 20000); // 20 секунд
    }

    function closeAllertDownload() {
        document.querySelector(`#bgDownloadSpinner`).classList.add(`display-none`);
        document.querySelector(`#downloadSpinner`).classList.add(`display-none`);
        
        // Проверяем, если был таймер, то очищаем его, так как загрузка завершена до 10 секунд
        if (downloadTimer !== null) {
            clearTimeout(downloadTimer);
            downloadTimer = null; // Очищаем переменную таймера
        }
        
        // Сбросим переменную времени, так как загрузка завершена
        downloadStartTime = null;
    }

    function addNewRole(){ 
        const inputRoleName = document.querySelector(`#inputNameNewRole`);
        const roleName = inputRoleName.value.trim();
        const pErrorAddNewRole = document.querySelector(`#pErrorAddNewRole`);

        const cbWorkInMachine = document.querySelector(`#cbWorkInMachine`);
        const cbSetupMachine = document.querySelector(`#cbSetupMachine`);
        const cbDetailsMenu = document.querySelector(`#cbDetailsMenu`);
        const cbCheckCountDetails = document.querySelector(`#cbCheckCountDetails`);
        const cbStorageDetails = document.querySelector(`#cbStorageDetails`);
        
        if(roleName.length > 2){
            readToFirebase(`roles/${transliterate(roleName.toLowerCase())}`, role => {
                if(!role){
                    pErrorAddNewRole.classList.add(`display-none`);
                    let objNewRole = {
                        name: `${roleName}`,
                    };

                    objNewRole.workInMachine = cbWorkInMachine.checked;
                    objNewRole.setupMachine = cbSetupMachine.checked;
                    objNewRole.addDetails = cbDetailsMenu.checked;
                    objNewRole.checkCountDetails = cbCheckCountDetails.checked;
                    objNewRole.storageDetails = cbStorageDetails.checked;

                    writeToFirebase(`roles/${transliterate(roleName.toLowerCase())}`, objNewRole);
                    inputRoleName.value = '';
                } else {
                    pErrorAddNewRole.classList.remove('display-none');
                    pErrorAddNewRole.textContent = `Должность с таким именем уже существует`;

                }
            });
        } else {
            pErrorAddNewRole.classList.remove('display-none');
            pErrorAddNewRole.textContent = `Название должно быть минимум 3 символа`;
        }
    }

    function reductInfoWorker(event, workerSystemName){
        event.stopPropagation();
        const inputActualRoleForReductInformationWorker = document.querySelector(`#inputActualRoleForReductInformationWorker`);
        const selectListRolesForReductInformationWorker = document.querySelector(`#selectListRolesForReductInformationWorker`);
        const pErrorNewRoleForReductInformationWorker = document.querySelector(`#pErrorNewRoleForReductInformationWorker`);
        const inputNewFioForReductInformationWorker = document.querySelector(`#inputNewFioForReductInformationWorker`);
        const pErrorNewFioForReductIntormationWorker = document.querySelector(`#pErrorNewFioForReductIntormationWorker`);
        const buttonChangeRoleForReductInformationWorker = document.querySelector(`#buttonChangeRoleForReductInformationWorker`);
        const buttonChangeFioForReductInformationWorker = document.querySelector(`#buttonChangeFioForReductInformationWorker`);

        pErrorNewRoleForReductInformationWorker.classList.add(`display-none`);
        pErrorNewFioForReductIntormationWorker.classList.add(`display-none`);
        inputNewFioForReductInformationWorker.value = '';

        readToFirebase(`workers/${workerSystemName}`, worker => {
            document.querySelector(`#h2TitleFioWorkerForReductInformation`).textContent = `Редактирование информации для ${worker.fio}`;

            document.querySelector(`#allertReductInformationWorker`).classList.remove(`display-none`);
            document.querySelector(`#bg-allert`).classList.remove(`display-none`);


            readToFirebase(`roles`, roles => {
                selectListRolesForReductInformationWorker.innerHTML = `<option value="">Выберите новую должность</option>`;
                Object.entries(roles).forEach(([key, role]) => {
                    selectListRolesForReductInformationWorker.innerHTML += `<option value="${key}">${role.name}</option>`;
                });
                inputActualRoleForReductInformationWorker.value = roles[worker.role].name;
            });

            buttonChangeRoleForReductInformationWorker.onclick = function(){
                clickReductRoleForWorker(worker.role, selectListRolesForReductInformationWorker.value, workerSystemName);
            };

            buttonChangeFioForReductInformationWorker.onclick = function() {
                clickReductFioForWorker(workerSystemName, inputNewFioForReductInformationWorker.value);
            };
        });
    }

    function clickReductRoleForWorker(oldRole, newRole, workerSystemName){
        const pErrorNewRoleForReductInformationWorker = document.querySelector(`#pErrorNewRoleForReductInformationWorker`);

        if(!newRole){
            pErrorNewRoleForReductInformationWorker.textContent = 'Выберите новую должность';
            pErrorNewRoleForReductInformationWorker.classList.remove('display-none');
            return;
        }

        if(oldRole == newRole){
            pErrorNewRoleForReductInformationWorker.textContent = 'Данная должность уже установлена';
            pErrorNewRoleForReductInformationWorker.classList.remove('display-none');
            return;
        }

        pErrorNewRoleForReductInformationWorker.classList.add(`display-none`);

        overwriteToFirebase(`workers/${workerSystemName}/role`, newRole);
        document.querySelector(`#allertReductInformationWorker`).classList.add(`display-none`);
        document.querySelector(`#bg-allert`).classList.add(`display-none`);
    }

    function clickReductFioForWorker(oldSystemFio, newFio){
        const newSystemFio = transliterate(newFio);

        const pErrorNewFioForReductIntormationWorker = document.querySelector(`#pErrorNewFioForReductIntormationWorker`);
        pErrorNewFioForReductIntormationWorker.classList.add(`display-none`);

        if(newFio.length < 4){
            pErrorNewFioForReductIntormationWorker.classList.remove(`display-none`);
            pErrorNewFioForReductIntormationWorker.textContent = 'ФИО должно состоять минимум из пяти букв';
            return;
        }
        
        if(newFio.trim().split(/\s+/).length !== 3){
            pErrorNewFioForReductIntormationWorker.classList.remove(`display-none`);
            pErrorNewFioForReductIntormationWorker.textContent = 'ФИО должно состоять минимум из трех слов';
            return;
        }

        readToFirebase(`workers/${newSystemFio}`, protectWorker => {
            if(protectWorker){
                pErrorNewFioForReductIntormationWorker.classList.remove(`display-none`);
                pErrorNewFioForReductIntormationWorker.textContent = 'Человек с таким именем уже есть';
            } else {
                readToFirebase(`workers/${oldSystemFio}`, workerOldFio => {
                    if (!workerOldFio) {
                        // Если данных нет, показываем ошибку
                        pErrorNewFioForReductIntormationWorker.classList.remove(`display-none`);
                        pErrorNewFioForReductIntormationWorker.textContent = 'Работник с таким ФИО не найден';
                        return; // Прерываем выполнение
                    }
                    let objNewFioWorker = workerOldFio;
                    objNewFioWorker.fio = newFio;
                    writeToFirebase(`workers/${newSystemFio}`, objNewFioWorker);
                    overwriteToFirebase(`workers/${oldSystemFio}`, {});
                    readToFirebase(`logs/workers/${oldSystemFio}/logs`, oldLogs => {
                        const logs = oldLogs;
                        writeToFirebase(`logs/workers/${newSystemFio}/logs`, logs);
                        overwriteToFirebase(`logs/workers/${oldSystemFio}/logs`, {});
                    })
                    const payload = {
                        oldName: oldSystemFio,
                        newName: newSystemFio
                    };

                    console.log("Отправка данных: ", payload);

                    fetch(`${apiLink}/rename_image`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log("Ответ от API: ", data);
                    })
                    .catch(error => {
                        console.error("Ошибка отправки запроса: ", error);
                    });
                });

                document.querySelector(`#allertReductInformationWorker`).classList.add(`display-none`);
                document.querySelector(`#bg-allert`).classList.add(`display-none`);
            }
        });

    }

    async function openAllertMounthPanelForDetailInformation(type, systemName, timeStamp) {
        openAllertDownload();
        document.querySelector(`#allertMountPanelForDetailInformation`).classList.add('display-none');

        const h2TitleNameMountPanelForDetailInformation = document.querySelector(`#h2TitleNameMountPanelForDetailInformation`);
        const containerDatesCalendar = document.querySelector(`#containerDatesCalendar`);
        
        document.querySelector(`#buttonPreviousMountPanel`).onclick = function(){
            openAllertMounthPanelForDetailInformation(type, systemName, getPreviousMonth(Number(timeStamp)));
        }
        document.querySelector(`#buttonNextMountPanel`).onclick = function(){
            openAllertMounthPanelForDetailInformation(type, systemName, getNextMonth(Number(timeStamp)));
        }
        containerDatesCalendar.innerHTML = '';

        const objThisMount = getMonthInfo(Number(timeStamp));
        const { startOfMonth, endOfMonth, mounthNameUa, mounthNameRu, year } = objThisMount;

        document.querySelector(`#buttonDetailInformationChartMounth`).onclick = function(){
            openAllertChartDetailInformation('worker', 'period', systemName, startOfMonth, endOfMonth);
        }

        document.querySelector(`#h3YearMountPanelForDetailInformation`).textContent = year;
        document.querySelector(`#h3MountNameUkrMountPanelForDetailInformation`).textContent = mounthNameUa;
        document.querySelector(`#h3MountNameRusMountPanelForDetailInformation`).textContent = mounthNameRu;

        const arrayDaysThisMonth = getDaysInRange(startOfMonth, endOfMonth);
        const firstDayOfMonth = new Date(startOfMonth).getDay();

        // Пустые ячейки перед первым днём месяца
        let normalizedFirstDay = firstDayOfMonth === 0 ? 7 : firstDayOfMonth;

        for (let i = 1; i < normalizedFirstDay; i++) {
            containerDatesCalendar.innerHTML += `
                <div><div class="container"></div></div>
            `;
        }


        if (type === 'worker') {
            try {
                const worker = await new Promise(resolve => readToFirebase(`workers/${systemName}`, resolve));
                h2TitleNameMountPanelForDetailInformation.textContent = worker.fio;

                const logs = await new Promise((resolve, reject) => {
                    readFirebaseByKeyRange(`logs/workers/${systemName}/logs`, startOfMonth, endOfMonth, data => {
                        data ? resolve(data) : reject('Не удалось получить логи за месяц');
                    });
                });

                for (const day of arrayDaysThisMonth) {
                    const logsThisDay = filterAndSortByKeyRange(day.startDateMs, day.endDateMs, logs);

                    let timerDay = '';
                    let arrayCoefficients = [];
                    let startWorkDay = 0;
                    let endWorkDay = 0;

                    try {
                        for (const log of Object.values(logsThisDay)) {
                            if (log.typeLog === "Конец рабочего дня") {
                                timerDay = getTimeDifference(log.endWorkDay, log.startWorkDay);
                                startWorkDay = log.startWorkDay;
                                endWorkDay = log.endWorkDay;
                            } else if (log.typeLog === "Производство") {
                                const machineTime = Number(log.countDetails) * (
                                    minSecToSeconds(log.timeDetail) + minSecToSeconds(log.timeChangeDetail)
                                );
                                const timer = (Number(log.endTime) - Number(log.startTime)) / 1000;
                                const res = machineTime / timer;
                                arrayCoefficients.push(res);
                            }
                        }
                    } catch (error) {
                        console.warn('Ошибка при разборе логов дня', error);
                    }

                    const averageCoefficient = arrayCoefficients.length
                        ? parseFloat((arrayCoefficients.reduce((a, b) => a + b, 0) / arrayCoefficients.length).toFixed(2))
                        : 0;

                    containerDatesCalendar.innerHTML += `
                        <div onclick="openAllertChartDetailInformation('worker', 'day', '${systemName}', '${day.startDateMs}', '${day.endDateMs}')"
                            style="background-color: ${getColorForCoefficient(averageCoefficient)}" class="item">
                            <div class="container">
                                <h3>${day.day}</h3>
                                <p>${timerDay}</p>
                                <p>${arrayCoefficients.length ? Math.round(averageCoefficient * 100) + '%' : ''}</p>
                            </div>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Ошибка при загрузке данных:', error);
            }
        }

        document.querySelector(`#bg-allert`).classList.remove('display-none');
        document.querySelector(`#allertMountPanelForDetailInformation`).classList.remove('display-none');
        closeAllertDownload();
    }

    function printChartToDetailInformation(data, typeChart, nameChart) {
        const container = document.querySelector('#containerChartForAllertDetailInformation');
        container.innerHTML = ''; // очищаем содержимое

        if (echarts.getInstanceByDom(container)) {
            echarts.dispose(container); // Удаляем старую инициализацию
        }

        const chart = echarts.init(container); // используем сам контейнер

        if (typeChart === 'pie') {
            const option = {
                title: {
                    text: nameChart,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        return `${params.data.description || ''}`;
                    }
                },
                legend: {
                    show: false
                },
                series: [
                    {
                        name: nameChart,
                        type: 'pie',
                        radius: '70%',
                        data: data,
                        label: {
                            show: true,
                            position: 'inside',
                            color: '#fff',
                            fontWeight: 600,
                            formatter: function (params) {
                                return params.data.title || params.name;
                            }
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowOffsetX: 0,
                                shadowColor: 'rgba(0, 0, 0, 0.5)'
                            }
                        }
                    }
                ]
            };

            chart.setOption(option);
            }  else if (typeChart === 'diagram') {
            const categories = data.map(item => item.name);
            const values = data.map(item => item.value);

            const option = {
                title: {
                    text: nameChart,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const index = params[0].dataIndex;
                        return data[index].description || `${params[0].name}: ${params[0].value}`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        data: values,
                        type: 'bar',
                        label: {
                            show: true,
                            position: 'top',
                            formatter: function (params) {
                                return data[params.dataIndex].title || params.name;
                            }
                        },
                        itemStyle: {
                            color: '#73C0DE'
                        },
                        emphasis: {
                            focus: 'series'
                        }
                    }
                ]
            };

            chart.setOption(option);
        } else if (typeChart === 'line') {
            // Преобразуем данные для line-графика с заливкой под линией
            const categories = data.map(item => item.name); // X-ось — названия станков
            const values = data.map(item => item.value); // Y-ось — значения

            const option = {
                title: {
                    text: nameChart,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    formatter: function (params) {
                        const index = params[0].dataIndex;
                        return data[index].description || `${params[0].name}: ${params[0].value}`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: categories,
                    axisLabel: {
                        rotate: 45
                    }
                },
                yAxis: {
                    type: 'value'
                },
                series: [
                    {
                        data: values,
                        type: 'line',
                        smooth: true,
                        areaStyle: {}, // Включаем заливку под линией
                        label: {
                            show: true,
                            position: 'top',
                            formatter: function (params) {
                                return data[params.dataIndex].title || params.name;
                            }
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        itemStyle: {
                            color: '#5470C6' // Цвет линии и заливки (по умолчанию)
                        }
                    }
                ]
            };

            chart.setOption(option);
        } else {
            container.innerHTML = `<p>Тип графика "${typeChart}" не поддерживается.</p>`;
        }
    }

    function changeTypeDataInDetailInformationChart(type){
        const buttons = document.querySelectorAll(`#containerTypesDataInChart div`);

        actualTypeDataChart = type;

        Object.values(buttons).forEach(button => {
            button.classList.remove('select-type');
        });

        if(type == 'time'){
            document.querySelector(`#buttonChangeTypeChartToTime`).classList.add('select-type');
            printChartToDetailInformation(actualDataForChartTime, actualTypeChart, "Продолжитльность работы на станках");
        } else if(type == 'procent'){
            document.querySelector(`#buttonChangeTypeChartToProcent`).classList.add('select-type');
            printChartToDetailInformation(actualDataForChartProcent, actualTypeChart, "Процент продуктивности работы");
        } else if(type == 'details'){
            document.querySelector(`#buttonChangeTypeChartToDetails`).classList.add('select-type');
            printChartToDetailInformation(actualDataForChartCountDetails, actualTypeChart, "Количество деталей");
        }

    }

    function changeTypeChartInDetailInformationChart(type){
        const buttons = document.querySelectorAll(`#containerTypesChart div`);

        actualTypeChart = type;

        Object.values(buttons).forEach(button => {
            button.classList.remove('select-type');
        });

        if(type == 'pie'){
            document.querySelector(`#buttonChangeTypeChartToPie`).classList.add('select-type');
        } else if(type == 'diagram'){
            document.querySelector(`#buttonChangeTypeChartToDiagram`).classList.add('select-type');
        } else if(type == 'line'){
            document.querySelector(`#buttonChangeTypeChartToLine`).classList.add('select-type');
        }

        if(actualTypeDataChart == 'time'){
            printChartToDetailInformation(actualDataForChartTime, actualTypeChart, "Время работы");
        } else if(actualTypeDataChart == 'procent'){
            printChartToDetailInformation(actualDataForChartProcent, actualTypeChart, "Процент результативности");
        } else if(actualTypeDataChart == 'details'){
            printChartToDetailInformation(actualDataForChartCountDetails, actualTypeChart, "Количество деталей");
        }
    }

    function clickCloseAllertChart(){
        document.querySelector(`#allertDetailInformationChart`).classList.add('display-none');
    }
    
    function clickPaySalaryWorker(workerSystemName, startRange, endRange) {
        openAllertDownload();

        // Оборачиваем вызов чтения в Promise
        new Promise((resolve, reject) => {
            readFirebaseByKeyRange(
                `logs/workers/${workerSystemName}/logs`,
                startRange,
                endRange,
                (logs) => {
                    if (logs) resolve(logs);
                    else reject(new Error("Нет логов"));
                }
            );
        })
        .then(logs => {
            // Обрабатываем все нужные логи
            const updatePromises = Object.entries(logs).map(([key, log]) => {
                if (log.typeLog === 'Конец рабочего дня') {
                    return new Promise((resolve) => {
                        let newLog = { ...log, statusPayed: true };
                        overwriteToFirebase(`logs/workers/${workerSystemName}/logs/${key}`, newLog);
                        resolve(); // считаем, что запись успешна
                    });
                }
                return Promise.resolve(); // если не нужно обновлять
            });

            // Ждём, пока все записи завершатся
            return Promise.all(updatePromises);
        })
        .then(() => {
            // Всё успешно завершено
            document.querySelector(`#allertCalculateSalary`).classList.add('display-none');
            document.querySelector(`#allertStatWorkersTwoWeen`).classList.remove('display-none');
            document.querySelector(`#tr-first-${workerSystemName}`).classList.add('green-allocation');
            document.querySelector(`#tr-two-${workerSystemName}`).classList.add('green-allocation');
        })
        .catch(err => {
            console.error('Ошибка при выплате зарплаты:', err);
        })
        .finally(() => {
            closeAllertDownload();
        });
    }

    async function openAllertChartDetailInformation(type, typeRange, systemName, startRange, endRange) {
        openAllertDownload();
        actualDataForChartTime = [];
        actualDataForChartProcent = [];
        actualDataForChartCountDetails = [];

        if (type === 'worker') {
            try {
                const logsThisRange = await new Promise((resolve, reject) => {
                    readFirebaseByKeyRange(`logs/workers/${systemName}/logs`, startRange, endRange, data => {
                        if (data) resolve(data);
                        else reject('Данные не получены или пусты');
                    });
                });

                let objAllDetails = {};
                let objSetupMachines = {};

                if (typeRange === 'day') {
                    let startWorkDay = 0;
                    let endWorkDay = 0;

                    for (const log of Object.values(logsThisRange)) {
                        if (log.typeLog === 'Производство') {
                            const timeValue = log.endTime - log.startTime;
                            const machineName = log.machine;
                            const timeOnMachine = getTimeDifference(log.startTime, log.endTime);
                            const timeDetailSecs = minSecToSeconds(log.timeDetail);
                            const timeChangeDetailSecs = minSecToSeconds(log.timeChangeDetail);
                            const totalWorkSecs = (timeDetailSecs + timeChangeDetailSecs) * log.countDetails;
                            const normDetails = Math.round((timeValue / 1000) / (timeDetailSecs + timeChangeDetailSecs));
                            const procent = Math.round((Number(log.countDetails) / normDetails) * 100);
                            const commonDesc = `
                                Станок: ${machineName}</br>
                                Деталь: ${log.detail} (${log.install})</br>
                                Время детали: ${log.timeDetail}</br>
                                Время смены детали: ${log.timeChangeDetail}</br>
                                Время работы на станке: ${timeOnMachine}</br>
                                Время работы станка: ${secondsToTimeFormat(totalWorkSecs)}</br>
                                Сделано деталей: ${log.countDetails}</br>
                                Норма деталей: ${normDetails}</br>
                                Процент результативности: ${procent}%</br>
                                Начало работы на станке: ${formatDate(log.startTime)}</br>
                                Конец работы на станке: ${formatDate(log.endTime)}</br>
                                Наладчик: ${formatName(log.naladchik)}
                            `;

                            actualDataForChartTime.push({
                                value: timeValue,
                                name: machineName,
                                title: `${machineName} (${timeOnMachine})`,
                                description: commonDesc
                            });

                            actualDataForChartCountDetails.push({
                                value: log.countDetails,
                                name: machineName,
                                title: `${machineName}\n ${log.countDetails} шт.`,
                                description: commonDesc
                            });

                            actualDataForChartProcent.push({
                                value: timeValue,
                                name: machineName,
                                title: `${machineName}\n ${procent}%`,
                                description: commonDesc
                            });

                            if (!objAllDetails[log.detailSystemName]) {
                                objAllDetails[log.detailSystemName] = {
                                    detailName: `${log.detail} (${log.install})`,
                                    countDetails: 0
                                };
                            }
                            objAllDetails[log.detailSystemName].countDetails += Number(log.countDetails);

                        } else if (log.typeLog === 'Конец рабочего дня') {
                            startWorkDay = log.startWorkDay;
                            endWorkDay = log.endWorkDay;

                        } else if (log.typeLog === 'настройка станка') {
                            objSetupMachines[Object.keys(objSetupMachines).length] = log;
                        }
                    }

                    // Заполнение общей информации
                    const container = document.querySelector(`#containerGeneralInformationAllertChart`);
                    document.querySelector(`#h2TitleDateAllertDetailInformation`).textContent = formatedDate(Number(endRange));
                    container.innerHTML = `
                        <h3>Общая информация</h3>
                        <div class="container-info"><p>Начало рабочего дня:</p><span>${formatDate(startWorkDay)}</span></div>
                        <div class="container-info"><p>Конец рабочего дня:</p><span>${formatDate(endWorkDay)}</span></div>
                        <div class="container-info"><p>Продолжительность смены:</p><span>${getTimeDifference(startWorkDay, endWorkDay)}</span></div>
                        <div class="container-info"><p>Средний процент результативности:</p><span>-</span></div>
                    `;

                    if (Object.keys(objAllDetails).length > 0) {
                        container.innerHTML += `<h5>Изготовленные детали:</h5>`;
                        Object.values(objAllDetails).forEach(detail => {
                            container.innerHTML += `
                                <div class="container-info">
                                    <p>${detail.detailName}:</p>
                                    <span>${detail.countDetails} шт.</span>
                                </div>
                            `;
                        });
                    }

                    if (Object.keys(objSetupMachines).length > 0) {
                        container.innerHTML += `<h5>Настроенные станки:</h5>`;
                        for (const logSetup of Object.values(objSetupMachines)) {
                            const machine = await new Promise(resolve => {
                                readToFirebase(`${logSetup.machinePath}`, resolve);
                            });
                            container.innerHTML += `
                                <div class="container-info">
                                    <p>${machine.name}:</p>
                                    <span>${logSetup.detail} (${logSetup.install})</br>${logSetup.timeDetail} (${logSetup.timeChangeDetail})</span>
                                </div>`;
                        }
                    }

                } else if (typeRange === 'period') {
                    let arrayWorksDays = [];
                    let arrayCoefficientsThisPeriod = [];
                    let objDetailsInThisPeriod = {};

                    for (const log of Object.values(logsThisRange)) {
                        if (log.typeLog === 'Конец рабочего дня') {
                            const logsThisDay = filterAndSortByKeyRange(log.startWorkDay, log.endWorkDay, logsThisRange);
                            arrayWorksDays.push(Number(log.endWorkDay) - Number(log.startWorkDay));

                            let objDetailsInThisDay = {};
                            let arrayCoefficientsThisDay = [];

                            for (const logThisDay of Object.values(logsThisDay)) {
                                if (logThisDay.typeLog === 'Производство') {
                                    // Добавляем в данные за день
                                    if (!objDetailsInThisDay[`${logThisDay.detailSystemName}${logThisDay.install}`]) {
                                        objDetailsInThisDay[`${logThisDay.detailSystemName}${logThisDay.install}`] = {
                                            detailName: `${logThisDay.detail} (${logThisDay.install})`,
                                            countDetails: 0
                                        };
                                    }
                                    objDetailsInThisDay[`${logThisDay.detailSystemName}${logThisDay.install}`].countDetails += Number(logThisDay.countDetails);

                                    // Добавляем в данные за период
                                    if (!objDetailsInThisPeriod[`${logThisDay.detailSystemName}${logThisDay.install}`]) {
                                        objDetailsInThisPeriod[`${logThisDay.detailSystemName}${logThisDay.install}`] = {
                                            detailName: `${logThisDay.detail} (${logThisDay.install})`,
                                            countDetails: 0
                                        };
                                    }
                                    objDetailsInThisPeriod[`${logThisDay.detailSystemName}${logThisDay.install}`].countDetails += Number(logThisDay.countDetails);

                                    // Расчёт коэффициента производительности
                                    const machineTime = Number(logThisDay.countDetails) * (minSecToSeconds(logThisDay.timeDetail) + minSecToSeconds(logThisDay.timeChangeDetail));
                                    const timer = (Number(logThisDay.endTime) - Number(logThisDay.startTime)) / 1000;
                                    const res = (machineTime / timer) * 100;
                                    arrayCoefficientsThisDay.push(Number(res.toFixed(2)));
                                }
                            }

                            // Подготовка описания деталей
                            let descriptionDetails = '';
                            Object.values(objDetailsInThisDay).forEach(detail => {
                                descriptionDetails += `${detail.detailName}: ${detail.countDetails} шт.<br/>`;
                            });

                            const shiftTime = log.endWorkDay - log.startWorkDay;
                            const dateLabel = getNumberAndMountForDateNow(log.endWorkDay);
                            const shiftDuration = getTimeDifference(log.startWorkDay, log.endWorkDay);
                            const averageProcent = Math.round(calculateAverage(arrayCoefficientsThisDay));

                            actualDataForChartTime.push({
                                value: shiftTime,
                                name: `${dateLabel}\n(${shiftDuration})`,
                                title: `${dateLabel}\n(${shiftDuration})`,
                                description: `
                                    Начало смены: ${formatDate(log.startWorkDay)}</br>
                                    Конец смены: ${formatDate(log.endWorkDay)}</br>
                                    Продолжительность смены: ${shiftDuration}</br>
                                    Процент результативности: ${averageProcent}%</br>
                                    Изготовленные детали: </br>
                                    ${descriptionDetails}
                                `
                            });

                            let countAllsDetailInThisDay = Object.values(objDetailsInThisDay)
                                .reduce((sum, detail) => sum + detail.countDetails, 0);

                            actualDataForChartCountDetails.push({
                                value: countAllsDetailInThisDay,
                                name: `${dateLabel}\n(${countAllsDetailInThisDay} шт.)`,
                                title: `${dateLabel}\n(${countAllsDetailInThisDay} шт.)`,
                                description: `
                                    Начало смены: ${formatDate(log.startWorkDay)}</br>
                                    Конец смены: ${formatDate(log.endWorkDay)}</br>
                                    Продолжительность смены: ${shiftDuration}</br>
                                    Процент результативности: ${averageProcent}%</br>
                                    Изготовленные детали: </br>
                                    ${descriptionDetails}
                                `
                            });

                            actualDataForChartProcent.push({
                                value: countAllsDetailInThisDay,
                                name: `${dateLabel}\n(${averageProcent}%)`,
                                title: `${dateLabel}\n(${averageProcent}%)`,
                                description: `
                                    Начало смены: ${formatDate(log.startWorkDay)}</br>
                                    Конец смены: ${formatDate(log.endWorkDay)}</br>
                                    Продолжительность смены: ${shiftDuration}</br>
                                    Процент результативности: ${averageProcent}%</br>
                                    Изготовленные детали: </br>
                                    ${descriptionDetails}
                                `
                            });

                            arrayCoefficientsThisPeriod.push(averageProcent);
                        }
                    }

                    // Отрисовка общей информации
                    const container = document.querySelector(`#containerGeneralInformationAllertChart`);
                    document.querySelector(`#h2TitleDateAllertDetailInformation`).textContent =
                        `${formatedDate(Number(startRange))} - ${formatedDate(Number(endRange))}`;
                    
                    container.innerHTML = `
                        <h3>Общая информация</h3>
                        <div class="container-info"><p>Количество смен:</p><span>${arrayWorksDays.length}</span></div>
                        <div class="container-info"><p>Средняя продолжительность смены:</p><span>${secondsToTimeFormat(calculateAverage(arrayWorksDays) / 1000)}</span></div>
                        <div class="container-info"><p>Общее количество часов:</p><span>${secondsToTimeFormat(arrayWorksDays.reduce((sum, val) => sum + val, 0) / 1000)}</span></div>
                        <div class="container-info"><p>Средний процент успешности:</p><span>${Math.round(calculateAverage(arrayCoefficientsThisPeriod))}%</span></div>
                        <h5>Изготовленные детали:</h5>
                    `;

                    Object.values(objDetailsInThisPeriod).forEach(detail => {
                        container.innerHTML += `
                            <div class="container-info">
                                <p>${detail.detailName}:</p>
                                <span>${detail.countDetails} шт.</span>
                            </div>
                        `;
                    });
                }


            } catch (error) {
                console.error('Ошибка при чтении данных:', error);
                return;
            }

            // Получение информации о работнике
            const worker = await new Promise(resolve => {
                readToFirebase(`workers/${systemName}`, resolve);
            });
            document.querySelector(`#h2TitleNameAllertDetailInformation`).textContent = worker.fio;
        }

        // Отображение графика
        document.querySelector(`#allertDetailInformationChart`).classList.remove('display-none');

        actualTypeChart = 'line';
        actualTypeDataChart = 'time';
        printChartToDetailInformation(actualDataForChartTime, actualTypeChart, 'Время работы');

        changeTypeDataInDetailInformationChart(`time`);
        changeTypeChartInDetailInformationChart(`line`);
        closeAllertDownload();
    }
    
    async function clickSearchDetailsInDetailsPanel(){
        openAllertDownload();
        const inputSearch = document.querySelector(`#inputSearchDetailInTableDetailsPanel`);
        const searchText = transliterate(inputSearch.value.trim());
        if(searchText != ''){
            const details = await searchByKeyInFirebase(`details`, searchText);
            
            if(details){
                const bodyTable = document.querySelector(`#tb-details-table`);
                bodyTable.innerHTML = '';
                Object.entries(details).forEach(([key, detail]) => {
                    bodyTable.innerHTML += `
                        <tr style="cursor: pointer;" onclick="openAllertReductDetail('${key}')"> 
                            <td>${detail.name}</td>    
                            <td>${detail.nameDraw}</td>    
                            <td>${detail.countInstalls}</td>
                            <td style="text-align: center;"><i onclick="openAllertConfirmDelete('detail','${key}', '')" style="color: #ff4d4d; font-size: 18px; cursor: pointer;" class="fa-solid fa-trash"></i></td>  
                        </tr>
                    `;
                });
                document.querySelector(`#details-panel .navigation-menu-table button`).onclick = function() {};
                const countDetails = Object.keys(details).length;
                document.querySelector(`#details-panel .navigation-menu-table h5`).textContent = `Загружено ${countDetails} из ${countDetails}`;

            }
        }    
        closeAllertDownload();
    }
    
    


    // что делать завтра
    // добавить склад деталей в админку
    // добавить какую-то панельку заказы или что-то подобное
    // придумать какую-то вертикалькую менюшку, пока что нет идей как эту всю информацию вместить в вертикальный клиент
    // посмотреть курс по сео

    // проверить логи по табелю, у кого что не хватает добавить. За вторник добавить пацанам логи станков.
</script>
</body>
</html>
